(self.webpackChunk=self.webpackChunk||[]).push([[646],{30646:(e,t,s)=>{s.d(t,{GO:()=>u,HF:()=>m,Hd:()=>l,IS:()=>y,Ic:()=>j,MC:()=>_,Ng:()=>b,Q$:()=>i,RS:()=>g,Ro:()=>h,SP:()=>T,Wr:()=>o,_2:()=>w,_y:()=>ee,c3:()=>M,ik:()=>r,ml:()=>n,tL:()=>c,wR:()=>f,xe:()=>p});class n{implementation;static objectName="host.alerts";constructor(e){this.implementation=e}async handleMessage(e,t){const s="host.alerts.";switch(e.startsWith(s)&&(e=e.slice(s.length)),e){case"subscribeToAlertCollection":{const e=t??null;return await this.implementation.subscribeToAlertCollection(e)??null}case"unsubscribeToAlertCollection":{const e=t??null;return await this.implementation.unsubscribeToAlertCollection(e)??null}case"subscribeToSelectedAlert":{const e=t??null;return await this.implementation.subscribeToSelectedAlert(e)??null}case"unsubscribeToSelectedAlert":{const e=t??null;return await this.implementation.unsubscribeToSelectedAlert(e)??null}case"applyAlerts":{const e=t??null;return await this.implementation.applyAlerts(e)??null}case"removeAlerts":{const e=t??null;return await this.implementation.removeAlerts(e)??null}case"setAlertsVisibility":{const e=t??null;return await this.implementation.setAlertsVisibility(e)??null}case"updateAlertsVisibility":{const e=t??null;return await this.implementation.updateAlertsVisibility(e)??null}case"scrollAlertIntoView":{const e=t??null;return await this.implementation.scrollAlertIntoView(e)??null}case"getCardLayoutGroupCounts":{const e=t??null;return await this.implementation.getCardLayoutGroupCounts(e)??null}default:throw new Error(`Unknown action: ${e}`)}}}class i{_sendMessage;constructor(e){this._sendMessage=e}async alertCollectionChanged(e){return await this._sendMessage("applet.alerts.alertCollectionChanged",e)??null}async selectedAlertChanged(e){return await this._sendMessage("applet.alerts.selectedAlertChanged",e)??null}}class a{_sendMessage;constructor(e){this._sendMessage=e}async terminate(e){return await this._sendMessage("applet.lifecycle.terminate",e)??null}}class o{implementation;static objectName="host.authorizedHttpClient";constructor(e){this.implementation=e}async handleMessage(e,t){const s="host.authorizedHttpClient.";if(e.startsWith(s)&&(e=e.slice(s.length)),"sendRequest"===e){const e=t??null;return await this.implementation.sendRequest(e)??null}throw new Error(`Unknown action: ${e}`)}}class r{_sendMessage;constructor(e){this._sendMessage=e}async sendRequest(e){return await this._sendMessage("host.authorizedHttpClient.sendRequest",e)??null}}class l{implementation;static objectName="host.capiSocket";constructor(e){this.implementation=e}async handleMessage(e,t){const s="host.capiSocket.";switch(e.startsWith(s)&&(e=e.slice(s.length)),e){case"sendMessage":{const e=t??null;return await this.implementation.sendMessage(e)??null}case"subscribeToMessage":{const e=t??null;return await this.implementation.subscribeToMessage(e)??null}case"subscribeToMessages":{const e=t??null;return await this.implementation.subscribeToMessages(e)??null}case"unsanitizeText":{const e=t??null;return await this.implementation.unsanitizeText(e)??null}case"sanitizeText":{const e=t??null;return await this.implementation.sanitizeText(e)??null}default:throw new Error(`Unknown action: ${e}`)}}}class c{_sendMessage;constructor(e){this._sendMessage=e}async messageReceived(e){return await this._sendMessage("applet.capiSocket.messageReceived",e)??null}async disconnected(e){return await this._sendMessage("applet.capiSocket.disconnected",e)??null}async connected(e){return await this._sendMessage("applet.capiSocket.connected",e)??null}}class u{_sendMessage;constructor(e){this._sendMessage=e}async start(e){return await this._sendMessage("applet.cheetah.start",e)??null}}class h{implementation;static objectName="host.cheetah";constructor(e){this.implementation=e}async handleMessage(e,t){const s="host.cheetah.";if(e.startsWith(s)&&(e=e.slice(s.length)),"setSelectionContext"===e){const e=t??null;return await this.implementation.setSelectionContext(e)??null}throw new Error(`Unknown action: ${e}`)}}class d{implementation;static objectName="host.editSession";constructor(e){this.implementation=e}async handleMessage(e,t){const s="host.editSession.";switch(e.startsWith(s)&&(e=e.slice(s.length)),e){case"insertText":{const e=t??null;return await this.implementation.insertText(e)??null}case"pasteImage":{const e=t??null;return await this.implementation.pasteImage(e)??null}case"copyImage":{const e=t??null;return await this.implementation.copyImage(e)??null}case"getDocumentState":{const e=t??null;return await this.implementation.getDocumentState(e)??null}case"insertAtCaret":{const e=t??null;return await this.implementation.insertAtCaret(e)??null}case"setSelection":{const e=t??null;return await this.implementation.setSelection(e)??null}case"applyDelta":{const e=t??null;return await this.implementation.applyDelta(e)??null}case"getCapabilities":{const e=t??null;return await this.implementation.getCapabilities(e)??null}case"copyText":{const e=t??null;return await this.implementation.copyText(e)??null}case"partialPageModeNotificationDismissed":{const e=t??null;return await this.implementation.partialPageModeNotificationDismissed(e)??null}default:throw new Error(`Unknown action: ${e}`)}}}class g{_sendMessage;constructor(e){this._sendMessage=e}async textUpdated(e){return await this._sendMessage("applet.editSession.textUpdated",e)??null}async selectionUpdated(e){return await this._sendMessage("applet.editSession.selectionUpdated",e)??null}async partialPageRangeChanged(e){return await this._sendMessage("applet.editSession.partialPageRangeChanged",e)??null}}class p{implementation;static objectName="host.lifecycle";constructor(e){this.implementation=e}async handleMessage(e,t){const s="host.lifecycle.";switch(e.startsWith(s)&&(e=e.slice(s.length)),e){case"initialize":case"init":{const e=t??null;return await this.implementation.initialize(e)??null}case"visuallyReady":{const e=t??null;return await this.implementation.visuallyReady(e)??null}case"interactionReady":{const e=t??null;return await this.implementation.interactionReady(e)??null}case"resizeFrame":{const e=t??null;return await this.implementation.resizeFrame(e)??null}case"resize":{const e=t??null;return await this.implementation.resize(e)??null}case"requestClose":{const e=t??null;return await this.implementation.requestClose(e)??null}case"startDragMove":{const e=t??null;return await this.implementation.startDragMove(e)??null}case"log":{const e=t??null;return await this.implementation.log(e)??null}case"openURL":{const e=t??null;return await this.implementation.openURL(e)??null}case"triggerSettingsMenu":{const e=t??null;return await this.implementation.triggerSettingsMenu(e)??null}default:throw new Error(`Unknown action: ${e}`)}}}class m{implementation;static objectName="host.indexedDB";constructor(e){this.implementation=e}async handleMessage(e,t){const s="host.indexedDB.";switch(e.startsWith(s)&&(e=e.slice(s.length)),e){case"beginVersionChange":{const e=t??null;return await this.implementation.beginVersionChange(e)??null}case"finishVersionChange":{const e=t??null;return await this.implementation.finishVersionChange(e)??null}case"createObjectStore":{const e=t??null;return await this.implementation.createObjectStore(e)??null}case"deleteObjectStore":{const e=t??null;return await this.implementation.deleteObjectStore(e)??null}case"createIndex":{const e=t??null;return await this.implementation.createIndex(e)??null}case"createFullTextIndex":{const e=t??null;return await this.implementation.createFullTextIndex(e)??null}case"deleteIndex":{const e=t??null;return await this.implementation.deleteIndex(e)??null}case"connect":{const e=t??null;return await this.implementation.connect(e)??null}case"disconnect":{const e=t??null;return await this.implementation.disconnect(e)??null}case"set":{const e=t??null;return await this.implementation.set(e)??null}case"get":{const e=t??null;return await this.implementation.get(e)??null}case"delete":{const e=t??null;return await this.implementation.delete(e)??null}default:throw new Error(`Unknown action: ${e}`)}}}class w{_sendMessage;constructor(e){this._sendMessage=e}async beginVersionChange(e){return await this._sendMessage("host.indexedDB.beginVersionChange",e)??null}async finishVersionChange(e){return await this._sendMessage("host.indexedDB.finishVersionChange",e)??null}async createObjectStore(e){return await this._sendMessage("host.indexedDB.createObjectStore",e)??null}async deleteObjectStore(e){return await this._sendMessage("host.indexedDB.deleteObjectStore",e)??null}async createIndex(e){return await this._sendMessage("host.indexedDB.createIndex",e)??null}async createFullTextIndex(e){return await this._sendMessage("host.indexedDB.createFullTextIndex",e)??null}async deleteIndex(e){return await this._sendMessage("host.indexedDB.deleteIndex",e)??null}async connect(e){return await this._sendMessage("host.indexedDB.connect",e)??null}async disconnect(e){return await this._sendMessage("host.indexedDB.disconnect",e)??null}async set(e){return await this._sendMessage("host.indexedDB.set",e)??null}async get(e){return await this._sendMessage("host.indexedDB.get",e)??null}async delete(e){return await this._sendMessage("host.indexedDB.delete",e)??null}}class _{implementation;static objectName="host.sdui";constructor(e){this.implementation=e}async handleMessage(e,t){const s="host.sdui.";switch(e.startsWith(s)&&(e=e.slice(s.length)),e){case"subscribeToItemCollection":{const e=t??null;return await this.implementation.subscribeToItemCollection(e)??null}case"unsubscribeToItemCollection":{const e=t??null;return await this.implementation.unsubscribeToItemCollection(e)??null}default:throw new Error(`Unknown action: ${e}`)}}}class f{_sendMessage;constructor(e){this._sendMessage=e}async itemCollectionChanged(e){return await this._sendMessage("applet.sdui.itemCollectionChanged",e)??null}}class b{implementation;static objectName="host.userAccount";constructor(e){this.implementation=e}async handleMessage(e,t){const s="host.userAccount.";switch(e.startsWith(s)&&(e=e.slice(s.length)),e){case"getInfo":{const e=t??null;return await this.implementation.getInfo(e)??null}case"setDialect":{const e=t??null;return await this.implementation.setDialect(e)??null}case"subscribeToUserInfoChanged":{const e=t??null;return await this.implementation.subscribeToUserInfoChanged(e)??null}case"unsubscribeToUserInfoChanged":{const e=t??null;return await this.implementation.unsubscribeToUserInfoChanged(e)??null}default:throw new Error(`Unknown action: ${e}`)}}}class M{_sendMessage;constructor(e){this._sendMessage=e}async getInfo(e){return await this._sendMessage("host.userAccount.getInfo",e)??null}async setDialect(e){return await this._sendMessage("host.userAccount.setDialect",e)??null}async subscribeToUserInfoChanged(e){return await this._sendMessage("host.userAccount.subscribeToUserInfoChanged",e)??null}async unsubscribeToUserInfoChanged(e){return await this._sendMessage("host.userAccount.unsubscribeToUserInfoChanged",e)??null}}const y={version:11},C={ational:"ate",tional:"tion",enci:"ence",anci:"ance",izer:"ize",bli:"ble",alli:"al",entli:"ent",eli:"e",ousli:"ous",ization:"ize",ation:"ate",ator:"ate",alism:"al",iveness:"ive",fulness:"ful",ousness:"ous",aliti:"al",iviti:"ive",biliti:"ble",logi:"log"},v=(new RegExp(`^(?<stem>.+?)(${Object.keys(C).join("|")})$`),{icate:"ic",ative:"",alize:"al",iciti:"ic",ical:"ic",ful:"",ness:""}),x=(new RegExp(`^(?<stem>.+?)(${Object.keys(v).join("|")})$`),"(?:(?:[^aeiouy]|(?<=[aeiou])y)+)"),I="(?:(?:[aeiou]|(?<![aeiou])y)+)";new RegExp(`^${x}?${I}${x}`),new RegExp(`^${x}?${I}${x}${I}?$`),new RegExp(`^${x}?(?:${I}${x}){2,}`),new RegExp(`^${x}?[aeiouy]`),new RegExp(`^${x}[aeiouy][^aeiouwxy]$`);class A extends Error{oldVersion;newVersion;constructor(e,t){super("upgrade needed"),this.oldVersion=e,this.newVersion=t}}var R,S;function T(e){return`${e.kind}:${e.id}`}!function(e){e.UI="ui",e.BACKGROUND="background"}(R||(R={})),function(e){e.GLOBAL="global",e.EDIT_SESSION="editSession"}(S||(S={}));class j{_manifests=new Map;_implementations=new Map;register(e){const t=T(e);if(this._manifests.set(t,e),null!=e.implementsObjects)for(const s of e.implementsObjects){const e=this._implementations.get(s)??new Set;e.add(t),this._implementations.set(s,e)}}all(){return[...this._manifests.values()]}get(e){return this._manifests.get(e)}findImplementations(e){const t=this._implementations.get(e)??new Set;return Array.from(t).map((e=>this._manifests.get(e)))}}class O{_parent;_objects=new Map;_resolving=new Map;_resolver;constructor(e=null,t){this._parent=e,this._resolver=t}register(e,t){this._objects.set(e,t)}unregister(e){this._objects.delete(e)}get(e){return this._objects.get(e)??null}execute(e,t){const s=e.split("."),n=s.pop(),i=s.join(".");if(null==i||null==n)throw new $(e);return this._handleWithResolver({target:i,method:n,data:t})}dispose(){this._objects.clear(),this._resolving.clear()}_handleWithResolver(e){const t=this._resolve(e.target);return t instanceof Promise?t.then((()=>this._handle(e))):this._handle(e)}_handle(e){const t=this._objects.get(e.target);if(null!=t)return t.handleMessage(e.method,e.data);if(null!=this._parent)return this._parent._handle(e);throw new U(e.target)}_isResolved(e){return this._objects.has(e)||(this._parent?._isResolved(e)??!1)}_resolve(e){if(!this._isResolved(e)){if(this._resolving.has(e))return this._resolving.get(e);if(null!=this._resolver){const t=this._resolver(e);if(t instanceof Promise){const s=t.then((t=>{if(!!this._resolving.has(e))return null==t?this._parent?._resolve(e):void this._objects.set(e,t)})).finally((()=>{this._resolving.delete(e)}));return this._resolving.set(e,s),s}if(null!=t)return void this._objects.set(e,t)}return this._parent?._resolve(e)}}}class E extends Error{}class $ extends E{action;constructor(e){super(`Malformed action: ${e}`),this.action=e}}class U extends E{action;constructor(e){super(`Object not found: ${e}`),this.action=e}}let k;class D{onAppletStart(e,t){this._send({action:"onAppletStart",data:[e,t],timestamp:Date.now()})}onAppletStop(e){this._send({action:"onAppletStop",data:[e],timestamp:Date.now()})}onAfterRPCCall(e,t){this._send({action:"onAfterRPCCall",data:[e,t],timestamp:Date.now()})}onBeforeRPCCall(e,t){this._send({action:"onBeforeRPCCall",data:[e,t],timestamp:Date.now()})}_send(e){self.postMessage({type:"gOS::devtools::collector",data:e},"*")}}var N,q;function L(e=""){return e?((Number(e)^16*Math.random())>>Number(e)/4).toString(16):"10000000-1000-4000-8000-100000000000".replace(/[018]/g,L)}!function(e){e.INCOMING="incoming",e.OUTGOING="outgoing",e.UNEXPECTED="unexpected"}(N||(N={}));class B{_defaultRequestTimeout=3e4;_pendingRequests=new Map;_transport;requestHandler;debugHandler;constructor(e,t,s){this._transport=e,this.requestHandler=t,this.debugHandler=s,e.onMessage=e=>{"response"===e.type?this._handleIncomingResponse(e):"request"===e.type&&this._handleIncomingRequest(e)}}_lastId=0;_prefix=L();_generateId(){return`${this._prefix}-${++this._lastId}`}async call(e,t,s=this._defaultRequestTimeout){const n=this._generateId();return new Promise(((i,a)=>{const o=setTimeout((()=>{this._pendingRequests.has(n)&&(this._pendingRequests.delete(n),a(new V(n,e,t)))}),s);this._pendingRequests.set(n,{complete:e=>{clearTimeout(o),this.debugHandler?.(N.INCOMING,e),this._pendingRequests.delete(n);const t=e.data;if("success"===t.status)i(t.data);else{const e="object"==typeof t.data&&null!=t.data&&"errorMessage"in t.data?String(t.data.errorMessage):"Unknown error";a(Object.assign(new Error(e),t.data))}},timerId:o});const r={id:n,type:"request",action:e,data:t};this.debugHandler?.(N.OUTGOING,r),this._transport.sendMessage(r)}))}dispose(){for(const e of this._pendingRequests.values())clearTimeout(e.timerId);this._pendingRequests.clear(),this._transport.onMessage=void 0}_handleIncomingResponse(e){const t=this._pendingRequests.get(e.id);null!=t?t.complete(e):this.debugHandler?.(N.UNEXPECTED,e)}async _handleIncomingRequest(e){try{if(this.debugHandler?.(N.INCOMING,e),null==this.requestHandler)throw new P(e.action);const t=await this.requestHandler(e);if(t===Symbol.for("gOS:rpc:skipResponse"))return;const s={id:e.id,action:e.action,type:"response",data:{status:"success",data:t}};this.debugHandler?.(N.OUTGOING,s),this._transport.sendMessage(s)}catch(t){const s={id:e.id,action:e.action,type:"response",data:{status:"failure",data:Object.assign({errorMessage:t.message},JSON.parse(JSON.stringify(t)))}};this.debugHandler?.(N.INCOMING,s),this._transport.sendMessage(s)}}}class F extends Error{}class P extends F{action;constructor(e){super(`No handler for RPC call ${e}`),this.action=e}}class V extends F{id;action;data;constructor(e,t,s){super(`RPC call ${t} timed out`),this.id=e,this.action=t,this.data=s}}!function(e){e.TRACE="trace",e.DEBUG="debug",e.INFO="info",e.WARN="warn",e.ERROR="error"}(q||(q={}));class z{logger;constructor(e){this.logger=e}log(e,t,s,n="<unknown>",i=-1,a=-1,o="<unknown>"){this.logger.log(e,t,s,n,i,a,o)}trace(e,t){this.log(q.TRACE,e,t)}debug(e,t){this.log(q.DEBUG,e,t)}info(e,t){this.log(q.INFO,e,t)}warn(e,t){this.log(q.WARN,e,t)}error(e,t){this.log(q.ERROR,e,t)}fatal(e,t){this.log(q.ERROR,e,t)}}class H{_outgoing;constructor(e){this._outgoing=e}_listener;get onMessage(){return this._listener}set onMessage(e){if(this._listener=e,null!=e){for(const t of this._queue)e(t);this._queue.length=0}}async sendMessage(e){await this._outgoing.sendMessage(e)}_queue=[];receiveMessage(e){if(null==this._listener){if(this._queue.length>100)throw new W;this._queue.push(e)}else this._listener(e)}}class W extends Error{constructor(){super("Buffer overrun")}}class G extends H{constructor(e){super({sendMessage:async t=>e.postMessage(t)}),e.onMessage((e=>this.receiveMessage(e)))}}class J{frame;_isLoaded=!1;_receiveMessage;_pendingMessages=[];_postMessageTargetOrigin="";constructor(e){this.frame=e,this.resize({width:480,height:300})}_onMessage=e=>{e.source===this.frame.contentWindow&&null!=this.frame.contentWindow&&this._receiveMessage?.(e.data)};setSource(e){try{this._isLoaded=!1;const t=new URL(e,self.location.href);"null"===self.origin||"http:"===self.location.protocol&&"https:"===t.protocol||!1===this.frame.getAttribute("sandbox")?.includes("allow-same-origin")?this._postMessageTargetOrigin="*":this._postMessageTargetOrigin=t.origin,this.frame.src=t.href}catch(e){throw this._postMessageTargetOrigin="",e}this.frame.addEventListener("load",(()=>queueMicrotask(this._onLoad)),{once:!0})}_onLoad=()=>{this._isLoaded=!0,this._flushPendingMessages()};onMessage(e){this._receiveMessage=e,self.addEventListener("message",this._onMessage)}postMessage(e){this._isLoaded&&null!==this.frame.contentWindow?(this._flushPendingMessages(),this.frame.contentWindow.postMessage(e,this._postMessageTargetOrigin)):this._pendingMessages.push(e)}dispose(){this.frame.src="about:blank",this._postMessageTargetOrigin="",this._pendingMessages.length=0,self.removeEventListener("message",this._onMessage)}resize(e){this.frame.style.width=`${e.width}px`,this.frame.style.height=`${e.height}px`}_flushPendingMessages(){if(0!==this._pendingMessages.length&&null!==this.frame.contentWindow){for(const e of this._pendingMessages)console.log("postMessage",e,this.frame.src,this._postMessageTargetOrigin),this.frame.contentWindow.postMessage(e,this._postMessageTargetOrigin);this._pendingMessages.length=0}}}class X{_worker;_handler;execute(e){this._worker=new Worker(e),this._worker.onmessage=e=>this._handler?.(e.data)}onMessage(e){this._handler=e}postMessage(e){this._worker?.postMessage(e)}dispose(){this._worker?.terminate(),this._worker=void 0}}class K{logger;manifest;objects;rpc;environment;sandbox;beforeUnloadHandlers=[];devtools=function(){return k??(k=new D)}();debugId;constructor(e,t,s,n){this.environment=t.environment,this.objects=new O(t.objects,(t=>e(t,this))),this.logger=new z(t.environment.makeLogger(`container/${s.id}`)),this.manifest=s,this.sandbox=n,this.debugId=`${this.manifest.id}/${this.manifest.version}/${Date.now()}/${Math.random()}`,this.rpc=new B(new G(this.sandbox),(async e=>await this.objects.execute(e.action,e.data)),((e,t)=>{if(this.environment.isDebugMode)switch(t.type){case"request":this.devtools?.onBeforeRPCCall(this.debugId,t);break;case"response":this.devtools?.onAfterRPCCall(this.debugId,t)}}))}instantiate(e){return new e(this._call.bind(this))}_call=async(e,t)=>{if(void 0===this.rpc)throw new Error("Applet is not loaded");return await this.rpc.call(e,t)};applet=new a(this._call);_isLoaded=!1;get isLoaded(){return this._isLoaded}loadApplet(){this._isLoaded||(this._isLoaded=!0,this.devtools?.onAppletStart(this.debugId,this.manifest.displayName))}unloadApplet(){if(this._isLoaded){this._isLoaded=!1,this.applet.terminate(null).catch((e=>{this.logger.error("Error terminating applet",e)})),this.devtools?.onAppletStop(this.debugId);for(const e of this.beforeUnloadHandlers)try{e()}catch(e){this.logger.error("Error in beforeUnload handler",e)}}}async gracefullyUnloadApplet(){this.unloadApplet()}onBeforeUnload(e){this.beforeUnloadHandlers.push(e)}async createInitializeResponse(e){const[t,s]=await Promise.all([this.environment.getContainerId(),this.environment.getUserId()]);return{platform:"extension",environment:this.environment.environment,clientType:this.environment.clientType,clientVersion:this.environment.clientVersion,containerId:t,userId:s,protocolVersion:"0.1.1",protocolVersions:{gondolaAuthorizedHttpClient:"0.1",gondolaCapiSocket:"0.1",gondolaCheetah:"0.1",gondolaCore:"0.1",gondolaEditSession:"0.1",gondolaLifecycle:"0.1",gondolaUserAccount:"0.1",gondolaAlerts:"0.1",gondolaSDUI:"0.1"}}}}class Q extends K{view;constructor(e,t,s,n){super(e,t,s,n),this.view=n}loadApplet(){this.isLoaded||(super.loadApplet(),this.view.setSource(this.manifest.entryPoint))}unloadApplet(){this.isLoaded&&(super.unloadApplet(),this.view.dispose())}}class Y extends K{constructor(e,t,s,n){super(e,t,s,n)}get bg(){return this.sandbox}loadApplet(){this.isLoaded||(super.loadApplet(),this.bg.execute(this.manifest.entryPoint))}unloadApplet(){this.isLoaded&&(super.unloadApplet(),this.bg.dispose())}async handleMessage(e,t){return await this.rpc.call(e,t)}}const Z={createUISandbox:()=>new J(document.createElement("iframe")),createBackgroundSandbox(){throw new X}};class ee{parent;environment;registry;objects;_applets=new Map;_objectFactories=new Map;_containerFactory=null;static default(e,t){return new ee(e,t)}constructor(e,t){let s,n;e instanceof ee?(this.parent=e,s=e.environment,n=e.registry):(this.parent=null,s=e,n=t),this.environment=s,this.registry=n,this.objects=new O(this.parent?.objects,(e=>{if(null==this.parent)return this._getOrCreateAppletService(T(this._findImplementingManifest(e)))}))}createAppletService(e){const t=this._findManifest(e),s=new Y(((e,t)=>this._objectFactories.get(e)?.(t)),this,t,this._getContainerFactory().createBackgroundSandbox(t,this));return s.loadApplet(),s}createAppletView(e){const t=this._findManifest(e),s=new Q(((e,t)=>this._getObjectFactory(e)?.(t)),this,t,this._getContainerFactory().createUISandbox(t,this));return s.loadApplet(),s}_getObjectFactory(e){return this._objectFactories.get(e)??this.parent?._getObjectFactory(e)}_getContainerFactory(){return this._containerFactory??this.parent?._getContainerFactory()??Z}_getOrCreateAppletService(e){const t=this._applets.get(e);if(void 0!==t)return t;const s=this.createAppletService(e);return this._applets.set(e,s),s}_findManifest(e){const t=this.registry.get(e);if(void 0===t)throw new Error(`Applet ${e} is not registered`);return t}_findImplementingManifest(e){const t=this.registry.findImplementations(e);if(0===t.length)throw new Error(`No applet implements ${e}`);if(t.length>1)throw new Error(`Multiple applets implement ${e}`);return t[0]}registerObject(e,t){this.objects.register(e,t)}registerObjectFactory(e,t){this._objectFactories.set(e,t)}withEditSession(e){const t=new ee(this);return t.registerObject(d.objectName,new d(e)),t}withContainerFactory(e){const t=new ee(this);return t._containerFactory=e,t}}}}]);