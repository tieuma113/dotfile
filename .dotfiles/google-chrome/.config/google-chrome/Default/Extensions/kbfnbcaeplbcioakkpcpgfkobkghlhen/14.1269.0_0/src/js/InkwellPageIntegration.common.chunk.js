(self.webpackChunk=self.webpackChunk||[]).push([[4584],{34638:(e,t,n)=>{n.d(t,{n:()=>D,r:()=>_});var s,i=n(29479),o=n(20161),r=n(81933),a=n(954),c=n(24666),l=n(8867),u=n(64271),h=n(31603),d=n(90572),g=n(3199),m=n(59179);!function(e){e.WindowFrameChanged="WindowFrameChanged",e.ViewportFrameChanged="ViewportFrameChanged",e.DocumentFrameChanged="DocumentFrameChanged",e.DocumentFrameScrolled="DocumentFrameScrolled",e.DocumentTextReflow="DocumentTextReflow"}(s||(s={}));var p,_,D,w=n(27250),I=n(20905),C=n(78767),x=n(84308),b=n(44071),v=n(84714),f=n(18647);!function(e){function t(e,n=[]){const s=e.parentElement;if(!s)return n;const i=s.scrollWidth>s.clientWidth,o=s.scrollHeight>s.clientHeight;return(i||o)&&n.push(s),t(s,n)}e.getScrollableParents=t,e.getParentsScrollObs=function(e){const n=t(e);return x.a(n.map((e=>b.R(e,"scroll").pipe(a.O(null))))).pipe(h.J(),d.h((e=>(0,C.fQ)(e))))},e.getGlobalScrollObs=function(e){const t=(0,f.Jj)(e);return x.a([b.R(t,"scroll").pipe(a.O(null)),t.top&&t.top!==t?b.R(t.top,"scroll").pipe(a.O(null)):v.of(null)]).pipe(h.J(),d.h((e=>(0,C.fQ)(e))))}}(p||(p={})),function(e){e.documentGeometryWillChange="documentGeometryWillChange",e.documentGeometryDidChange="documentGeometryDidChange"}(_||(_={})),function(e){function t(e,t=I.E0){return n=>n.pipe(i.h(e),o.w((e=>r.timer(t).pipe(i.h([_.documentGeometryDidChange,e]),a.O([_.documentGeometryWillChange,e])))),c.x((([e],[t])=>e===t)),a.O(null))}function n(e,[t,n]){if(t===_.documentGeometryWillChange)return e.willChangeBuffer.has(n)?D(e):(e.willChangeBuffer.add(n),{...e,event:{eventName:t,reasons:[n]}});if(!(e.willChangeBuffer.size>0))return D(e);e.didChangeBuffer.add(n),e.willChangeBuffer.delete(n);if(e.didChangeBuffer.size>0&&0===e.willChangeBuffer.size){const n=Array.from(e.didChangeBuffer);return e.didChangeBuffer.clear(),{...e,event:{eventName:t,reasons:n}}}return D(e)}function D({willChangeBuffer:e,didChangeBuffer:t}){return{willChangeBuffer:e,didChangeBuffer:t}}function x(){return D({willChangeBuffer:new Set,didChangeBuffer:new Set})}function b(){const e=(0,w.T)();return new l.y((t=>{const n=new ResizeObserver((e=>{t.next(e)}));return n.observe(e.document.body),()=>n.unobserve(e.document.body)}))}e.debounceGeometryUpdateReason=t,e.updateGeometryState=n,e.createInitialGeometryState=x,e.createViewportZoomChangeObs=b,e.createGeometryChangeObs=function(e,i){return u.T([b().pipe(t(s.ViewportFrameChanged)),u.T(p.getGlobalScrollObs(e),p.getParentsScrollObs(e),i.scroll.changes).pipe(t(s.DocumentFrameScrolled)),i.rect.changes.pipe(t(s.DocumentFrameChanged))]).pipe(h.J(),d.h(C.fQ),g.R(n,x()),m.U((e=>e.event)),d.h(C.fQ))}}(D||(D={}))},1998:(e,t,n)=>{n.r(t),n.d(t,{InkwellPageIntegrationImpl:()=>F});var s=n(69594),i=n(32073),o=n(90189),r=n(39963),a=n(78767),c=n(44675),l=n(40594);class u{constructor(e){this._messageAPI=e,this._logger=l.Y.create(`Inkwell/${u.name}`)}async getKey(){try{const e=await this._messageAPI.sendRuntimeMessage(s.p);return"string"!=typeof e?(this._logger.error("Security key has wrong data structure. Response type: "+typeof e),Promise.reject("Failed to get key. Wrong type.")):e}catch(e){return this._logger.error("Failed to get key:",e),Promise.reject("Failed to get key. Error.")}}}class h{constructor(e){this._createAPI=e,this._logger=l.Y.create(`Inkwell/${h.name}`),this._activeDocuments=new Map}getDocumentAPI(e){return new Proxy({},{get:(t,n)=>{if("then"!==n)return(...t)=>this._callAPIMethod(e,(e=>{const s=e[n];if("function"!=typeof s)throw new Error(`Property ${String(n)} is not a function`);return s.bind(e)(...t)}))}})}connectToDocument(e,t){const n=this.getOrCreateDocumentPromise(e),s=this._createAPI(e,t);return n.resolve(s),s}_callAPIMethod(e,t){this._activeDocuments.has(e)||this._logger.warn(`ConnectorAPI for document ${e} does not exist`);return this.getOrCreateDocumentPromise(e).promise.then(t)}getOrCreateDocumentPromise(e){var t;const n=null!==(t=this._activeDocuments.get(e))&&void 0!==t?t:(0,c.II)();return this._activeDocuments.set(e,n),n}}class d{constructor(e,t){this._inkwellAPI=(0,c.II)(),this._hostProxyAPI=new h(e),this._hostAPI=t((e=>{const t=this._hostProxyAPI.getDocumentAPI(e);return Promise.resolve(t)}))}get inkwellAPI(){return this._inkwellAPI.promise}get hostAPI(){return this._hostAPI}resolveInkwellAPI(e){this._inkwellAPI.resolve(e)}connectToDocument(e,t){return this._hostProxyAPI.connectToDocument(e,t)}}var g=n(59179),m=n(34638);class p{constructor(e){this._params=e,this.focusChangeObs=this._params.isCurrentFieldFocused,this.textChangeObs=this._params.textRevisionManager.revisionChanges.pipe(this._params.perf.rxMeasure("textChange"),g.U((e=>e.deltaChanges.delta))),this.selectionChangeObs=this._params.selectionService.selection.pipe(this._params.perf.rxMeasure("selection")),this.geometryChangeObs=m.n.createGeometryChangeObs(this._params.textField,this._params.textFieldLayout).pipe(this._params.perf.rxMeasure("geometryChange"))}}class _{makeExperimentationRequest(e){return Promise.resolve({responseBody:"",statusCode:501})}}class D{applyAlerts(e){throw new Error("Method not implemented.")}upgradeToPremium(e){throw new Error("Method not implemented.")}openGrammarlyGo(e){throw new Error("Method not implemented.")}}var w=n(59706),I=n(36807),C=n(11686);class x{constructor(e){this._params=e,this._log=l.Y.create(`Inkwell/${x.name}/dId[${this._params.documentID}]`),this._subs=new i.w0,this._queueedInkwellConnectorAPI=this._params.inkwellConnectorAPI.then((e=>function(e){let t=!1;const n=[];return new Proxy(e,{get:(s,i,o)=>t?Reflect.get(s,i,o):"then"!==i?"documentDidFocus"===i?s=>{t=!0;const i=e.documentDidFocus(s);return n.forEach((({prop:t,args:n,result:s})=>s.resolve(e[t](n)))),n.length=0,i}:s=>{if(t)return e[i](s);const o=(0,c.II)();return n.push({prop:i,args:s,result:o}),o.promise}:void 0})}(e))),[this._listenDocumentFocuseChange(),this._listenDocumentTextDidChange(),this._listenDocumentSelectedTextRangesDidChange(),this._listenDocumentGeometryChange()].forEach((e=>this._subs.add(e)))}dispose(){this._queueedInkwellConnectorAPI.then((e=>e.documentDidDestroy({}))),this._subs.unsubscribe()}cancel(e){return Promise.resolve()}getDocumentText(e){const t={revision:this._params.textRevisionManager.getLatestVersionNumber(),document:this._params.connectorHandler.getDocumentText()};return this._log.trace(`[${this._params.documentID}] handle getDocumentText:`,t),(0,r.Tb)().inkwell.gotGetDocumentTextRequest(this._params.documentID),Promise.resolve(t)}getDocumentGeometry(e){const{documentFrame:t,visibleTextRange:n}=this._params.connectorHandler.getDocumentGeometry(),s={documentFrame:t,visibleTextRange:n,windowFrame:{x:0,y:0,width:t.width,height:t.height},viewportFrame:{x:0,y:0,width:t.width,height:t.height}};return this._log.trace(`[${this._params.documentID}] handle getDocumentGeometry:`,s),Promise.resolve(s)}getBoundingBoxesForTextRanges(e){const{ranges:t}=e,n={revision:this._params.textRevisionManager.getLatestVersionNumber(),boundingBoxes:this._params.connectorHandler.getBoundingBoxesForTextRanges(t)};return this._log.trace(`[${this._params.documentID}] handle getBoundingBoxesForTextRanges:`,{ranges:t,result:n}),Promise.resolve(n)}setDocumentSelectedTextRanges(e){const[t]=e.ranges;return this._params.connectorHandler.setDocumentSelectedTextRange(t),this._log.trace(`[${this._params.documentID}] handle setDocumentSelectedTextRange:`,{range:t}),Promise.resolve()}async applyDocumentTextChange(e){const t=await this._params.connectorHandler.applyChangesToDocument(new I.i({ops:[...e.changes.ops]}));this._log.trace(`[${this._params.documentID}] handle applyChangesToDocument:`,{changes:e.changes,result:t})}_listenDocumentFocuseChange(){return this._params.extensionEventsSource.focusChangeObs.subscribe((e=>{this._queueedInkwellConnectorAPI.then((e=>{const t={revision:this._params.textRevisionManager.getLatestVersionNumber()};e.documentDidFocus(t),this._log.trace(`[${this._params.documentID}] documentDidFocus: ${JSON.stringify(t)}`)}))}))}_listenDocumentTextDidChange(){return this._params.extensionEventsSource.textChangeObs.subscribe((e=>{this._params.perf.callMeasure("textChangeSub")((()=>{this._queueedInkwellConnectorAPI.then((t=>{this._params.perf.callMeasure("textChangeSendRequest")((()=>{const n={revision:this._params.textRevisionManager.getLatestVersionNumber(),changes:e};t.documentTextDidChange(n),this._log.trace(`[${this._params.documentID}] documentTextDidChange: ${JSON.stringify(n)}`)}))}))}))}))}_listenDocumentSelectedTextRangesDidChange(){return this._params.extensionEventsSource.selectionChangeObs.subscribe((e=>{this._queueedInkwellConnectorAPI.then((t=>{const n={revision:this._params.textRevisionManager.getLatestVersionNumber(),ranges:e?[e]:[]};t.documentSelectedTextRangesDidChange(n),this._log.trace(`[${this._params.documentID}] documentSelectedTextRangesDidChange:`,n)}))}))}_listenDocumentGeometryChange(){return this._params.extensionEventsSource.geometryChangeObs.subscribe((e=>{this._queueedInkwellConnectorAPI.then((t=>{const n={revision:this._params.textRevisionManager.getLatestVersionNumber(),reasons:e.reasons};t[e.eventName](n),this._log.trace(`[${this._params.documentID}] ${e.eventName}:`,n)}))}))}}function b(e){return{cancel:e=>Promise.resolve(),getDocumentText:(0,C.O)((async t=>(await e(t)).getDocumentText)),getDocumentGeometry:(0,C.O)((async t=>(await e(t)).getDocumentGeometry)),getBoundingBoxesForTextRanges:(0,C.O)((async t=>(await e(t)).getBoundingBoxesForTextRanges)),setDocumentSelectedTextRanges:(0,C.O)((async t=>(await e(t)).setDocumentSelectedTextRanges)),applyDocumentTextChange:(0,C.O)((async t=>(await e(t)).applyDocumentTextChange))}}var v=n(50750),f=n(20161),y=n(79256),k=n(954),P=n(90572),T=n(48758);class S{constructor(e){this._params=e,this._log=l.Y.create(`Inkwell/${S.name}/dId[${this._params.documentID}]`),this._subs=new i.w0,this._subs.add(v.D(this._params.inkwellTextDecorationAPI).pipe(f.w((t=>this._getAlertVisibilityChanges(e.alerts).pipe(g.U((({visibilityChanges:e,partial:n})=>({visibilityChanges:e,textDecorationToInkwell:t,partial:n}))))))).subscribe((({visibilityChanges:e,partial:t,textDecorationToInkwell:n})=>{this._logRejections((()=>n.setTextDecorationVisibility({changes:e,partial:t})),"Unexpected error calling textDecorationToInkwell.setTextDecorationVisibility()")})))}dispose(){this._subs.unsubscribe()}handleTextDecorationInteraction(e){return Promise.resolve()}_logRejections(e,t){e().catch((e=>this._log.error(t,e)))}_getAlertVisibilityChanges(e){return y.P((()=>e.changes.pipe(this._params.perf.rxMeasure("alerts"),g.U((e=>{const t=new Set(e.addedAlerts.filter(T.S.isCapiAlert).map((e=>e.id))),n=new Set(e.removedAlerts.filter((e=>T.S.isCapiAlert(e.alert))).map((e=>e.id)));return[...e.addedAlerts.filter(T.S.isCapiAlert).filter((e=>!n.has(e.id))).map((e=>({visibility:"visible",alertId:e.id}))),...e.removedAlerts.filter((e=>T.S.isCapiAlert(e.alert))).filter((e=>!t.has(e.id))).map((e=>({visibility:"hidden",alertId:e.id})))]})),k.O(Array.from(e.getAll()).filter(T.S.isCapiAlert).map((e=>({visibility:"visible",alertId:e.id})))),P.h((e=>e.length>0)),g.U(((e,t)=>({visibilityChanges:e,partial:t>0}))))))}}function R(e){return{handleTextDecorationInteraction:(0,C.O)((async t=>(await e(t)).handleTextDecorationInteraction))}}class A{constructor(e){this._supportedFeatures=e,this._connector=new d(((e,t)=>new x({documentID:e,...t})),b),this._capi=new d(((e,t)=>new w.yU({documentID:e,...t})),w.n7),this._textDecoration=new d(((e,t)=>new S({documentID:e,...t})),R)}resolveInkwellAPI(e){this._connector.resolveInkwellAPI(e.connector),this._capi.resolveInkwellAPI(e.capi),this._textDecoration.resolveInkwellAPI(e.textDecoration)}connectDocument(e){const t=e.connectorDependencies.target.documentID,n={textField:e.connectorDependencies.target.textField,textRevisionManager:e.connectorDependencies.textRevisionManager,selectionService:e.connectorDependencies.selectionService,isCurrentFieldFocused:e.isFieldFocused,textFieldLayout:e.textFieldLayout,perf:e.perf},s=this._connector.connectToDocument(t,{connectorHandler:e.connectorDependencies.connectorHandler,textRevisionManager:e.connectorDependencies.textRevisionManager,extensionEventsSource:new p(n),inkwellConnectorAPI:this._connector.inkwellAPI.then((e=>{return n=t,s=e,{cancel:e=>Promise.resolve(),documentDidFocus:(0,C.i)(n,s.documentDidFocus),documentDidDestroy:(0,C.i)(n,s.documentDidDestroy),documentGeometryWillChange:(0,C.i)(n,s.documentGeometryWillChange),documentGeometryDidChange:(0,C.i)(n,s.documentGeometryDidChange),documentTextDidChange:(0,C.i)(n,s.documentTextDidChange),documentSelectedTextRangesDidChange:(0,C.i)(n,s.documentSelectedTextRangesDidChange)};var n,s})),perf:e.perf}),i=this._capi.connectToDocument(t,{inkwellCapiAPI:this._capi.inkwellAPI.then((e=>(0,w.C2)(t,e))),checkingService:e.checkingService,capiMessages:e.capiMessages,getTextRevision:()=>e.connectorDependencies.textRevisionManager.getLatestVersionNumber()}),o=this._supportedFeatures["inline-decorations"]?this._textDecoration.connectToDocument(t,{alerts:e.alertProcessor.alerts,inkwellTextDecorationAPI:this._textDecoration.inkwellAPI.then((e=>{return n=t,s=e,{setTextDecorationVisibility:(0,C.i)(n,s.setTextDecorationVisibility)};var n,s})),perf:e.perf}):null;return{dispose:()=>{s.dispose(),i.dispose(),null==o||o.dispose()}}}get hostAPI(){return{connector:this._connector.hostAPI,capi:this._capi.hostAPI,textDecoration:this._textDecoration.hostAPI,experimentation:new _,sdui:new D}}}class F{constructor(e,t=(0,o.OB)().browserApi){this._params=e,this._extensionAPI=t,this._logger=l.Y.create(`Inkwell/${F.name}`),this._subscriptions=new i.w0,this._highlightRoots=new Map,this._logger.debug("Creating InkwellPageIntegrationImpl"),this._apiRouters=new A(e.supportedFeatures),this._secureKeySource=new u(t.message),this.startup()}async startup(){try{this._logger.debug("Mounting Inkwell iFrame");const e=await(0,s.M)({client:"extension-chrome",servicesEnvironment:"prod",capiSource:"connector",plugins:[],clientVersion:(0,o.OB)().config.buildInfo.version,frameSrc:this._extensionAPI.getUrl("src/inkwell/index.html"),hostAPI:this._apiRouters.hostAPI,iframeSecurityStrategy:{kind:"secureKey",getSecureKey:()=>this._secureKeySource.getKey()}});this._apiRouters.resolveInkwellAPI(e),(0,r.Tb)().inkwell.launchInkwellSuccess()}catch(e){this._logger.error("Cannot start inkwell page integration.",e),(0,r.Tb)().inkwell.launchInkwellError(e)}}connectDocument(e){try{const t=e.connectorDependencies.target.documentID,n=this._apiRouters.connectDocument(e);return(0,r.Tb)().inkwell.connectDocumentSuccess(),{dispose:()=>{n.dispose(),this._highlightRoots.delete(t)}}}catch(e){return this._logger.error("Connect to document failed.",e),(0,r.Tb)().inkwell.connectDocumentError(e),{dispose:a.EI}}}_getOrCreateHighlightsRootSource(e){var t;const n=null!==(t=this._highlightRoots.get(e))&&void 0!==t?t:(0,c.II)();return this._highlightRoots.set(e,n),n}dispose(){this._subscriptions.unsubscribe(),this._inkwellApp.then((e=>e.dispose()))}}},59706:(e,t,n)=>{n.d(t,{C2:()=>p,j9:()=>g,n7:()=>_,yU:()=>m});var s=n(32103),i=n(32073),o=n(50750),r=n(20161),a=n(8065),c=n(84714),l=n(59179),u=n(12518),h=n(40594),d=n(11686);const g=new Set(["sdui:add","sdui:update","sdui:remove"]);class m{constructor(e){this._params=e,this._log=h.Y.create(`Inkwell/${m.name}/dId[${this._params.documentID}]`),this._subs=new i.w0,this._subs.add(this._subscribeToCAPIMessages())}dispose(){this._subs.unsubscribe()}async sendCapiMessage(e){try{const t=await this._params.checkingService.sendMessage(e.message.action,e.message,!0)();if(u.nM(t))throw t.left}catch(e){this._log.error("Unexpected error calling checkingService.sendMessage",e)}}capiWebSocketOpened(e){return Promise.resolve()}capiWebSocketClosed(e){return Promise.resolve()}capiWebSocketMessage(e){return Promise.resolve()}capiWebSocketError(e){return Promise.resolve()}_subscribeToCAPIMessages(){return o.D(this._params.inkwellCapiAPI).pipe(r.w((e=>this._params.capiMessages.pipe(a.b((e=>"capiTextRevision"===e.kind?c.of(this._params.getTextRevision()).pipe(l.U((t=>({...e,documentTextRevision:t})))):c.of(e))),l.U((t=>({message:t,capiToInkwell:e}))))))).subscribe((({message:e,capiToInkwell:t})=>{switch(e.kind){case"capiConnected":this._logRejections((()=>t.capiConnected({sessionID:e.sessionId})),"Unexpected rejection from capiToInkwell.capiConnected");break;case"capiDisconnected":this._logRejections((()=>t.capiDisconnected({sessionID:e.sessionId})),"Unexpected rejection from capiToInkwell.capiDisconnected");break;case"capiTextRevision":this._logRejections((()=>t.capiTextRevision({sessionID:e.sessionId,documentRevision:e.documentTextRevision,capiRevision:e.capiTextRevision})),"Unexpected rejection from capiToInkwell.capiTextRevision");break;case"capiMessage":this._logRejections((()=>t.capiMessageReceived({sessionID:e.sessionId,message:e.message})),"Unexpected rejection from capiToInkwell.capiMessageReceived");break;default:(0,s.L0)(e)}}))}_logRejections(e,t){e().catch((e=>this._log.error(t,e)))}}function p(e,t){return{capiConnected:(0,d.i)(e,t.capiConnected),capiDisconnected:(0,d.i)(e,t.capiDisconnected),capiMessageReceived:(0,d.i)(e,t.capiMessageReceived),capiAlertRemoved:(0,d.i)(e,t.capiAlertRemoved),capiTextRevision:(0,d.i)(e,t.capiTextRevision),capiWebSocketCreate:(0,d.i)(e,t.capiWebSocketCreate),capiWebSocketClose:(0,d.i)(e,t.capiWebSocketClose),capiWebSocketConnect:(0,d.i)(e,t.capiWebSocketConnect),capiWebSocketSend:(0,d.i)(e,t.capiWebSocketSend)}}function _(e){return{sendCapiMessage:(0,d.O)((async t=>(await e(t)).sendCapiMessage)),capiWebSocketOpened:(0,d.O)((async t=>(await e(t)).capiWebSocketOpened)),capiWebSocketClosed:(0,d.O)((async t=>(await e(t)).capiWebSocketClosed)),capiWebSocketMessage:(0,d.O)((async t=>(await e(t)).capiWebSocketMessage)),capiWebSocketError:(0,d.O)((async t=>(await e(t)).capiWebSocketError))}}},11686:(e,t,n)=>{function s(e,t){return async n=>null===n?await t(null):await t({...n,documentID:e})}function i(e){return async t=>{const n=await e(t.documentID),s=await n(t);return{documentID:t.documentID,...s}}}n.d(t,{O:()=>i,i:()=>s})}}]);