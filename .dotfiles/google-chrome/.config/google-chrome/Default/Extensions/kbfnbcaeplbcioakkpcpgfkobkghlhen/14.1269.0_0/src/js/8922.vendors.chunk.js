(self.webpackChunk=self.webpackChunk||[]).push([[8922],{19299:(e,t,r)=>{r.d(t,{Y1:()=>i,uq:()=>c});var i,s,a,n,o,d,l,h,c,p,g,u=r(21147),_=r(32103),m=r(42203),f=r(67880),v=r(52071);!function(e){var t;!function(e){var t;!function(e){e.user="user",e.api="api",e.doubleClick="doubleClick"}(t=e.Source||(e.Source={}));e.eq=(0,u.f7)((function(e,r){return e.source===r.source&&(e.source===t.doubleClick&&r.source===t.doubleClick?e.selectedWord===r.selectedWord:s.equals(e.formatting,r.formatting))}))}(t=e.Meta||(e.Meta={}));e.nonEmpty=function(e){return e.length>0},e.isEmpty=function(e){return 0===e.length},e.toTextRange=function(e){return v.SV.create(e.index,e.index+e.length)},e.isUserSelection=function(e){return e.meta.source===t.Source.user},e.isApiSelection=function(e){return e.meta.source===t.Source.api},e.isDoubleClickSelection=function(e){return e.meta.source===t.Source.doubleClick};var r=e.eqRange=(0,u.f7)((function(e,t){return e.index===t.index&&e.length===t.length})),s=e.eqFormatting=(0,u.f7)(f.vZ);e.eq=(0,u.f7)((function(e,t){return r.equals(e,t)&&i.Meta.eq.equals(e.meta,t.meta)})),e.empty={index:0,length:0,meta:{source:i.Meta.Source.user,formatting:{}}}}(i||(i={})),function(e){e.DenaliOtherDocSession="denaliOtherDocSession",e.DenaliSameDocSession="denaliSameDocSession",e.MSOutlook="outlook",e.MSWord="word",e.MSWordOnline="wordOnline",e.MSExcel="excel",e.MSOffice="msoffice",e.ProbablyMSOutlookOnline="probablyMSOutlookOnline",e.GDocs="gdocs",e.GSheets="gsheets",e.ProbablyGMail="probablyGmail",e.CocoaHTMLWriter="cocoaHTMLWriter",e.DropboxPaper="dropbox_paper",e.PlainText="plainText",e.Unknown="unknown",e.Synthetic="synthetic"}(s||(s={})),function(e){e.empty={top:0,bottom:0}}(a||(a={})),l=n||(n={}),(d=l.Y||(l.Y={})).top="top",d.middle="middle",d.bottom="bottom",(o=l.X||(l.X={})).left="left",o.middle="middle",o.right="right",function(e){e.toViewport=function(e){return function(t){switch(t){case n.X.left:return e.left;case n.X.middle:return e.left+e.width/2;case n.X.right:return e.right;default:return(0,_.vE)(t)}}}}(l.X||(l.X={})),function(e){e.toViewport=function(e){return function(t){switch(t){case n.Y.top:return e.top;case n.Y.middle:return e.top+e.height/2;case n.Y.bottom:return e.bottom;default:return(0,_.vE)(t)}}}}(l.Y||(l.Y={})),function(e){var t;!function(e){e.textMaybeWithFormatting="text",e.onlyFormatting="formatting"}(t=e.Type||(e.Type={}));e.isTextMaybeWithFormatting=function(e){return e.type===t.textMaybeWithFormatting},e.isOnlyFormatting=function(e){return e.type===t.onlyFormatting}}(h||(h={})),function(e){e.none="none",e.fast="fast",e.initial="initial",e.fake="fake"}(c||(c={})),function(e){var t;!function(e){e.bold="bold",e.italic="italic",e.underline="underline",e.strike="strike",e.header1="header1",e.header2="header2",e.bulletList="bulletList",e.dashedList="dashedList",e.orderedList="orderedList",e.link="link"}(t=e.Type||(e.Type={}));e.is=function(e){return(0,m.CI)(t,e)},e.asList=Object.values(p.Type);!function(e){e.is=function(e){return void 0!==e[t.link]}}(e.LinkPayload||(e.LinkPayload={}))}(p||(p={})),function(e){e.undo="undo",e.redo="redo",e.cut="cut",e.copy="copy",e.paste="paste",e.selectAll="selectAll"}(g||(g={}))},94579:(e,t,r)=>{r.d(t,{a:()=>l});var i=r(12533),s=r(90023),a=r(32103),n=r(64443),o=r(58303),d=r(10444);class l{constructor(){(0,i._)(this,"_log",n.C8.Logging.getLogger("AlertManager.repository",n.zW.i.DEBUG)),(0,i._)(this,"_allAlerts",new Map),(0,i._)(this,"_capiAlertsIdMapping",new Map),(0,i._)(this,"add",(e=>{this._allAlerts.set(e.id,e)})),(0,i._)(this,"remove",(e=>{this._log.trace("AllAlerts: Clean alert from all alerts",e.toLiteString()),(0,a.kG)(0===e.references,"can not dispose alert in use",(()=>e.toString())),(0,a.kG)(!1===e.isValid,"can not dispose valid alert",(()=>e.toString())),(0,a.kG)(this._allAlerts.delete(e.id),"alert should exist in alerts list",(()=>e.toString())),e.dispose()})),(0,i._)(this,"addToCapiMapping",(e=>{e.isValid||(0,s.zG)(e.rawId,o.g_((()=>this._log.debug("skip register of local alert in capi mapping",e)),(t=>{this._log.trace("register alert in capi mapping",e.toLiteString()),(0,a.kG)(void 0===this._capiAlertsIdMapping.get(t),"unexpected overlap of rawid alert",(()=>e.toString())),e.validate(),this._capiAlertsIdMapping.set(t,e.id)})))})),(0,i._)(this,"removeFromCapiMapping",(e=>{e.isValid&&((0,s.zG)(e.rawId,d.bw((t=>{this._log.trace("clean valid alert capi mapping for: "+e.toLiteString()),(0,a.kG)(this._capiAlertsIdMapping.delete(t),"valid alert should had valid raw id",(()=>e.toString()))}))),e.invalidate())})),(0,i._)(this,"getByAlertId",(e=>o.ij(this._allAlerts.get(e)))),(0,i._)(this,"getByRawAlertId",(e=>(0,s.zG)(o.ij(this._capiAlertsIdMapping.get(e)),o.tS(this.getByAlertId)))),(0,i._)(this,"swapRaw",((e,t)=>{const r=(0,s.zG)(e.rawId,o.Gg((e=>this._capiAlertsIdMapping.has(e)))),i=(0,s.zG)(e.rawId,o.Gg((e=>this._capiAlertsIdMapping.has(e))));(0,a.kG)(r||i,"At least one of the swapped alerts should be registered in the system");const n=e._raw;e.silentPatchWithRawAlert(t._raw),t.silentPatchWithRawAlert(n),r&&this._capiAlertsIdMapping.set(d.MH(e.rawId),e.id),i&&this._capiAlertsIdMapping.set(d.MH(t.rawId),t.id)})),(0,i._)(this,"toArray",(()=>Array.from(this._allAlerts.values()))),(0,i._)(this,"toMap",(()=>this._allAlerts)),(0,i._)(this,"toJSON",(()=>({allAlerts:Array.from(this._allAlerts.entries()),idMapping:Array.from(this._capiAlertsIdMapping.entries())})))}}},62633:(e,t,r)=>{r.d(t,{SC:()=>Ce});var i,s=r(12533),a=r(37159),n=r(96705),o=r(12518),d=r(48886),l=r(92748),h=r(90023),c=r(15217),p=r(32103),g=r(13391),u=r(42203),_=r(64443),m=r(58303),f=r(10444),v=r(32486),A=r(8907),b=r(24063),y=r(45676),S=r(81933),w=r(917),C=r(2187),I=r(7378),k=r(16514),R=r(94718),M=r(86214),T=r(17437),G=r(19328);!function(e){var t=e.group=G.dM.group;e.eq=G.dM.eq;function r(e){return r=>(0,h.zG)(e,M.vh.foldMap(t)(s,a,i),(0,u.WA)(t.concat)(r))}e.applyDiff=r,e.fromAlerts=function(e){const t=_.C8.Logging.getLogger("DocumentCounters");return e.pipe(S.scan(((e,t)=>({alerts:t,counters:r(I.p.Diff.toRegistered(I.p.diff(e.alerts,t)))(e.counters)})),{alerts:I.p.empty,counters:G.dM.group.empty}),S.tap((({counters:e})=>{G.dM.isValid(e)||t.error("Counters can not be below zero",G.dM.show.show(e))})),S.map((({counters:e})=>e)))};const i=e=>T.R.toUnmutedOnly(e.counters),s=(0,h.ls)(i,t.inverse),a=(e,r)=>t.concat(i(r),s(e))}(i||(i={}));var z,U=r(18117),x=r(2245),E=r(38538),D=r(97225),F=r(82605),P=r(6083);!function(e){e.empty=new Map,e.eq=x.Eh(P.R.Id.ord,F.T.ord);function t(e){const{left:t,right:r}=(0,h.zG)(e,E.DZ(m.ij),E.z7((e=>"GeneralScore"!==e&&"ai_detector_score"!==e)),E.Su(((e,t)=>{return{lensId:(r=e,r===P.R.SpecialId.Plagiarism?o.F2(P.R.SpecialId.Plagiarism):P.R.OutcomeId.toOutcomeId(r)),score:F.T.fromNumber(t)};var r})),E.tV((0,U.Yt)(o.wE))),i=(0,h.zG)(r,E.UI((({lensId:e,score:t})=>(0,h.bc)(e,t))),(e=>new Map(Object.values(e))));return(0,h.zG)(D.Qp(m.DT((0,h.ff)(E.xb))(t),m.DT((0,h.ff)(x.xb))(i)),m.fS((()=>D.F2(new Map))))}e.fromCapi=function(e){return e.pipe(S.filter((0,u.Kg)(y.hX.is("finish"),(0,u.W9)(y.hX.is("async_check_finished"),y.qq.is("plagiarism")),y.hX.is("feedback_ack"))),S.map((e=>e.outcomeScores)),S.filter(u.$K),S.map(t),S.tap(D.Vn((e=>{E.xb(e)||_.C8.Logging.getLogger("LensesScores").error("failed to parse capi scores",e)}))),S.filter((0,u.Kg)(D.WP,D.tO)),S.map((e=>e.right)))}}(z||(z={}));var L,Z=r(91219),B=r(59833),O=r(95922),W=r(51505),N=r(53186),$=r(68291),K=r(43789),Y=r(36807),V=r(68822),j=r(14911),q=r(71576),J=r(41833),X=r(47765),H=r(39953),Q=r(21147),ee=r(67880);(e=>{e.isInsert=e=>"insert"in e,e.isInsertString=t=>(0,e.isInsert)(t)&&"string"==typeof t.insert,e.isInsertEmbed=t=>(0,e.isInsert)(t)&&!(0,e.isInsertString)(t),e.isDelete=e=>"delete"in e,e.isRetain=e=>"retain"in e,e.containsInsertsOnly=t=>t.ops.every(e.isInsert),e.getInsertLength=Y.i.Op.length,e.getTrimmedInsertLength=t=>(0,e.isInsertString)(t)?t.insert.trim().length:1,e.match=(t,r,i)=>s=>(0,e.isInsert)(s)?t(s):(0,e.isDelete)(s)?r(s):i(s),e.getAttr=function(t,r){return(0,e.isDelete)(t)||!t.attributes?m.YP:"function"==typeof r?(0,H.zG)(m.ij(Object.keys(t.attributes).find(r)),m.UI((e=>t.attributes[e]))):m.ij(t.attributes[r])},e.operationLength=Y.i.Op.length;const t=e=>-e.delete;e.getOperationOffset=(0,e.match)(Y.i.Op.length,t,Y.i.Op.length);const r=e=>t=>t.ops.map(e).reduce(u.Sm,0),i=()=>0;e.calcDiffLength=r((0,e.match)(Y.i.Op.length,t,i)),e.calcAmountLength=r((0,e.match)(Y.i.Op.length,Y.i.Op.length,i)),e.calcAffectedLength=r((0,e.match)(i,Y.i.Op.length,Y.i.Op.length)),e.rangeOfTheChange=function(t){const r=(0,e.match)(h.W8,h.W8,(e=>Boolean(e.attributes)));return t.ops.reduce((([t,i],s)=>{const a=(0,e.operationLength)(s),n=i+a;return[(0,H.zG)(t,m.g_((()=>r(s)?m.G([i,n]):m.YP),(e=>r(s)?m.G([e[0],n]):m.G(e)))),n]}),[m.YP,0])[0]},e.isEqual=t=>(r,i)=>(0,e.match)((r=>(0,e.isInsert)(i)&&r.insert===i.insert&&t(r.attributes,i.attributes)),(t=>(0,e.isDelete)(i)&&t.delete===i.delete),(r=>(0,e.isRetain)(i)&&r.retain===i.retain&&t(r.attributes,i.attributes)))(r),e.deltaEq=Q.f7(((t,r)=>t.ops.length===r.ops.length&&(0,c.Hx)(t.ops,r.ops,(0,e.isEqual)(ee.vZ)))),e.normalizeDelta=e=>(new Y.i).compose(e);const s=e=>e&&Object.keys(e).reduce(((t,r)=>(t[r]="string"==typeof e[r]?`<${e[r].length}>`:e[r],t)),{});e.anonymizeTextAndStringAttrs=function(t){return t.ops.reduce(((t,r)=>(0,e.match)((r=>t.insert("string"==typeof r.insert?`<${(0,e.getInsertLength)(r)}>`:"<embed>",s(r.attributes))),(e=>t.delete(e.delete)),(e=>t.retain(e.retain,s(e.attributes))))(r)),new Y.i)},e.squash=function(e){return e.reduce(((e,t)=>e.compose(new Y.i(t))),new Y.i)},e.cleanAllAttrs=function(t){return t.reduce(((t,r)=>(0,e.match)((e=>t.insert(e.insert)),(e=>t.delete(e.delete)),(e=>t.retain(e.retain)))(r)),new Y.i)};const a=e=>m.ij(e.attributes);e.getAttrs=(0,e.match)(a,(()=>m.YP),a),e.skipAny=h.jv;e.cleanDelta=(t,r)=>i=>{const s=e=>e&&Object.keys(e).filter(((e,t,i)=>r(e,i.slice(0)))).reduce(((t,r)=>(t[r]=e[r],t)),{});return i.reduce(((r,i)=>(0,e.match)((e=>r.insert("string"==typeof e.insert||t(e.insert)?e.insert:" ",s(e.attributes))),(e=>r.delete(e.delete)),(e=>r.retain(e.retain,s(e.attributes))))(i)),new Y.i)},e.splitToDeleteThenInsert=t=>t.reduce((([t,r],i)=>e.match((e=>[t,r.push(e)]),(e=>[t.push(e),r]),(e=>[t.push({retain:e.retain}),r.push(e)]))(i)),[new Y.i,new Y.i]).map((e=>e.chop())),e.nonEmpty=e=>e.ops.length>0,e.findInDelta=function(e,t=i){return r=>{let i=0,s=0;for(;i<r.ops.length;){const a=r.ops[i];if(e(a))return s+=t(a),m.G(s);s+=Y.i.Op.length(a),i+=1}return m.YP}},e.getOps=(0,h.ls)((0,ee.ei)("ops"),m.ij,m.tS(N.nI))})(L||(L={}));var te,re=function(){function e(t){(0,J._)(this,e),(0,s._)(this,"_delta",void 0),(0,s._)(this,"_cursor",void 0),this._delta=t,this._cursor={index:0,operationOffset:0}}return(0,X._)(e,[{key:"next",value:function(e){(0,p.kG)(e>=0,"Length cannot be negative");var t=this._cursor.index;if(t>=this._delta.ops.length)return m.YP;for(var r=L.operationLength(this._delta.ops[t]),i=e-(r-this._cursor.operationOffset);i>0&&t<this._delta.ops.length-1;)t++,i-=r=L.operationLength(this._delta.ops[t]);return i>0?(this._cursor={index:t+1,operationOffset:0},m.YP):(this._cursor={index:t,operationOffset:r+i},m.G(this._delta.ops[t]))}}]),e}();!function(e){const t=m.uZ((0,j.DU)());e.getEnrichedWithFormattingDelta=e=>r=>{const i=new re(e);return r.ops.reduce((([e,r],s)=>{const a=i.next(r);return q.s.isInsert(s)?[e.insert(s.insert,m.FS(t.concat(m.tS(q.s.getAttrs)(a),q.s.getAttrs(s)))),0]:[e.push(s),q.s.operationLength(s)]}),[new Y.i,1])[0]}}(te||(te={}));var ie=r(18990),se=r(86399),ae=r(55812);const ne=(0,u.HP)(_.C8.Logging.getLogger),oe=(0,h.ls)(se.UI((({beingAppliedAlert:e,undo:t,reversedAlternative:r})=>W.Y3((()=>{const i={action:A.PZ.ACCEPTED,commit:()=>ne("AlertManager.ops").debug(`_applyTransformJson(${e.toLiteString()}):commit()`),undo:t,reversedAlternative:e.registerReversedAlternative(r)},s=e.switchToApplied(i),a=ae.xS.create(s.state.from,ie.h.create(e));return[s.id,a]}),o.KC))),W.mg);function de(e){const t=b.r3.compose(e.alternatives.map(l.UI((e=>e.alternative))),e.currentFullText);return(0,h.zG)(q.s.nonEmpty(t.composedDelta)?m.G(t):m.YP,m.UI((({composedDelta:t,reversedAlternatives:r})=>({changeWithFormatting:(0,h.zG)(t,te.getEnrichedWithFormattingDelta(e.currentFullText),(t=>K.RI.delta(t,e.originalTextLength))),correctRevAlternatives:(0,h.zG)(r,v.T.tapFailure((({rejected:e})=>_.C8.Logging.getLogger("AlertManager.ops").error("failed to generate reverse alternative",e))),v.T.foldSuccess(B.UI((t=>({reversedAlternative:t.reversedAlternative,alternative:l.li(e.alternatives[t.alternativeIndex]),alert:e.alerts[t.alternativeIndex].alert})))))}))))}var le;!function(e){const t=(0,h.ls)(((e,t)=>o.Y3((()=>ae.xS.create(e,t)),o.KC)),o.UI((e=>(0,h.bc)(e[0].id,e))),O.of);e.prepare=O.tS((0,h.og)(t)),e.prepareFromAlert=W.tS((e=>t(e.state.from,ie.h.create(e))))}(le||(le={}));function he(e,t,r){return o.DT(e,(e=>{const i=new p.ej(t,e.toString());return _.C8.Logging.getLogger("AlertManager.ops").error(t,{error:i,extra:r}),i}))}const ce=(e,t)=>he(ae.bZ.isNotDisposed,e,t);function pe(e){return W.tS(m.g_((0,h.a9)(W.F2(void 0)),e))}var ge,ue,_e,me,fe,ve;!function(e){e.mock={undoApplied:()=>W.F2(void 0)}}(ge||(ge={}));class Ae{_applyFeedbackToAlert(e,t,r,i){return W.Y3((()=>{this._alertsRepo.removeFromCapiMapping(e);const s=this._createFeedbackUndoable(e,t,i);return e.changeState(ae.bZ.State.Applied.create(s,r,ae.bZ.State.Applied.Method.ByCard,ie.h.create(e)))}),o.KC)}_createFeedbackUndoable(e,t,r){return{action:t,replacement:e.replaceText,commit:r,undo:()=>this._alertsRepo.addToCapiMapping(e)}}_commitFeedbackToCapi(e,t){return(0,h.zG)(e.rawId,m.g_((0,h.a9)((()=>this._log.debug("skip feedback for local alert",e))),(e=>this._sendFeedback((0,a._)({id:e},t)))))}_sendFeedback(e){return()=>{$.Vi(this._capiClient.sendFeedback(e)).catch(this._handleCapiError("alert feedback"))}}_commitShortenItSubmitToCapi(e){return(0,h.zG)(e.rawId,m.g_((0,h.a9)((()=>this._log.debug("skip shorten-it-submit for local alert",e))),(e=>this._shortenItSubmit(e))))}_shortenItSubmit(e){return()=>{$.Vi(this._capiClient.shortenItSubmit(e)).catch(this._handleCapiError("shorten-it-submit"))}}_switchToBeingApplied(e,t,r){return W.Y3((()=>(this._alertsRepo.removeFromCapiMapping(e),e.switchToBeingAppliedState(t,r))),o.KC)}constructor(e,t,r,i){(0,s._)(this,"_positionManager",void 0),(0,s._)(this,"_getContent",void 0),(0,s._)(this,"_capiClient",void 0),(0,s._)(this,"_alertsRepo",void 0),(0,s._)(this,"_log",void 0),(0,s._)(this,"_sendUpdate",void 0),(0,s._)(this,"_sendSingleUpdate",void 0),(0,s._)(this,"_flushChanges",void 0),(0,s._)(this,"changes",void 0),(0,s._)(this,"events",void 0),(0,s._)(this,"undoApplied",void 0),(0,s._)(this,"_dismissBatch",void 0),(0,s._)(this,"_applyAlert",void 0),(0,s._)(this,"_applyTransformJson",void 0),(0,s._)(this,"_alertFeedback",void 0),(0,s._)(this,"_alertBatchFeedback",void 0),(0,s._)(this,"_notifyAlertUpdated",void 0),(0,s._)(this,"_releaseRef",void 0),(0,s._)(this,"_changeMuteState",void 0),(0,s._)(this,"_changeGapValue",void 0),(0,s._)(this,"_confirmApplied",void 0),(0,s._)(this,"_changeTakeawayFeedback",void 0),(0,s._)(this,"_shortenItSummaryNotFound",void 0),(0,s._)(this,"_commitShortenItSummaryRequest",void 0),(0,s._)(this,"_dismissShortenItTransformGroup",void 0),(0,s._)(this,"_changeToneAIToneAlternative",void 0),(0,s._)(this,"_handleCapiError",void 0),(0,s._)(this,"_applyAlertData",void 0),(0,s._)(this,"_sendApplyFeedback",void 0),(0,s._)(this,"_sendApplyTextFeedback",void 0),(0,s._)(this,"_sendApplyTransformJsonFeedback",void 0),this._positionManager=e,this._getContent=t,this._capiClient=r,this._alertsRepo=i,this._log=_.C8.Logging.getLogger("AlertManager.ops"),this._sendUpdate=e=>W.Y3((()=>this.events.next({updated:new Map(e)})),o.KC),this._sendSingleUpdate=W.tS((e=>this._sendUpdate([e]))),this._flushChanges=W.Y3((()=>this.changes.next(K.RI.flush())),o.KC),this.changes=new S.Subject,this.events=new S.Subject,this.undoApplied=(e,t)=>{return(0,h.zG)((()=>this._positionManager.getTextLength()),O.tS((t=>{const i={alertsToUpdate:[],reversedDelta:new Y.i,undo:h.Q1},s=e.filter(ae.bZ.isApplied).reduce(((e,t)=>{const i=t.state.undoable;return ae.VD.isWithAlternative(i)?(0,h.zG)(i.reversedAlternative,m.g_((()=>{A.wQ.withTransformJson(t._raw)&&this._log.error("No reversed delta registered for alert",{alert:t.toLiteString()}),r(e,t)}),(0,h.ls)((e=>e()),o.UI((e=>e.delta)),o.g_((e=>{this._log.error("Could not retrieve reversed delta",{e,alert:t.toLiteString()})}),(i=>{r(e,t),(0,h.zG)(i,b.r3.fromRawDelta,(t=>t.rebase(e.reversedDelta)),m.g_((()=>{e.reversedDelta=e.reversedDelta.compose(i)}),(({delta:t})=>{e.reversedDelta=e.reversedDelta.compose(t)})))}))))):r(e,t),e}),i);return s.alertsToUpdate.length>0?(0,h.zG)(W.Y3((()=>{const e=(0,h.zG)(s.reversedDelta,te.getEnrichedWithFormattingDelta(this._getContent()));this.changes.next(K.RI.delta(e,t))}),o.KC),W.N(this._flushChanges),W.N((0,h.zG)(s.undo,O.UI(o.F2))),W.a1((0,h.zG)(s.alertsToUpdate,W.mg,W.tS(this._sendUpdate)))):W.F2(void 0)})));function r(e,r){e.undo=(0,h.ls)(e.undo,r.state.undoable.undo),e.alertsToUpdate.push(le.prepare((()=>[ie.h.create(r),ie.h.create(r.changeState(t===ae.bZ.State.Applied.Method.ByCard?ae.bZ.State.init:ae.bZ.State.Removed.create(ae.bZ.State.Removed.Reason.bulkAcceptUserResponse)))])))}},this._dismissBatch=(e,t)=>(0,h.zG)(this._flushChanges,W.a1((0,h.zG)(e,B.UI((0,h.ls)(O.of,O.UI(ce("_dismissBatch: Cannot send feedback for already disposed",t)),W.tS((e=>this._applyFeedbackToAlert(e,A.PZ.IGNORE,ae.l$.sidebar,this._commitFeedbackToCapi(e,{kind:A.PZ.IGNORE,subtype:t})))),le.prepareFromAlert)),W.mg,W.tS(this._sendUpdate)))),this._applyAlert=({alert:e,replacementText:t,source:r,method:i,feedbackSubtype:s,reason:a,gbPrompt:n})=>(0,h.zG)(e,he(ae.bZ.isRegistered,"can not apply alert in non registered state"),O.of,W.N(this._flushChanges),W.tS((e=>this._switchToBeingApplied(e,r,i))),W.tS((({beingAppliedAlert:e,undo:r})=>(0,h.zG)(e.getReplaceEither.bind(e),W.LF,W.Pd((()=>new Error("Cannot apply alert with tJSON")),(i=>{this._log.debug(`_applyAlert(${e.toLiteString()}, rrange: ${i})`);const o=i.start,d=i.end-i.start,l=(new Y.i).retain(o).delete(t.length).insert(e.replaceText);return{alert:e,undo:r,reverseDelta:l,replacementText:t,removeLen:d,feedbackSubtype:s,pos:o,reason:a,gbPrompt:n}}))))),W.tS(this._applyAlertData)),this._applyTransformJson=({alerts:e,source:t,method:r,feedbackSubtype:i,drilldownSuggestionIds:s,reason:d,gbPrompt:l})=>(0,h.zG)(this._flushChanges,W.a1((0,h.zG)(e,W.pE((e=>(0,h.zG)(e.alternative,W.UI((t=>(0,h.bc)(t,function(e){switch(e._raw.point){case"AllCapsBoldification":return b.JJ.fromAlternativeBoldified;case"Lists":return b.JJ.fromAlternativeListified;default:return b.JJ.fromAlternative}}(e.alert))))))))),W.tS((t=>W.Y3((()=>({alternatives:t,alerts:e,originalTextLength:this._positionManager.getTextLength(),currentFullText:this._getContent()})),o.KC))),W.UI(de),pe((e=>(0,h.zG)(e.correctRevAlternatives,B.UI((({alert:e,alternative:o,reversedAlternative:c})=>(0,h.zG)(this._switchToBeingApplied(e,t,r),W.mU((e=>W.dk(this._sendApplyTransformJsonFeedback(e.beingAppliedAlert,o.alternativeIndex,i,s,d,l)))),W.UI((e=>(0,n._)((0,a._)({},e),{reversedAlternative:c})))))),W.mg,W.tS((t=>(0,h.zG)(W.Y3((()=>this.changes.next(e.changeWithFormatting)),o.KC),W.N(this._flushChanges),O.a1((0,h.zG)(oe(t),W.tS(this._sendUpdate)))))))))),this._alertFeedback=(e,t,r)=>{this._log.debug(`_alertFeedback(${e.toLiteString()}, feedbackType: ${t.kind}, source: ${r})`),ae.bZ.isHidden(e)&&!ae.bZ.isLockedUIAlert(e)&&this._log.error("Sending feedback for a hidden alert",{alert:e,feedbackType:t.kind});const i=this._commitFeedbackToCapi(e,t);return(0,h.zG)(e,ce("_alertFeedback: Cannot send feedback for already disposed",t),O.of,W.tS((e=>t.kind!==A.PZ.LOOKED||e.isRead?A.nw.willRemoveAlert(t.kind)?(0,h.zG)(this._flushChanges,W.a1(this._applyFeedbackToAlert(e,t.kind,r,i)),le.prepareFromAlert,this._sendSingleUpdate):(0,h.zG)(i,W.dk):(0,h.zG)(le.prepare((()=>[ie.h.create(e),(e.isRead=!0,ie.h.create(e))])),this._sendSingleUpdate,O.N(i)))))},this._alertBatchFeedback=(e,t,r)=>(0,h.zG)(e,B.DZ((e=>e.rawId)),N.nI,m.g_((0,h.a9)(h.Q1),(e=>this._sendFeedback({kind:t,alertIds:e,subtype:r})))),this._notifyAlertUpdated=(0,h.ls)((e=>[[e[0].id,e]]),this._sendUpdate),this._releaseRef=(e,t)=>(0,h.zG)(W.Y3((()=>{this._log.debug(`_releaseRef ${e} on (${t.toLiteString()}) refs: ${t._refNames}`,{shouldBeRemoved:ae.bZ.shouldBeRemoved(t)}),ae.bZ.shouldBeRemoved(t)&&this.events.next({removed:new Map([[t.id,ie.h.create(t)]])})}),o.KC)),this._changeMuteState=(e,t)=>{const r=(0,h.zG)(e,v.T.fromArray((0,h.ls)(ce("_changeMuteState: Cannot send Mute feedback for already disposed",t),o.tS(he((e=>m.pC(e.muteCategory)||ae.bZ.belongsToAnySpecialCategory(e)),"Alert is not muting")))));return(0,h.zG)(r,v.T.foldSuccess(B.UI((e=>le.prepare((()=>[ie.h.create(e),(e.mute=t,ie.h.create(e))]))))),W.mg,W.UI(N.nI),pe(this._sendUpdate),W.UI((0,h.a9)(r)))},this._changeGapValue=(e,t)=>(0,h.zG)(e,he(ae.bZ.isOneGap,"can not change gap value for a non one gap alert"),O.of,W.tS((e=>le.prepare((()=>[ie.h.create(e),ie.h.create(e.changeGapValue(t))])))),this._sendSingleUpdate),this._confirmApplied=(0,h.ls)(B.UI((e=>le.prepare((()=>[ie.h.create(e),ie.h.create(e.changeState(ae.bZ.State.Removed.create(ae.bZ.State.Removed.Reason.bulkAcceptUserResponse)))])))),W.mg,W.tS(this._sendUpdate)),this._changeTakeawayFeedback=(e,t)=>(0,h.zG)(e,he(ae.bZ.isTakeaway,"can not change feedback for non-takeaway alert"),O.of,W.tS((e=>{const r=ie.h.create(e),i=e.setFeedback(t),s=ie.h.create(i);return(0,h.zG)(le.prepare((()=>[r,s])),this._sendSingleUpdate,W.UI((()=>i)))}))),this._shortenItSummaryNotFound=e=>(0,h.zG)(e,ce("_shortenItSummaryNotFound: Cannot change state to not-found for already disposed"),o.tS(he(ae.bZ.isShortenIt,"cannot change state to not-found for a non shorten-it alert")),O.of,W.tS((e=>{const t=ie.h.create(e),r=e.changeSummaryState("notFound"),i=ie.h.create(r);return(0,h.zG)(le.prepare((()=>[t,i])),this._sendSingleUpdate,W.UI((()=>r)))}))),this._commitShortenItSummaryRequest=e=>(0,h.zG)(e,ce("_commitShortenItSummaryRequest: Cannot send shorten_it_submit message for already disposed"),o.tS(he(ae.bZ.isShortenIt,"cannot send shorten_it_submit for a non shorten-it alert")),O.of,W.tS((e=>{const t=ie.h.create(e),r=e.changeSummaryState("requestSent"),i=ie.h.create(r);return(0,h.zG)(le.prepare((()=>[t,i])),this._sendSingleUpdate,W.UI((()=>r)),O.N(this._commitShortenItSubmitToCapi(e)))}))),this._dismissShortenItTransformGroup=(e,t)=>(0,h.zG)(e,ce("_dismissShortenItTransformGroup: Cannot dismiss transform group for already disposed",t),o.tS(he(ae.bZ.isShortenIt,"cannot dismiss transform group for a non shorten-it alert")),O.of,W.tS((e=>{const r=ie.h.create(e),i=e.dismissTransformGroup(t),s=ie.h.create(i);return(0,h.zG)(le.prepare((()=>[r,s])),this._sendSingleUpdate,W.UI((()=>i)))}))),this._changeToneAIToneAlternative=(e,t)=>(0,h.zG)(e,he(ae.bZ.isToneAI,"Cannot change tone for a non-ToneAI alert."),O.of,W.tS((e=>W.Y3((()=>{const r=[(0,h.bc)(e.id,ae.xS.create(ie.h.create(e),ie.h.create(e.setSelectedToneAlternativeIdx(t))))];return this.events.next({updated:new Map(r)}),e}),o.KC)))),this._handleCapiError=e=>t=>{V.EP.isDroppedError(t)?this._log.debug(`Stopped listening for ${e} message acknowledge`,t):V.YG.isNotConnectedError(t)?this._log.warn(`Failed to send ${e} as CAPI was not connected`,t):this._log.error(`Failed to send ${e}`,t)},this._applyAlertData=({pos:e,removeLen:t,reverseDelta:r,undo:i,replacementText:s,alert:a,feedbackSubtype:n,reason:d,gbPrompt:l})=>(0,h.zG)(W.Y3((()=>{let o=this._positionManager.getTextLength(),h=!1;const c={action:A.PZ.ACCEPTED,replacement:s,commit:()=>{h||this._log.debug(`_applyAlert(${a.toLiteString()}):commit()`)},reversedAlternative:m.YP,undo:()=>{h=!0,this._log.debug(`_applyAlert(${a.toLiteString()}):undo()`);const e=this._positionManager.getTextLength();e!==o&&this._log.error(`Text has changed while uncommitted apply is present. Expected: ${o}, actual: ${e}`);const t=K.RI.delta(r,e);this.changes.next(t),this.changes.next(K.RI.flush()),i()}};return this._sendApplyTextFeedback(a,s,n,d,l)(),this.changes.next(K.RI.delta((new Y.i).retain(e).delete(t).insert(s),o)),this.changes.next(K.RI.flush()),o=this._positionManager.getTextLength(),c}),o.KC),W.tS((e=>W.Y3((()=>a.switchToApplied(e)),o.KC))),le.prepareFromAlert,this._sendSingleUpdate),this._sendApplyFeedback=(e,t)=>e.state.method===ae.bZ.State.Applied.Method.ByCard?this._commitFeedbackToCapi(e,t):h.Q1,this._sendApplyTextFeedback=(e,t,r,i,s)=>this._sendApplyFeedback(e,{kind:A.PZ.ACCEPTED,replacementText:t,subtype:r,reason:i,gbPrompt:s}),this._sendApplyTransformJsonFeedback=(e,t,r,i,s,o)=>{const d={kind:A.PZ.ACCEPTED,alternativeIndex:t,subtype:r,drilldownSuggestionIds:i,reason:s,gbPrompt:o},l=ae.bZ.isOneGap(e)?(0,n._)((0,a._)({},d),{gapValue:e.gapValue}):ae.bZ.isShortenIt(e)?(0,n._)((0,a._)({},d),{dismissedTransformGroups:Array.from(e.dismissedTransformGroups)}):d;return this._sendApplyFeedback(e,l)}}}!function(e){e.toString=o.g_((({id:e})=>`rid:${e}`),(e=>`aid:${e.toString()}`))}(ue||(ue={})),function(e){e.match=function(e){return t=>t instanceof ae.Ev?e.alertAddOrUpdate(t):t instanceof Map?e.rangeChange(t):"_tag"in t?e.alertRemove(t):e.alertChange(t)}}(_e||(_e={})),function(e){e.defaultValidator=ae.bZ.isDuplicatedBy}(me||(me={}));class be{static _prepareUpdate(e,t){const r=(0,n._)((0,a._)({},e.toRawAlert()),{rev:t.rev});return(0,h.zG)(t.extraProperties,f.bw((e=>r.extra_properties=e))),(0,h.zG)(t.muted,f.bw((e=>r.muted=e))),A.wQ.withTransformJson(r)&&(0,h.zG)(t.transformJson,f.bw((e=>r.transformJson=e))),r}_processBatch(e){return e.reduce(((e,t)=>(_e.match({alertAddOrUpdate:t=>{(0,h.zG)(t.rawId,m.g_((()=>{e.toAdd.set(t.id,t)}),(r=>{(0,h.zG)(this._alertsRepo.getByRawAlertId(r),m.hX((e=>e.allowUpdate)),m.UI((()=>{(0,h.zG)(m.ij(e.toAddOrUpdate.get(r)),m.UI((t=>{this._log.debug("got overlap in batch on update"),e.toUpdate.delete(t.id),e.toDispose.set(t.id,t)}))),e.toUpdate.set(t.id,t)})),m.fS((()=>{(0,h.zG)(m.ij(e.toAddOrUpdate.get(r)),m.UI((t=>{this._log.info("got overlap in batch on add"),e.toAdd.delete(t.id),e.toDispose.set(t.id,t)}))),e.toAdd.set(t.id,t)}))),e.toAddOrUpdate.set(r,t)})))},rangeChange:t=>{(0,p.kG)(void 0===e.rangeChanges,"unexpected rangeChanges duplicate"),e.rangeChanges=t},alertRemove:t=>{e.toRemoveUnfiltered.push(t)},alertChange:t=>{e.toChangeUnfiltered.push(t)}})(t),e)),{toAdd:new Map,toRemoveUnfiltered:[],toChangeUnfiltered:[],toUpdate:new Map,toAddOrUpdate:new Map,rangeChanges:void 0,toDispose:new Map})}_getMergeTarget(e,t){return(0,h.zG)(e,o.LF,m.Uo,m.tS((e=>e.mergedIn)),m.tS((e=>{const r=(0,h.zG)(this._alertsRepo.getByRawAlertId(e),m.UI((e=>o.F2(e))),m.wp((()=>(0,h.zG)(m.ij(t.get(e)),m.UI((e=>o.t$(e)))))));return m.Wi(r)&&this._log.warn("Merge from CAPI: Cannot find alert to merge into.",{capiId:e}),r})),m.hX(ye((e=>!!e.allowUpdate||(this._log.warn("Merge from CAPI: Trying to merge in a non-updatable alert, skipping. ",{target:e.toLiteString()}),!1)))))}_addAlerts(e,t){return e.length>0&&this._log.debug("_addAlerts, count = "+e.length,{alerts:e.map((e=>e.toLiteString()))}),(0,h.zG)(e,B.hX(this._validateAlertAdd),B.u4({alertsToAdd:new Map,alertsToUpdate:new Map,alertsToRemove:t},((e,t)=>{this._log.trace("Adding alert: "+t.toLiteString());const r=this._getAlertsWithMatchingRanges(t.getNotEnclosingHighlightRanges()[0]),i=this._tryToMatchInvalid(t,r);switch(this._log.trace("Adding alert match result",{inc:t.id,match:i}),i.type){case fe.Type.Merged:{const r=i.result[1];ae.bZ.isNotRegistered(r.alert)?ae.bZ.isRemoved(r.alert)&&this._log.warn("unexpected merge into removed alert",{alert:r,newAlert:t}):this._alertsRepo.addToCapiMapping(r.alert),e.alertsToUpdate.set(r.id,i.result);break}case fe.Type.Restored:{const t=i.result[1];(0,p.kG)(!e.alertsToRemove.has(t.id),"can't update alert which we wanted to remove earlier"),this._alertsRepo.addToCapiMapping(t.alert),e.alertsToUpdate.set(t.id,i.result);break}case fe.Type.Unmatched:{const t=i.result,s=r.filter((r=>ae.bZ.isDuplicateCandidate(r,m.Wi(r.rawId))&&this._alertDuplicateValidator(t,r)&&!e.alertsToRemove.has(r.id)));(0,p.kG)(t.allowDuplicates||ae.bZ.isApplicableAlert(t),"BaseAlertImpl must allow duplicates or be an ApplicableAlert type");const a=t.allowDuplicates?{result:ve.Add,toRemove:m.YP}:this._tryAddAlert(t,s);switch(a.result){case ve.Add:case ve.OverwriteExisting:this._log.debug("AllAlerts: Append alert to all alerts",t.toLiteString()),this._alertsRepo.addToCapiMapping(t),(0,p.kG)(!e.alertsToRemove.has(t.id),"can't add alert which we wanted to remove earlier",(()=>t.toLiteString())),this._alertsRepo.add(t),e.alertsToAdd.set(t.id,ie.h.create(t)),(0,h.zG)(a.toRemove,f.bw((t=>{if(e.alertsToAdd.has(t.id)){this._alertsRepo.removeFromCapiMapping(t);const e=t.changeState(ae.bZ.State.Removed.create(ae.bZ.State.Removed.Reason.canceled));this._terminateAlertChecking(e),this._alertsRepo.remove(e)}else this._log.debug("schedule to remove duplicate",t.toLiteString()),e.alertsToRemove.set(t.id,{alert:t,reason:ae.bZ.State.Removed.Reason.duplicated});e.alertsToAdd.delete(t.id),e.alertsToUpdate.delete(t.id)})));break;case ve.Skip:this._log.debug("Skip alert with low priority",t.id);break;default:(0,p.vE)(a.result)}break}default:(0,p.vE)(i)}return e})))}_updateAlerts(e,t){this._log.debug(`_updateAlerts, to update = ${e.length}`,{alerts:e.map((e=>e.toLiteString()))}),(0,h.zG)(e,B.u4(t,((e,t)=>(this._log.trace("Updating alert: "+t.toLiteString()),(0,h.zG)(this._alertsRepo.getByRawAlertId(f.MH(t.rawId)),m.g_((()=>this._log.warn("tried to update unknown alert",t)),(r=>{const i=t._raw;t.dispose();const s=e.has(r.id)?e.get(r.id)[0]:ie.h.create(r);r.enqueueRawAlertForUpdate(i),e.set(r.id,ae.xS.create(s,ie.h.create(r)))}))),e))))}_startAlertsChecking(e,t,r){this._log.debug(`_startAlertsChecking, to update = ${e.length}`,{alerts:e.map((([e,t])=>[e.toLiteString(),t]))});const i=(e,t)=>{const r=e.changeState(ae.bZ.State.Registered.create(ae.bZ.CheckingState.CHECKING));return this._recheckedAlerts.add(e.id),ie.h.create(t.size>0?r.enqueueRangesRemove(t):r)};(0,h.zG)(e,B.u4({updatedAlerts:t,addedAlerts:r},((e,[t,r])=>((0,h.zG)(this._alertsRepo.getByAlertId(t.id),m.g_((()=>{this._log.warn("tried to start checking unknown alert",{alert:t,ranges:r})}),(()=>{if(e.addedAlerts.has(t.id))e.addedAlerts.set(t.id,i(t,r));else{const s=e.updatedAlerts.has(t.id)?e.updatedAlerts.get(t.id)[0]:ie.h.create(t);e.updatedAlerts.set(t.id,ae.xS.create(s,i(t,r)))}}))),e))))}_removeAlerts(e,t){e.forEach(((e,r)=>{(0,h.zG)(this._alertsRepo.getByAlertId(r),m.g_((()=>{this._log.warn("tried to remove unknown alert",e)}),(()=>(0,h.zG)(t.get(r),m.ij,m.UI(l.li),m.hX((e=>ae.bZ.isNotDisposed(e.alert))),m.wp((()=>(0,h.zG)(e.alert,m.DT(ae.bZ.isNotDisposed),m.UI(ie.h.create)))),f.bw((i=>{const s=this._applyRemoveToAlert(e);this._terminateAlertChecking(s),t.set(r,ae.xS.create(i,ie.h.create(s)))}))))))}))}_getAlertsWithMatchingRanges(e){return(0,h.zG)(this._positionManager.findIntersections(e),B.hX((0,u.W9)(Z.P.is,Z.x.isVisible)),B.hX((0,u.ff)(Z.x.isEnclosingView)),B.DZ((e=>this._alertsRepo.getByAlertId(e.meta.alertId))),B.hX((e=>!(ae.bZ.isApplied(e)&&e.getAppliedRanges().length>0))))}_tryToMatchInvalid(e,t){return(0,p.kG)(!e.isValid,"added alert should be invalid"),(0,p.kG)(ae.bZ.isRegistered(e),"added alert should be in registered state",(()=>e.toString())),(0,h.zG)(m.ij(t.find((t=>!t.isValid&&t.canBeMergedWith(e)))),m.g_((()=>({result:e,type:fe.Type.Unmatched})),(t=>{(0,p.kG)((0,h.zG)(t.rawId,f.wo((0,h.ls)(this._alertsRepo.getByRawAlertId,m.Wi))),"CAPI mapping should not contain invalid alerts"),this._log.debug(`Merging new alert (${e}) into the existing one aid(${t})`);const r=ie.h.create(t);return t.patchWithRawAlert(e._raw),e.dispose(),t.allowUpdate&&ae.bZ.isCapiDone(t)?{result:ae.xS.create(r,ie.h.create(t.changeState(ae.bZ.State.init))),type:fe.Type.Restored}:{result:ae.xS.create(r,ie.h.create(t)),type:fe.Type.Merged}})))}_tryAddAlert(e,t){return(0,h.zG)(N.nI(t),m.UI((t=>{(0,p.kG)(1===t.length,"Only one visible alert to one range is expected while _tryEnqueueAlert",`got ${t.map((e=>e.toString()))} with input (${e.toString()})`);const r=t[0];return r.extraProperties.priority<=e.extraProperties.priority?{result:ve.OverwriteExisting,toRemove:m.G(r)}:(e.dispose(),{result:ve.Skip,toRemove:m.YP})})),m.fS((()=>({result:ve.Add,toRemove:m.YP}))))}_cleanupPendingAlerts(e){e.removed.forEach((e=>{this._heuristicallyRemovedAlerts.delete(e)&&this._log.info("unexpected alert remove from finish msg",e)})),this._heuristicallyRemovedAlerts.size>0&&this._log.debug("we had heuristically removed alerts which were not confirmed by capi",{size:this._heuristicallyRemovedAlerts.size}),this._heuristicallyRemovedAlerts.clear()}_finishAlertsChecking(){return(0,h.zG)(Array.from(this._recheckedAlerts.values()),B.DZ((e=>{const t=this._alertsRepo.getByAlertId(e);m.Wi(t)&&(this._log.error("tried to finish checking on missing alert",e),this._recheckedAlerts.delete(e));const r=(0,h.zG)(t,m.hX((e=>ae.bZ.isRegistered(e))),m.UI((e=>(0,h.bc)(e.id,this._finishAlertChecking(e)))));return m.Wi(r)&&this._log.error("tried to update checking state on non-registered alert",e),r})),(e=>({updated:new Map(e)})))}constructor(e,t,r){(0,s._)(this,"_positionManager",void 0),(0,s._)(this,"_alertsRepo",void 0),(0,s._)(this,"_alertDuplicateValidator",void 0),(0,s._)(this,"_log",void 0),(0,s._)(this,"_heuristicallyRemovedAlerts",void 0),(0,s._)(this,"process",void 0),(0,s._)(this,"reset",void 0),(0,s._)(this,"_processAlertsBatch",void 0),(0,s._)(this,"_collectChanges",void 0),(0,s._)(this,"_validateAlertAdd",void 0),(0,s._)(this,"_recheckedAlerts",void 0),(0,s._)(this,"_terminateAlertChecking",void 0),(0,s._)(this,"_applyRemoveToAlert",void 0),(0,s._)(this,"_finishAlertChecking",void 0),this._positionManager=e,this._alertsRepo=t,this._alertDuplicateValidator=r,this._log=_.C8.Logging.getLogger("AlertManager.pipeline",_.zW.i.DEBUG),this._heuristicallyRemovedAlerts=new Map,this.process=e=>(this._log.trace(`process, to process = ${e.length}`),this._collectChanges(this._processAlertsBatch(e))),this.reset=e=>(this._cleanupPendingAlerts(e),this._finishAlertsChecking()),this._processAlertsBatch=e=>{const{toAdd:t,toUpdate:r,toAddOrUpdate:i,toRemoveUnfiltered:s,toChangeUnfiltered:a,toDispose:n,rangeChanges:d}=this._processBatch(e),l=e=>(0,h.zG)(this._alertsRepo.getByAlertId(e),m.fS((()=>t.get(e)||r.get(e)||n.get(e))));a.forEach((e=>(0,h.zG)(m.ij(i.get(e.id)),m.g_((()=>(0,h.zG)(this._alertsRepo.getByRawAlertId(e.id),m.UI((t=>{const s=t.copy(!1),a=be._prepareUpdate(s,e);m.pC(e.transformJson)?s.updateAlertWithManagedData(a):s.patchWithRawAlert(a),r.set(s.id,s),i.set(e.id,s)})),m.fS((()=>this._log.info("Change from CAPI: Cannot find internal AlertId."))))),(t=>{const i=be._prepareUpdate(t,e);r.has(t.id)?t.patchWithRawAlert(i):t.updateAlertWithManagedData(i)})))));const c=s.reduce(((e,s)=>{const a=(0,h.zG)(s,o.g_((({id:e})=>(0,h.zG)(this._alertsRepo.getByRawAlertId(e),m.UI((e=>ae.bZ.isRegistered(e)?e:void 0)),m.fS((()=>this._heuristicallyRemovedAlerts.has(e)?void this._heuristicallyRemovedAlerts.delete(e):i.get(e))))),l));return void 0===a?(o.nM(s)?this._log.debug("Remove from CAPI: Cannot find internal AlertId. capiId: #"+JSON.stringify(s.left)):this._log.error("Cannot find existing alert by id",s.right),e):((0,h.zG)(this._getMergeTarget(s,i),m.hX(ye((e=>e.lensId!==a.lensId?(this._log.warn("Trying to merge alerts from different lenses",{source:a,target:e}),!1):m.Wi(a.rawId)?(this._log.warn("Trying to merge into local alert",{source:a,target:e}),!1):a.references>e.references))),m.g_((()=>{e.set(a.id,{alert:a,reason:(0,h.zG)(s,o.LF,m.Uo,m.tS((e=>e.hint)),m.tS((e=>e===y.AF.NotFixed?m.G(ae.bZ.State.Removed.Reason.capiDismiss):m.YP)),m.fS((()=>ae.bZ.State.Removed.Reason.capiDone)))})}),o.g_((e=>{this._log.debug("swap raw alerts with new alert",{source:a.toString(),newTarget:e.toString()}),this._alertsRepo.swapRaw(a,e);const s=f.MH(a.rawId);(0,p.kG)(void 0===r.get(e.id),"Added alert should not be present in the updated alerts map",(()=>r.get(e.id).toString()));const o=a.copy();r.set(o.id,o),i.set(s,o),t.delete(e.id),n.set(e.id,e)}),(t=>{this._log.debug("swap raw alerts with existing alert",{source:a.toString(),existingTarget:t.toString()}),this._alertsRepo.swapRaw(a,t),e.set(t.id,{alert:t,reason:ae.bZ.State.Removed.Reason.capiDismiss})})))),e)}),new Map),g=new Map;return d&&d.forEach(((e,t)=>{(0,h.zG)(t,l,m.DT((i=>i?ae.bZ.isInteractable(i)?!r.has(i.id)||(this._log.debug("skip range change on updateHolder alert",i.toLiteString()),!1):(this._log.debug("skip range change on non-interactable alert",i.toLiteString()),!1):(this._log.warn("got range changes for unknown alert",{alertId:t,alertRanges:e}),!1))),m.tS((r=>(0,h.zG)(r.onRangeChange(e),m.UI((e=>{switch(e.state){case ae.bZ.Transition.State.Pending:return g.set(r.id,[r,e.removedRanges]);case ae.bZ.Transition.State.Dispose:return(0,h.zG)(r.rawId,m.g_((()=>this._log.debug("dispose by range change on unknown rid",r.id)),(e=>this._heuristicallyRemovedAlerts.set(e,r)))),c.set(t,{alert:r,reason:ae.bZ.State.Removed.Reason.textChange});default:return(0,p.vE)(e)}}))))))})),c.forEach((({alert:e})=>{this._log.trace("check cancellations from toRemove: "+e.toLiteString()),(0,h.zG)(e.rawId,m.g_((()=>{t.get(e.id)&&(this._log.debug("cancel add local alert for: "+e.toLiteString()),t.delete(e.id),c.delete(e.id),n.set(e.id,e)),(0,p.kG)(!1===r.has(e.id),"Added local alert should not be present in the updated alerts map",(()=>r.get(e.id).toString()))}),(s=>{const a=i.get(s);a&&(i.delete(s),t.delete(a.id)?(this._log.debug("cancel add for: "+a.toLiteString()),this._log.debug("cancel remove for: "+e.toLiteString()),c.delete(e.id),n.set(e.id,e),n.set(a.id,a)):r.delete(a.id)?(this._log.debug("cancel update for: "+a.toLiteString()),a.id!==e.id&&(this._log.debug("marking update to dispose: "+a.toLiteString()),n.set(a.id,a))):this._log.error("_addOrUpdateAlert toAdd || toUpdate mapping in unsync state!",a))}))),this._log.trace("check if local orphan toRemove: "+e.toLiteString()),(0,h.zG)(this._alertsRepo.getByAlertId(e.id),m.g_((()=>{this._log.debug("cancel delete for: "+e.toLiteString()),c.delete(e.id)}),h.Q1))})),n.size>0&&this._log.debug(`_cancelAlerts, to cancel = ${n.size}`,{alerts:Array.from(n.values()).map((e=>e.toLiteString()))}),n.forEach((e=>{g.delete(e.id)&&this._log.debug("cancel startChecking for: "+e.toLiteString());try{e.dispose()}catch(t){this._log.warn("unexpected error on disposing canceled alert",t,e)}})),{toAdd:t,toUpdate:r,toRemove:c,toStartChecking:g}},this._collectChanges=({toAdd:e,toUpdate:t,toRemove:r,toStartChecking:i})=>{const{alertsToAdd:s,alertsToUpdate:a,alertsToRemove:n}=this._addAlerts(Array.from(e.values()),r);return t.size>0&&this._updateAlerts(Array.from(t.values()),a),i.size>0&&this._startAlertsChecking(Array.from(i.values()),a,s),n.size>0&&this._removeAlerts(n,a),{added:s,updated:a}},this._validateAlertAdd=e=>{try{const t=!ae.bZ.isPremium(e)||void 0!==e.categoryHuman;return e._raw.impact!==A.wQ.Impact.Critical&&e._raw.impact!==A.wQ.Impact.Advanced&&m.pC(e.rawId)&&this._log.warn("CAPI provides corrupted impact prop",{alert:e,raw:A.wQ.clearUserTextFields(e._raw)}),t||(this._log.error("CAPI provides corrupted alert",{alert:e,raw:A.wQ.clearUserTextFields(e._raw)}),e.dispose()),(0,h.zG)(e.rawId,m.Gg((e=>m.pC(this._alertsRepo.getByRawAlertId(e)))))?(this._log.warn("unexpected overlap on rawId for non-updatable alert",{alert:e,raw:A.wQ.clearUserTextFields(e._raw)}),e.dispose(),!1):e.lensType===P.R.Type.Plagiarism&&F.T.isMax(e.progress)?(this._log.info("CAPI provides a Plagiarism alert with an invalid progress",{alert:e,raw:A.wQ.clearUserTextFields(e._raw)}),e.dispose(),!1):t}catch(t){this._log.error("Cannot validate alert",t);try{e.dispose()}catch(e){this._log.warn("Cannot dispose invalid alert",e)}return!1}},this._recheckedAlerts=new Set,this._terminateAlertChecking=({id:e})=>{this._recheckedAlerts.delete(e)&&this._log.debug("Stopped watching checking state for alert",e)},this._applyRemoveToAlert=({alert:e,reason:t})=>(this._alertsRepo.removeFromCapiMapping(e),t!==ae.bZ.State.Removed.Reason.textChange&&t!==ae.bZ.State.Removed.Reason.duplicated&&e.clearCapiId(),e.changeState(ae.bZ.State.Removed.create(t))),this._finishAlertChecking=e=>{(0,p.kG)(this._recheckedAlerts.delete(e.id),"tried to finish checking on alert which had not been marked as checking"),this._log.debug("Stopped watching checking state for alert",e.id);const t=ie.h.create(e);return ae.xS.create(t,ie.h.create(e.changeState(ae.bZ.State.Registered.create(ae.bZ.CheckingState.IDLE))))}}}function ye(e){return o.g_(e,e)}!function(e){let t;!function(e){e.Unmatched="Unmatched",e.Merged="Merged",e.Restored="Restored"}(t=e.Type||(e.Type={}))}(fe||(fe={})),function(e){e.Skip="Skip",e.Add="Add",e.OverwriteExisting="OverwriteExisting"}(ve||(ve={}));var Se=r(94579),we=r(48148);class Ce{flushAlerts(){this._flush.next()}loadAlerts(e){const t=new Map;return(0,u.Dw)(e)&&(this._log.debug(`${e.length} external alert(s) where loaded`),e.map(we.I.splitById).map((({id:e,local:t})=>({id:e,alert:ae.bZ.create((0,h.zG)(t,A.wQ.matchBy(h.yR,(e=>(0,n._)((0,a._)({},e),{transformJson:{highlights:e.transformJson.highlights,alternatives:(0,h.zG)(e.transformJson.alternatives,m.UI(b.r3.Group.fromSerialized))}})),h.yR),this._transformRawAlert),this._ops,this._positionManager,this._alternativeManager)}))).forEach((({id:e,alert:r})=>{this._addAlertBuffered(r),e&&t.set(e,r.id)}))),t}toString(){return JSON.stringify(this,void 0,2)}toJSON(){return{repo:this._alertsRepository}}dispose(){this._subs.forEach((e=>e.unsubscribe())),this._subs=[]}_getTypeFilter(e){switch(e){case"alert":return e=>!ae.bZ.isPlagiarism(e);case"plagiarism":return e=>ae.bZ.isPlagiarism(e);default:return(0,p.vE)(e)}}_addAlertBuffered(e){this._log.trace(`_addAlert(${e.toLiteString()})`),this._addAlerts.next(e)}_handleFreePremium(e){this._log.trace(`_handleFreePremium(${e.id})`),Boolean(e.updatable)&&(0,h.zG)(this._alertsRepository.getByRawAlertId(e.id),m.hX(ae.bZ.isNotDisposed),f.bw((()=>this._removeAlertBuffered(o.t$({id:e.id,mergedIn:m.YP,hint:m.YP})))));const t=ae.bZ.create(this._transformRawAlert(e),this._ops,this._positionManager,this._alternativeManager);this.flushAlerts(),this._freePremiumAlerts.next(t),this.flushAlerts()}_changeAlertBuffered(e){this._log.trace(`_changeAlert(${e.id})`),this._changeAlerts.next(e)}_removeAlertBuffered(e){this._log.trace(`_removeAlert(${ue.toString(e)})`),this._removeAlerts.next(e)}_getAllAlertsAsArray(){return this._alertsRepository.toArray().filter(ae.bZ.isNotRemoved)}constructor(e,t,r,a,n,p,f,A=me.defaultValidator,b=new Se.a,M=e.rangeChanged){(0,s._)(this,"_positionManager",void 0),(0,s._)(this,"_alternativeManager",void 0),(0,s._)(this,"_getContent",void 0),(0,s._)(this,"_capiEvents",void 0),(0,s._)(this,"_capiClient",void 0),(0,s._)(this,"_documentCounters",void 0),(0,s._)(this,"_transformRawAlert",void 0),(0,s._)(this,"_alertDuplicateValidator",void 0),(0,s._)(this,"_alertsRepository",void 0),(0,s._)(this,"rangeChanged",void 0),(0,s._)(this,"_state",void 0),(0,s._)(this,"state",void 0),(0,s._)(this,"lensesScores",void 0),(0,s._)(this,"_log",void 0),(0,s._)(this,"_subs",void 0),(0,s._)(this,"_addAlerts",void 0),(0,s._)(this,"_removeAlerts",void 0),(0,s._)(this,"_changeAlerts",void 0),(0,s._)(this,"_freePremiumAlerts",void 0),(0,s._)(this,"_flush",void 0),(0,s._)(this,"_alertsPerRevision",void 0),(0,s._)(this,"_ops",void 0),(0,s._)(this,"_pipeline",void 0),(0,s._)(this,"changes",void 0),(0,s._)(this,"loadScores",void 0),(0,s._)(this,"undoApplied",void 0),(0,s._)(this,"_invalidateAlerts",void 0),(0,s._)(this,"_removeInvalidAlerts",void 0),(0,s._)(this,"_onCapiEvent",void 0),(0,s._)(this,"_emitDomainEvent",void 0),(0,s._)(this,"_prepareDiff",void 0),(0,s._)(this,"_disposeAlert",void 0),this._positionManager=e,this._alternativeManager=t,this._getContent=r,this._capiEvents=a,this._capiClient=n,this._documentCounters=p,this._transformRawAlert=f,this._alertDuplicateValidator=A,this._alertsRepository=b,this.rangeChanged=M,this._state=g.h.create(R.r.empty),this.state=this._state.view(R.r.toCheckingResult),this.lensesScores=g.h.create(z.empty),this._log=_.C8.Logging.getLogger(Ce.loggerName,_.zW.i.TRACE,_.zW.T.Manager.getColor()),this._subs=[],this._addAlerts=new S.Subject,this._removeAlerts=new S.Subject,this._changeAlerts=new S.Subject,this._freePremiumAlerts=new S.Subject,this._flush=new S.Subject,this._alertsPerRevision=0,this._pipeline=new be(this._positionManager,this._alertsRepository,this._alertDuplicateValidator),this._invalidateAlerts=()=>{this.flushAlerts();const[e,t]=(0,c.uK)(this._getAllAlertsAsArray(),(e=>e.isValid));this._log.debug("Invalidate alerts...",{valid:e.length,invalid:t.length}),e.forEach((e=>{this._alertsRepository.removeFromCapiMapping(e),e.clearCapiId()})),t.forEach((e=>e.clearCapiId()))},this._removeInvalidAlerts=e=>{this._log.debug(`Removing invalid alerts by type '${e}'...`);const t=this._getTypeFilter(e),r=this._getAllAlertsAsArray().filter((e=>!e.isValid&&ae.bZ.isNotDisposed(e)&&ae.bZ.isRegistered(e)&&t(e)));r.forEach((e=>this._removeAlertBuffered(o.F2(e.id)))),this._log.debug(`${r.length} invalid alerts removed`),this.flushAlerts(),this._log.isEnabled(_.zW.i.TRACE)&&this._log.trace("Removed alerts",r.map((e=>e.toString())))},this._onCapiEvent=e=>{try{switch("alert_received"===e.kind&&this._alertsPerRevision++,e.kind){case"alert_received":case"plagiarism_alert_received":if(!1===e.alert.hidden&&void 0===e.alert.cardLayout)return void this._log.warn("got alert with empty mapping",{pname:e.alert.pname});"unlocked"===e.alert.extra_properties.free_premium?this._handleFreePremium(e.alert):this._addAlertBuffered(ae.bZ.create(this._transformRawAlert(e.alert),this._ops,this._positionManager,this._alternativeManager));break;case"alert_removed":this._log.debug(`Remove from capi #${e.alertId}, merged in #${m.fS((()=>"None"))(e.mergedIn)}, hint: ${m.fS((()=>"None"))(e.hint)}`);(0,h.zG)(this._alertsRepository.getByRawAlertId(e.alertId),m.Gg(ae.bZ.isBulkApplied))||this._removeAlertBuffered(o.t$({id:e.alertId,mergedIn:e.mergedIn,hint:e.hint}));break;case"alert_changed":this._log.debug("Alert change from capi #"+e.alertId),this._changeAlertBuffered({id:e.alertId,rev:e.rev,extraProperties:m.ij(e.extraProperties),transformJson:m.ij(e.transformJson),muted:m.ij(e.muted)});break;case"finish":this._log.debug(`Alerts per revision (#${e.revision}): ${this._alertsPerRevision}`),this._alertsPerRevision=0,"idle"===this._capiClient.checkingState&&this._emitDomainEvent(this._pipeline.reset(e))}}catch(t){_.jI.isErrorLike(t)?this._log.error("Cannot handle CAPI event.",t,{capiEvent:e}):this._log.error("Cannot handle CAPI event.",{capiEvent:e,error:t})}},this._emitDomainEvent=e=>{(0,h.zG)(e,this._prepareDiff,k.v.createDiff,v.T.recover((e=>this._log.error("conflicts on diff creating",e))),(e=>(this._log.debug("_emitDomainEvent",I.p.Diff.show.show(e)),e)),R.r.applyDiff,d.UI(v.T.recover((e=>this._log.error("conflicts on diff apply",e)))),(e=>this._state.modify(e)))},this._prepareDiff=({added:e,updated:t=new Map,removed:r=new Map})=>(t.forEach(((e,i)=>{(0,h.zG)(e,l.Yg,ae.bZ.fromAlertModel,ae.bZ.shouldBeRemoved)&&(t.delete(i),r.set(i,e[0]))})),r.forEach((0,h.ls)(ae.bZ.fromAlertModel,this._disposeAlert)),{added:e,updated:t,removed:r}),this._disposeAlert=e=>{if(ae.bZ.isApplied(e)&&e.state.undoable.commit(),ae.bZ.isNotRegistered(e))try{this._alertsRepository.remove(e)}catch(t){this._log.error("Cannot remove alert.",t),ae.bZ.isNotDisposed(e)&&e.dispose()}else this._log.error("unexpected remove of registered alert",e.toString())},this._ops=new Ae(this._positionManager,this._getContent,this._capiClient,this._alertsRepository),this.loadScores=e=>{this.lensesScores.set(e)},this.undoApplied=this._ops.undoApplied,this.changes=this._ops.changes;const T=this.rangeChanged.pipe(S.map((({affected:e})=>e)),S.filter((e=>e.length>0)),S.map((e=>w.vM((e=>e.meta.alertId),e.filter(Z.P.is)))),S.filter((e=>e.size>0)),S.tap((e=>this._log.debug("Range[s] changed",e))),S.share()),G=S.interval(250).pipe(S.startWith(0),S.merge(this._flush)),U=C.RX(this._log);this._subs.push(U("_alertsInvalidation",this._capiEvents.pipe(S.filter((e=>y.hX.is("session_started")(e)&&e.isNewSession)),S.tap(this._invalidateAlerts),S.switchMapTo(S.mergeStatic(this._capiEvents.pipe(S.filter(y.hX.is("finish")),S.take(1),S.mapTo("alert")),this._capiEvents.pipe(S.filter(y.hX.is("async_check_finished")),S.take(1),S.mapTo("plagiarism")))),S.tap(this._removeInvalidAlerts))),U("_capiEvents",this._capiEvents.pipe(S.tap(this._onCapiEvent))),U("_alertsProccesing",this._addAlerts.pipe(S.merge(this._freePremiumAlerts),S.merge(this._removeAlerts),S.merge(this._changeAlerts),S.merge(T),S.buffer(G),S.filter(u.Dw),S.map(this._pipeline.process),S.tap(this._emitDomainEvent))),U("_alertsBuffer",T.pipe(S.merge(this._capiEvents.pipe(S.filter(y.hX.is("before_finish","before_async_check_finish","async_check_finished")))),S.mapTo(C.PU),S.tap((e=>this._flush.next(e))))),U("_alertOpsAlertChanges",this._ops.events.pipe(S.tap(this._emitDomainEvent))),U("_lensesScoresChanges",z.fromCapi(this._capiEvents).pipe(S.tap(C.wW(this.lensesScores)))),U("documentCountersChanges",i.fromAlerts(this._state.view(k.v.iso.wrap)).pipe(S.tap(C.wW(this._documentCounters))))),(0,u.iR)("alerts",(()=>this.toString())),(0,u.iR)("triggerRemove",(e=>{this._removeAlertBuffered(o.F2(e))}))}}(0,s._)(Ce,"loggerName","AlertManager")},75708:(e,t,r)=>{r.d(t,{e:()=>i});var i,s=r(58303),a=r(61179),n=r(90023),o=r(42203),d=r(7378),l=r(55812);!function(e){e.create=function(e){const t=t=>(0,n.zG)(e.get(),d.p.get(t),s.UI(l.bZ.fromAlertModel)),r=e=>(0,n.zG)(t(e),s.hX(l.bZ.isInteractable)),i=e=>(0,n.zG)(t(e),s.hX(l.bZ.isRegistered)),h=(0,n.ls)(i,s.hX((0,o.W9)(l.bZ.isNotDisposed,(0,a.ff)(l.bZ.isInPremiumLens),(0,a.ff)(l.bZ.isHidden)))),c=(0,n.ls)(h,s.pC);return{getById:t,getRegistered:i,getInteractable:r,getValidForFeedback:h,isValidForFeedback:c,isRegistered:e=>(0,n.zG)(i(e),s.pC),isInteractable:e=>(0,n.zG)(r(e),s.pC)}}}(i||(i={}))},85443:(e,t,r)=>{r.d(t,{k:()=>m});var i=r(12533),s=r(59833),a=r(12518),n=r(51505),o=r(24332),d=r(58303),l=r(86399),h=r(90023),c=r(64443),p=r(19659),g=r(32486),u=r(8907),_=r(55812);class m{apply(e,t){const{alternativeIndex:r,source:i}=t;return this._log.trace("apply",e),(0,h.zG)(this._findAlert(e),a.tS(a.DT(_.bZ.isApplicableAlert,(()=>new Error("cannot apply not applicable alert")))),a.tS((e=>(0,h.zG)(p.vM((()=>e.apply(t))),a.Vn((t=>(this._log.error("apply single alert error",{error:t,alert:e.toLiteAlert(),alternativeIndex:r,source:i}),t)))))))}applyBulk(e,t){this._log.trace("applyBulk",e),this.sendBatchFeedback(e,u.DI.BULK_ACCEPTED,t);const r=(0,h.zG)(e,g.T.fromArray((e=>(0,h.zG)(this._findAlert(e),a.Vn((t=>(0,h.bc)(t,{id:e}))),a.tS(a.DT(_.bZ.isRegisteredApplicableAlert,(e=>(0,h.bc)(new Error("cannot apply not applicable or non-registered alert"),e.toLiteAlert())))),a.tS(a.DT((e=>u.wQ.withTransformJson(e._raw)),(e=>(0,h.bc)(new Error("Only alerts with transformJSON can be bulk applied"),e.toLiteAlert())))),a.Vn((([e,t])=>(this._log.error(e.message,t),e)))))));return(0,h.zG)(r,g.T.flatMap(s.uZ(),(e=>(0,h.zG)(this._ops._applyTransformJson({alerts:e.map((e=>({alert:e,alternative:_.bZ.getApplicableAlternative(e,0)}))),source:_.l$.api,method:_.bZ.State.Applied.Method.Bulk,feedbackSubtype:t}),n.g_((t=>()=>(this._log.error("applyBulk error",t),g.T.of([],e.map((e=>e.id))))),(()=>()=>g.T.of(e.map((e=>e.id))))))())))}confirmApplied(e){return this._log.trace("commitApplied",e),(0,h.zG)(e,g.T.fromArray((0,h.ls)(this._findAlert,a.UI(_.Ev.castApplied))),a.Vn((e=>new Error(`Error on trying to confirm applied alerts: ${e.rejected.join(",")}`))),a.tS((e=>this._ops._confirmApplied(e)())))}dismissBatch(e,t){return this._log.trace("dismissBatch",e),(0,h.zG)(e.map((0,h.ls)(this._findAlert,a.UI((e=>[e])))),(0,o.g_)(v),a.tS((e=>this._ops._dismissBatch(e,t)())))}applyFeedback(e,t,r){return this._log.trace("sendFeedback",{alertId:e,type:t.kind}),(0,h.zG)(this._findAlert(e),a.tS((e=>this._ops._alertFeedback(e,t,r)())))}sendBatchFeedback(e,t,r){return this._log.trace("sendBatchFeedback",{alertIds:e,type:t}),(0,h.zG)(e,g.T.fromArray(this._findAlert),g.T.tapFailure((e=>this._log.error("Cannot send batch feedback for alerts",e.rejected))),g.T.foldSuccess((e=>a.F2(this._ops._alertBatchFeedback(e,t,r)()))))}takeReference(e,t){return this._log.trace("takeReference",{alertId:e.id,from:t}),(0,h.zG)(this._findAlert(e.id),a.tS((e=>e.takeReference(t))))}changeMuteState(e,t){return this._log.trace("changeMuteState",e),(0,h.zG)(e,g.T.fromArray((e=>this._findAlert(e.id))),g.T.flatMap(s.uZ(),(e=>(0,h.zG)(this._ops._changeMuteState(e,t)(),a.Vn((e=>(this._log.error("Can not change mute state",e),e))),p.MH))))}changeGapValue(e,t){return(0,h.zG)(this._findAlert(e),a.tS((e=>this._ops._changeGapValue(e,t)())))}changeTakeawayFeedback(e,t){return(0,h.zG)(this._findAlert(e),a.tS((e=>this._ops._changeTakeawayFeedback(e,t)())))}shortenItSummaryNotFound(e){return(0,h.zG)(this._findAlert(e),a.tS((e=>this._ops._shortenItSummaryNotFound(e)())))}sendShortenItSummaryRequest(e){return(0,h.zG)(this._findAlert(e),a.tS((e=>this._ops._commitShortenItSummaryRequest(e)())))}dismissShortenItTransformGroup(e,t){return(0,h.zG)(this._findAlert(e),a.tS((e=>this._ops._dismissShortenItTransformGroup(e,t)())))}changeToneAIToneAlternative(e,t){return(0,h.zG)(this._findAlert(e),a.tS((e=>this._ops._changeToneAIToneAlternative(e,t)())))}constructor(e,t){(0,i._)(this,"_alertsReader",void 0),(0,i._)(this,"_ops",void 0),(0,i._)(this,"_log",void 0),(0,i._)(this,"_findAlert",void 0),(0,i._)(this,"undoBulk",void 0),(0,i._)(this,"getHighlightRanges",void 0),(0,i._)(this,"hasNewRangesForUpdate",void 0),(0,i._)(this,"applyPendingRangesUpdate",void 0),(0,i._)(this,"getAppliedRanges",void 0),this._alertsReader=e,this._ops=t,this._log=c.C8.Logging.getLogger("AlertsServiceImpl"),this._findAlert=e=>(0,h.zG)(e,this._alertsReader.getById,a.Yo((()=>new Error(`alert ${e} not found in the repo`)))),this.undoBulk=(0,h.ls)(l.DZ((0,h.ls)(this._alertsReader.getById,d.hX(_.bZ.isBulkApplied))),(e=>this._ops.undoApplied(e,_.bZ.State.Applied.Method.Bulk)()),a.fS((e=>{throw this._log.error("Could not undo bulk-applied alerts",e),e}))),this.getHighlightRanges=(0,h.ls)(this._findAlert,a.UI((e=>e.getHighlightRanges()))),this.hasNewRangesForUpdate=(0,h.ls)(this._findAlert,a.UI((e=>e.hasNewRangesForUpdate))),this.applyPendingRangesUpdate=(0,h.ls)(this._findAlert,a.UI((e=>e.applyPendingRangesUpdate()))),this.getAppliedRanges=(0,h.ls)(this._alertsReader.getById,a.Yo((()=>new Error("alert not found in the repo"))),a.Y$(_.bZ.isApplicableAlert,(e=>new Error(`alert is not applicable: ${e.alertType}`))),a.UI((e=>e.getAppliedRanges())))}}const f=s.uZ(),v=(0,a.$4)(f)},98162:(e,t,r)=>{r.d(t,{R:()=>a});var i=r(68291),s=r(81933);class a{static init(e,t,r,i,n,o){const d=new s.Subject;return new a(e,t,r,i,n,o,d),d}constructor(e,t,r,i,s,n,o){const d=a.NamedChangesSink.factory(o),l={pm:d(a.Receiver.PM,i),dm:d(a.Receiver.PM,s),capi:d(a.Receiver.CAPI,r),userTextEcho:d(a.Receiver.UserText,e)};a.Producer.create(a.Producer.UserText,{changes:e.changes})(l.dm,l.pm,l.capi),a.Producer.create(a.Producer.ALERT_APPLY,n)(l.userTextEcho),t.subscribe((t=>{"before_alert"===t.kind&&e.flushChanges()}))}}!function(e){let t,r,s,a;!function(e){e.DEd="denali_editor",e.UserText="user_text",e.DOX="remote_document",e.ALERT_APPLY="alert_synonyms_manager"}(t=e.Producer||(e.Producer={})),function(e){e.create=function(e,t){return(...r)=>t.changes.subscribe((t=>{r.forEach((r=>r.pushChanges(e,t)))}))}}(t=e.Producer||(e.Producer={})),function(e){e.DEd="denali_editor",e.UserText="user_text",e.DOX="remote_document",e.CAPI="checking_service",e.PM="position_manager"}(r=e.Receiver||(e.Receiver={})),function(e){function t(e,t,r){return{pushChanges:(s,a)=>{try{let n=t.pushChanges(a);"function"==typeof n&&(n=i.Vi(n)),void 0!==n&&n.catch((t=>r.next({exception:t,details:{from:s,to:e}})))}catch(t){r.next({exception:t,details:{from:s,to:e}})}}}}e.factory=function(e){return(r,i)=>t(r,i,e)},e.create=t}(s=e.NamedChangesSink||(e.NamedChangesSink={})),function(e){e.create=e=>({changes:e.changes,pushChanges(t){e.pushChanges(t,"user")},getContents:()=>e.getContents(),flushChanges:()=>e.flushChanges()})}(a=e.UserTextChangesSync||(e.UserTextChangesSync={}))}(a||(a={}))},71255:(e,t,r)=>{r.d(t,{Av:()=>s,nR:()=>i});var i,s,a,n=r(37159),o=r(96705),d=r(67177),l=r(90023),h=r(71576),c=r(43789),p=r(81933);!function(e){e.noopSync={pushChanges:l.Q1};e.ignoreResult=function(e){return{pushChanges:t=>{e.pushChanges(t)}}},e.ignoreTEResult=function(e){return{pushChanges:(0,l.ls)(e.pushChanges,d.UI(l.Q1))}},e.pushDeleteThenInsert=function(e){return{pushChanges:t=>{(c.RI.isDelta(t)?c.RI.fromArrayOfDeltas(h.s.splitToDeleteThenInsert(t.delta).filter(h.s.nonEmpty),t.prevLen):[t]).forEach((t=>e.pushChanges(t)))}}}}(i||(i={})),function(e){e.merge=function(e){return{changes:p.mergeStatic(...e.map((e=>e.changes)))}}}(s||(s={})),function(e){e.noopSync=e=>(0,o._)((0,n._)({},i.noopSync),{changes:p.of(e)})}(a||(a={}))},78398:(e,t,r)=>{r.d(t,{J:()=>i});var i,s=r(37159),a=r(96705),n=r(59833),o=r(12518),d=r(58303),l=r(14944),h=r(61179),c=r(18397),p=r(67177),g=r(90023),u=r(13391),_=r(64443),m=r(2245),f=r(5175),v=r(8907),A=r(45676),b=r(81933),y=r(88012),S=r(2187),w=r(55812),C=r(84146);!function(e){let t,r,i;!function(e){let t;!function(e){e.ord=l.r9,e.show=c._3,e.create=e=>e}(t=e.Id||(e.Id={}));e.isSpecial=e=>Object.values(v.JW.SpecialCategory).includes(e),e.specialCategoryDescription="Special category"}(t=e.Category||(e.Category={})),function(e){e.filter=e=>m.hX((t=>e(t.id))),e.filterWithCount=(e,t)=>r=>{const i=Array.from(r.keys()),n=C.k.getAlerts(t,i).byCategory;return(0,g.zG)(r,m.DZ((t=>e(t.id)?d.G((0,a._)((0,s._)({},t),{alertsCount:n.get(t.id).filter(w.bZ.isRegistered).length})):d.YP)))}}(r=e.BaseMutedCategories||(e.BaseMutedCategories={})),function(e){let i,s;!function(e){let t;!function(e){e.CategoriesChanged="CategoriesChanged"}(t=e.Type||(e.Type={})),e.isChangedEvent=function(e){return e.type===t.CategoriesChanged}}(i=e.Events||(e.Events={})),e.create=function(e,s,a,l,c){const m=_.C8.Logging.getLogger("MutedAlertsModel"),I=u.h.create(new Map),k=new b.Subject,R=new y.w.Keeper,M=u.h.create(!1);return R.push(M.pipe(b.switchMap((t=>e.pipe(b.filter((()=>!t)),b.filter(A.hX.is("session_started")),b.map((e=>function(e){const t=e.map((e=>[e.userMuteCategory,{id:e.userMuteCategory,description:e.userMuteCategoryDescription,scope:e.userMuteScope}]));return new Map(t)}(e.userMutedCategories))),b.tap(S.wW(I)),b.tap((()=>k.next({type:i.Type.CategoriesChanged}))))))).subscribe(),I.pipe(b.pairwise(),b.map((([e,r])=>function(e,r){return{muted:f.uz(t.Id.ord)(e,r),unmuted:f.uz(t.Id.ord)(r,e)}}(e,r))),b.map(function(e){return({muted:t,unmuted:r})=>({toMute:C.k.getAlerts(e,t).all.filter((e=>e.mute!==w.bZ.MuteStateType.Muted)),toUnmute:C.k.getAlerts(e,r).all.filter((e=>e.mute!==w.bZ.MuteStateType.Unmuted))})}(a)),b.tap((({toMute:e,toUnmute:t})=>{e.length>0&&l.changeMuteState(e,w.bZ.MuteStateType.Muted),t.length>0&&l.changeMuteState(t,w.bZ.MuteStateType.Unmuted)}))).subscribe()),{events:k,mutedCategories:I,muteCategories:e=>{M.set(!0),(0,g.zG)(s.sendFeedback({kind:v.Mw.MUTE,userMuteScope:c,userMuteCategories:e}),p.tS((()=>(M.set(!1),p.F2(g.Q1)))),p.Vn((e=>{m.warn("Alerts could not be muted on CAPI",e)})))();const r=C.k.getAlerts(a,e);0===r.all.filter((e=>e.mute!==w.bZ.MuteStateType.Muted)).length&&m.warn("No alerts were muted on category mute",{categoryIds:e});const l=function(e,r,i){return s=>{const a=new Map(s);return e.forEach(((e,s)=>{t.isSpecial(s)?a.set(s,{id:s,scope:r,description:t.specialCategoryDescription}):(0,g.zG)(n.P5(0,e),d.tS((e=>e.muteCategory)),d.g_((()=>i.error("No alerts to mute",s)),(e=>a.set(s,{id:e.id,description:e.description,scope:r}))))})),a}}(r.byCategory,c,m)(I.get());return I.set(l),k.next({type:i.Type.CategoriesChanged}),o.F2(void 0)},unmuteCategories:e=>{M.set(!0),(0,g.zG)(s.sendFeedback({kind:v.Mw.UNMUTE,userMuteScope:c,userMuteCategories:e}),p.tS((()=>(M.set(!1),p.F2(g.Q1)))),p.Vn((e=>{m.warn("Alerts could not be un-muted on CAPI",e)})))();return 0===C.k.getAlerts(a,e).all.filter((e=>e.mute!==w.bZ.MuteStateType.Unmuted)).length&&m.warn("No alerts were unmuted on category unmute",{categoryIds:e}),I.modify(function(e,t){return r=>{const i=new Map(r);return e.forEach((e=>{r.has(e)?i.delete(e):t.error("Tried to unmute a category which is not muted",e)})),i}}(e,m)),k.next({type:i.Type.CategoriesChanged}),o.F2(void 0)},getMutedCategories:()=>(0,g.zG)(I.get(),r.filterWithCount((0,h.ff)(t.isSpecial),a)),getMutedSpecialCategories:()=>(0,g.zG)(I.get(),r.filter(t.isSpecial)),loadCachedMutedCategories:e=>{I.set(e)},dispose:()=>R.dispose()}},function(e){e.create=function(){return{events:b.EMPTY,mutedCategories:u.h.create(new Map),getMutedCategories:()=>new Map,getMutedSpecialCategories:()=>new Map,muteCategories:e=>o.F2(void 0),unmuteCategories:e=>o.F2(void 0),loadCachedMutedCategories:g.Q1,dispose:g.Q1}}}(s=e.Mock||(e.Mock={}))}(i=e.CategoriesModel||(e.CategoriesModel={}))}(i||(i={}))},84146:(e,t,r)=>{r.d(t,{k:()=>i});var i,s=r(58303),a=r(90023),n=r(55812),o=r(7378);!function(e){e.create=e=>({getAlertMuteCategory:t=>(0,a.zG)(e.getById(t),s.tS((e=>e.muteCategory)))});e.getAlerts=function(e,t){const r={byCategory:new Map(t.map((e=>[e,[]]))),all:[]};return(0,a.zG)(e.get(),o.p.reduce(r,((e,{alert:r})=>(0,a.zG)(r.muteCategory,s.hX((e=>t.includes(e.id))),s.UI((e=>e.id)),s.wp((()=>s.ij(t.find(n.bZ.belongsToSpecialCategory(r))))),s.g_((()=>e),(t=>(e.byCategory.get(t).push(r),e.all.push(r),e)))))))}}(i||(i={}))},19328:(e,t,r)=>{r.d(t,{dM:()=>i,j:()=>s});var i,s,a,n,o=r(21147),d=r(18397),l=r(90023),h=r(13391),c=r(55709),p=r(92156),g=r(58303),u=r(10444);!function(e){e.group=p.kT({critical:p.Kh,advanced:p.Kh,free:p.Kh,freePremium:p.Kh,paid:p.Kh,unread:p.Kh,muted:p.Kh}),e.eq=o.MW({critical:o.lr,advanced:o.lr,free:o.lr,freePremium:o.lr,paid:o.lr,unread:o.lr,muted:o.lr}),e.show=d.aM({critical:d.yt,advanced:d.yt,free:d.yt,paid:d.yt,unread:d.yt,muted:d.yt});e.isValid=function(e){return e.critical>=0&&e.advanced>=0&&e.unread>=0},e.isEmpty=function(e){return i.eq.equals(e,i.group.empty)}}(i||(i={})),function(e){var t=e.MIN_GOALS=3;e.TOTAL_GOALS=t+1;e.calculateCompleteness=function(e){const t=(0,l.zG)(e.goals,g.Gg((e=>e.size>0)));return c.R$.eq.equals(e,c.R$.unset)||(0,l.zG)(e.domain,u.wo((e=>"general"===e)))&&!(g.pC(e.audience)||g.pC(e.style)||t)?0:Number(t||0)+s.MIN_GOALS}}(s||(s={})),function(e){e.zero={full:0,trimmed:0}}(a||(a={})),function(e){let t;!function(e){e[e.Document=0]="Document",e[e.Plagiarism=1]="Plagiarism"}(t=e.CheckingKind||(e.CheckingKind={}));e.Mock={getCheckingForState:()=>h.h.create({kind:n.CheckingKind.Document,type:"idle"})}}(n||(n={}))},917:(e,t,r)=>{r.d(t,{aW:()=>i,vM:()=>p});var i,s=r(12533),a=r(59833),n=r(12518),o=r(90023),d=r(15217),l=r(32103),h=r(10444),c=r(58303);function p(e,t){return t.reduce(((t,r)=>{const i="function"==typeof e?e(r):r[e];let s=t.get(i);return s||(s=[],t.set(i,s)),s.push(r),t}),new Map)}!function(e){e.URI="ImmutableSortedMap";e.create=function(e,t,r){const s=Array.isArray(e)?new Map(e.map((e=>[t(e),e]))):e,a=i.orderKeys(s,r);return s.forEach((e=>(0,l.kG)(u(e),"init value should implement IEquals",(()=>JSON.stringify(e))))),new g(s,a,r,t)},e.empty=function(e,t){return new g(new Map,[],t,e)},e.diff=function(e,t){const r=e.clear();return e.reduce((({added:e,preserved:r,removed:i,changed:s},a,n)=>{const o=e.has(n)?e.remove(n):e;if(t.has(n)){const e=a.equals(h.MH(t.get(n)).value);return{removed:i,added:o,preserved:e?r.add(a):r,changed:e?s:s.add(a)}}return{removed:i.add(a),added:o,preserved:r,changed:s}}),{removed:r,added:t,preserved:r,changed:r})},e.unsafeGet=function(e,t){return h.MH(t.get(e)).value},e.unsafeGetBy=function(e){return t=>h.MH(t.get(e)).value},e.unsafeGetAt=function(e,t){return h.MH(t.getAt(e))},e.unsafeGetAtBy=function(e){return t=>h.MH(t.getAt(e))},e.nonEmpty=function(e){return e.size>0},e.lowerBound=function(e,t){let r=-1,i=e.size;for(;r+1!==i;){const s=r+(i-r>>1);t(h.MH(e.getAt(s)))?r=s:i=s}return r+1},e.createKeySorter=function(e,t){return(r,i)=>t(e(r),e(i))},e.orderKeys=function(e,t){return Array.from(e.keys()).sort(i.createKeySorter((t=>e.get(t)),t))},e.takeByKey=function(e,t,r){const i=(0,o.zG)(r,a.cx((t=>t===e))),s=c.ij(t.get(e));return(0,l.kG)(c.Wi(i)&&c.Wi(s)||c.pC(i)&&c.pC(s),"unsynced hash&order"),h.vB(((e,t)=>({index:e,value:t})))(i,s)},e.getFoldableWithIndex=function(){return{URI:i.URI,_E:void 0,reduce:(e,t,r)=>e.reduce(r,t),foldMap:e=>(t,r)=>t.reduce(((t,i)=>e.concat(t,r(i))),e.empty),reduceRight:(e,t,r)=>e.reduce(((e,t)=>r(t,e)),t),reduceWithIndex:(e,t,r)=>e.reduce(((e,t,i)=>r(i,e,t)),t),reduceRightWithIndex:(e,t,r)=>e.reduce(((e,t,i)=>r(i,t,e)),t),foldMapWithIndex:e=>(t,r)=>t.reduce(((t,i,s)=>e.concat(t,r(s,i))),e.empty)}}}(i||(i={}));class g{get(e){return i.takeByKey(e,this._hash,this._order)}getIndex(e){return c.DT((e=>e>-1))(this._order.indexOf(e))}getAt(e){return c.ij(this._hash.get(this._order[e]))}has(e){return this._hash.has(e)}find(e,t=0){if(t<0)return c.YP;for(let r=t;r<this._order.length;r++){const t=this._order[r],i=this._hash.get(t);if(e(i))return c.G({index:r,value:i})}return c.YP}findFrom(e,t){return this.find(e,t)}findRight(e,t){if(Boolean(t)&&t>=this._order.length)return c.YP;for(let r=Boolean(t)?t:this._order.length-1;r>=0;r--){const t=this._order[r],i=this._hash.get(t);if(e(i))return c.G({index:r,value:i})}return c.YP}findRightFrom(e,t){return this.findRight(e,t)}map(e,t=this._comp){const r=new Map;this._order.forEach(((t,i)=>{const s=this._hash.get(t),a=e(s,t,i);(0,l.kG)(u(a),"transformed value should implement IEquals",(()=>JSON.stringify(a))),r.set(t,a)}));const s=i.orderKeys(r,t);return new g(r,s,t,this._getKey)}mapTo(e){return this._order.map(((t,r)=>e(this._hash.get(t),t,r)))}filter(e){const t=new Map,r=this._order.filter((r=>{const i=this._hash.get(r),s=e(i,r);return s&&t.set(r,i),s}));return new g(t,r,this._comp,this._getKey)}reduce(e,t){return this._order.reduce(((t,r,i)=>e(t,this._hash.get(r),r,i)),t)}modifyWith(e,t){const r=new Map(this._hash),s=this._order.slice(),a=(e,a)=>{const n=i.takeByKey(a,r,s),o=t(a,e,n);(0,l.kG)(u(o),"modified value should implement IEquals",(()=>JSON.stringify(o))),r.set(a,o),c.Wi(n)&&s.push(a)};return e instanceof Array?e.forEach((([e,t])=>a(t,e))):e.forEach(a),s.sort(i.createKeySorter((e=>r.get(e)),this._comp)),new g(r,s,this._comp,this._getKey)}patchWith(e,t){const r=new Map(this._hash),s=this._order.slice(),a=(e,a)=>{const n=i.takeByKey(a,r,s),d=t(a,e,n);(0,l.kG)(h.wo(u)(d),"patched value should implement IEquals",(()=>JSON.stringify(d))),(0,o.zG)(d,c.g_((()=>{(0,o.zG)(n,c.g_(o.Q1,(({index:e})=>{r.delete(a),s.splice(e,1)})))}),(e=>{r.set(a,e),c.Wi(n)&&s.push(a)})))};return e instanceof Array?e.forEach((([e,t])=>a(t,e))):e.forEach(a),s.sort(i.createKeySorter((e=>r.get(e)),this._comp)),new g(r,s,this._comp,this._getKey)}add(e){const t=new Map(this._hash),r=this._order.slice();return(Array.isArray(e)?e:[e]).forEach((e=>{const i=this._getKey(e);(0,l.kG)(u(e),"added value should implement IEquals",(()=>JSON.stringify(e))),t.set(i,e),-1===r.indexOf(i)&&r.push(i)})),r.sort(i.createKeySorter((e=>t.get(e)),this._comp)),new g(t,r,this._comp,this._getKey)}update(e,t){return(0,o.zG)(this.get(e),c.g_((()=>n.t$(`Provided key ${e} not found in the map`)),(({value:r})=>{const s=new Map(this._hash),a=this._order.slice();return s.set(e,t(r)),a.sort(i.createKeySorter((e=>s.get(e)),this._comp)),n.F2(new g(s,a,this._comp,this._getKey))})))}remove(e){(0,l.kG)(this.has(e),`can not remove unknown key: ${e}`);const t=new Map(this._hash);t.delete(e);const r=(0,d.CE)(e,this._order);return new g(t,r,this._comp,this._getKey)}clear(){return new g(new Map,[],this._comp,this._getKey)}hashCode(){let e=7;return this._hash.forEach((t=>e+=t.hashCode())),e}equals(e){return this.hashCode()===e.hashCode()&&this.size===e.size&&this.values().every(((t,r)=>t.equals(h.MH(e.getAt(r)))))}values(){return this._order.map((e=>this._hash.get(e)))}keys(){return this._order}get size(){return this._order.length}constructor(e,t,r,i){(0,s._)(this,"_hash",void 0),(0,s._)(this,"_order",void 0),(0,s._)(this,"_comp",void 0),(0,s._)(this,"_getKey",void 0),this._hash=e,this._order=t,this._comp=r,this._getKey=i,(0,l.kG)(e.size===t.length,"every hash entry should has order")}}function u(e){return!(!Boolean(e)||"function"!=typeof e.equals||"function"!=typeof e.hashCode)}}}]);