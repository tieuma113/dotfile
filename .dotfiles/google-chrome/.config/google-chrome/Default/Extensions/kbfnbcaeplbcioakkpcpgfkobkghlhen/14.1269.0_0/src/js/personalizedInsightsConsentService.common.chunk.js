(self.webpackChunk=self.webpackChunk||[]).push([[2308],{63463:(t,s,e)=>{e.r(s),e.d(s,{PersonalizedInsightsConsentService:()=>O});var n,i=e(32073),o=e(84308),a=e(90572),r=e(20161),_=e(84714),S=e(18827),h=e(39963),p=e(95404),T=e(20905),u=e(86530),d=e(82914);!function(t){t.SHOULD_SHOW_BASED_ON="SHOULD_SHOW_BASED_ON",t.SHOW_POPUP="SHOW_POPUP"}(n||(n={}));const E=(t,s,e,n)=>{d.J.personalizedInsightsConsentPopupLog({[t]:JSON.stringify(e)},s,Date.now(),n)};var c;!function(t){t.CURRENT_LOCAL_STORAGE_STATE="CURRENT_LOCAL_STORAGE_STATE",t.CURRENT_DAPI_STATE_DESERIALIZED="CURRENT_DAPI_STATE_DESERIALIZED",t.CURRENT_COMBINED_STATE="CURRENT_COMBINED_STATE",t.SET_LOCAL_STORAGE_STATE="SET_LOCAL_STORAGE_STATE",t.SET_LOCAL_STORAGE_STATE_FAILURE="SET_LOCAL_STORAGE_STATE_FAILURE",t.SET_DAPI_STATE="SET_DAPI_STATE"}(c||(c={}));const A=(t,s,e,n)=>{d.J.personalizedInsightsConsentPopupLog({[t]:JSON.stringify(e)},s,Date.now(),JSON.stringify(n))};var g;!function(t){t.getState=(t,s,e)=>n(t,s,e),t.update=(t,n,i,o)=>{s(t,i,o),e(n,i,o)};const s=(t,s,e)=>{t.setPersonalizedInsightsConsentPopupState(s).then((()=>{A(c.SET_LOCAL_STORAGE_STATE,e,s)})).catch((t=>{A(c.SET_LOCAL_STORAGE_STATE_FAILURE,e,s,t)}))},e=(t,s,e)=>{const n=a(s);t.setPersonalizedInsightsConsentState(n).then((()=>{A(c.SET_DAPI_STATE,e,s)}))},n=(t,s,e)=>{const n=i(s,e);return o(t,n,e)},i=(t,s)=>{const e=t.personalizedInsightsConsentPopup||{};return A(c.CURRENT_LOCAL_STORAGE_STATE,s,e),e},o=(t,s,e)=>{const n=t["personalizedInsightsConsent:onboardingState:llamaWindows"],i=t["personalizedInsightsConsent:onboardingState:llamaMac"],o=t["personalizedInsightsConsent:onboardingState:extension"];if(!(n||i||o))return s;const a=n||i?{hasSeenInOtherProduct:!0}:{},_=o?r(o,s):{},S={...s,..._,...a};return A(c.CURRENT_DAPI_STATE_DESERIALIZED,e,_),A(c.CURRENT_COMBINED_STATE,e,S),S},a=t=>encodeURI(JSON.stringify(t)),r=(t,s)=>{try{const s=decodeURI(t);return JSON.parse(s)}catch(t){return s}}}(g||(g={}));var C=e(86131),I=e(39250);class O{constructor(t,s,e,d,c,A,R){this._gButtonPopupController=t,this._experimentClient=s,this._dapiSettings=e,this._user=d,this._pageState=c,this._dapiActions=A,this._csActions=R,this._subs=new i.w0,this._instanceId=(0,u.H)(),this._initPopup=async()=>{await this._csActions.reloadUserDataSharingRateLimited(),await this._dapiActions.reloadPropsRateLimited(),this._subs.add(o.a([this._pageState,this._dapiSettings,this._gButtonPopupController.state]).pipe(a.h((([t])=>!!t.isActiveTab)),r.w((([t,s,e])=>{const{dataSharingSettings:i}=t,o=this._user.get(),a=this._isExistingUser(o),r=!this._hasSeenPopup(s,t),h="none"===e.type,p=!!i&&"personalizedInsights"in i.features,T=this._getDataSharingConsentCopyType(i);E(n.SHOULD_SHOW_BASED_ON,this._instanceId,{isPersonalizedInsightsFeatureEnabledInDataSharing:p,hasNotSeenPopup:r});const u=r&&p&&a&&h;return _.of({shouldShowPopup:u,dataSharingConsentCopy:T}).pipe(S.g(300))}))).subscribe((({shouldShowPopup:t,dataSharingConsentCopy:s})=>{if(t){E(n.SHOW_POPUP,this._instanceId,!0);try{this._gButtonPopupController.updateState({type:"personalizedInsightsConsentPopup",dataSharingConsent:s,popupId:this._instanceId})}catch(t){(0,h.Tb)().personalizedInsightsConsentPopupInitializationError(t)}}})))},this._isExistingUser=t=>{const s=t.registrationDate?Date.parse(this._formatISOTimestampToUTC(t.registrationDate)):void 0;return!!s&&this._hasOneDayPassed(s)},this._hasSeenPopup=(t,s)=>{const{hasSeenInOtherProduct:e,lastSeenTimestamp:n}=g.getState(t,s,this._instanceId);return e||!!n},this._getDataSharingConsentCopyType=t=>{var s;if(t){const e=null===(s=t.features.personalizedInsights)||void 0===s?void 0:s.dataSharing;return t.consentRequired?e?C.Z.Unknown:C.Z.Required:e?C.Z.NotRequired:C.Z.Unknown}return C.Z.Unknown},this._formatISOTimestampToUTC=t=>"Z"===t.slice(-1)?t:`${t}Z`,this._hasOneDayPassed=t=>Date.now()-t>T.v0,this._isGateEnabled=()=>(0,I.c)(this._experimentClient),this.show=()=>{g.update(this._csActions,this._dapiActions,{lastSeenTimestamp:Date.now()},this._instanceId),O._isResourceInUse=!1},this.openSettings=()=>{self.open(`${(0,p.rv)()}?hubCustomizeFeatures=1`)};const l=this._dapiSettings.get(),P=this._pageState.get(),D=this._hasSeenPopup(l,P);!this._isGateEnabled()||D||O._isResourceInUse||this._initPopup()}dispose(){O._isResourceInUse=!1,this._subs.unsubscribe()}}O._isResourceInUse=!1},86131:(t,s,e)=>{var n,i;e.d(s,{F:()=>i,Z:()=>n}),function(t){t.Required="Required",t.NotRequired="NotRequired",t.Unknown="Unknown"}(n||(n={})),function(t){t.Ok="Ok",t.Close="Close"}(i||(i={}))}}]);