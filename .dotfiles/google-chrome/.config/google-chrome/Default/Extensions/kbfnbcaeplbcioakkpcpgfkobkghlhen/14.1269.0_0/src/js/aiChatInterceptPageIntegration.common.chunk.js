(self.webpackChunk=self.webpackChunk||[]).push([[3189],{30170:(t,e,n)=>{n.r(e),n.d(e,{ChatGptInterceptPageIntegration:()=>B});var a=n(13391),r=n(32073),i=n(74822),s=n(2613),c=n(52826),o=n(59179),h=n(63532),l=n(90572),g=n(24666),u=n(29416),p=n(84178),m=n(20161),d=n(39963);class C{constructor(t){this._params=t}async trackChatOpened(){const t=this._params.getChatId();t?await this._params.gnarClient.aiChatInterceptChatOpen(t):(0,d.Tb)().aiChatIntercept.warning("chat_id_missing","AiChatInterceptGnarTrackingServiceImpl.trackChatOpened: Chat ID missing.")}async trackChatBecameEligible(t){const e=this._params.getChatId();e?(0===t.length&&(0,d.Tb)().aiChatIntercept.warning("matched_prompt_terms_missing","AiChatInterceptGnarTrackingServiceImpl.trackChatBecameEligible: Matched prompt terms missing."),await this._params.gnarClient.aiChatInterceptChatBecameEligible(e,t)):(0,d.Tb)().aiChatIntercept.warning("chat_id_missing","AiChatInterceptGnarTrackingServiceImpl.trackChatBecameEligible: Chat ID missing.")}async trackBannerNotShown(t,e){const n=this._params.getChatId();n?("ineligible_experiment_group"===t&&void 0===e&&(0,d.Tb)().aiChatIntercept.warning("experiment_treatment_missing","AiChatInterceptGnarTrackingServiceImpl.trackBannerNotShown: Experiment treatment missing."),void 0===e?await this._params.gnarClient.aiChatInterceptBannerNoShow(n,t):await this._params.gnarClient.aiChatInterceptBannerNoShow(n,t,null!=e?e:"null")):(0,d.Tb)().aiChatIntercept.warning("chat_id_missing","AiChatInterceptGnarTrackingServiceImpl.trackBannerNotShown: Chat ID missing.")}async trackBannerShown(){const t=this._params.getChatId();t?await this._params.gnarClient.aiChatInterceptBannerShow(t):(0,d.Tb)().aiChatIntercept.warning("chat_id_missing","AiChatInterceptGnarTrackingServiceImpl.trackBannerShown: Chat ID missing.")}async trackBannerCtaClicked(){const t=this._params.getChatId();t?await this._params.gnarClient.aiChatInterceptBannerClick(t):(0,d.Tb)().aiChatIntercept.warning("chat_id_missing","AiChatInterceptGnarTrackingServiceImpl.trackBannerCtaClicked: Chat ID missing.")}async trackBannerDismissed(){const t=this._params.getChatId();t?await this._params.gnarClient.aiChatInterceptBannerDismiss(t):(0,d.Tb)().aiChatIntercept.warning("chat_id_missing","AiChatInterceptGnarTrackingServiceImpl.trackBannerDismissed: Chat ID missing.")}}var _=n(85866),f=n(76206),b=n(81815);const v="data-message-author-role";var w;!function(t){t.User="user",t.Assistant="assistant"}(w||(w={}));var I,T,k=n(5332);!function(t){function e(t){return t.trim().toLowerCase().replace(/\s+/g," ")}const n=function(t){var n;const a=new Map;for(const r of t){const t=new Set;for(const i of r.terms){const s=e(i);if(t.has(s))continue;t.add(s);const c=s.split(" "),o=c[0],h=null!==(n=a.get(o))&&void 0!==n?n:[];h.push({threshold:r.threshold,eligible:r.eligible,term:i,normalizedTermWords:c}),a.set(o,h)}}return a}(Object.values({eligibleOneMatch:{eligible:!0,threshold:1,terms:["essay","thesis","MLA","APA","Chicago style","Works cited","Bibliography","Citations","Double spaced","body paragraph","intro paragraph","Conclusion paragraph"]},eligibleTwoMatches:{eligible:!0,threshold:2,terms:["term","literary","research","argumentative","expository","narrative","persuasive","analytical","descriptive","critical","paper","analysis","class"]},eligibleThreeMatches:{eligible:!0,threshold:3,terms:["Write","Draft","Generate","Help me write","Compose","class","course","teacher","professor","homework","assignment","school"]},ineligibleOneMatch:{eligible:!1,threshold:1,terms:["rubric","grading","lesson plan","syllabus","curriculum","students"]}}));t.isUserMessageEligible=function({author:t,content:e}){var a,r;if(t!==w.User||0===e.length)return{status:"fail"};const i=Array.from(e.matchAll(/[a-zA-Z]+/g),(t=>t[0].toLowerCase()));if(0===i.length)return{status:"fail"};const s=new Map,c=new Map;for(let t=0;t<i.length;t++){const e=n.get(i[t]);if(e)for(const n of e){const{normalizedTermWords:e,eligible:o,threshold:h}=n;if(e.length>i.length-t)continue;let l=!0;for(let n=0;n<e.length;n++)if(e[n]!==i[t+n]){l=!1;break}if(l){if(o){const t=null!==(a=s.get(h))&&void 0!==a?a:[];t.push(n),s.set(h,t)}else{const t=null!==(r=c.get(h))&&void 0!==r?r:[];t.push(n),c.set(h,t)}for(const[t,e]of c){if(e.length>=t)return{status:"fail"}}}}}const o=Array.from(s).reduce(((t,[e,n])=>n.length>=e?[...t,...n]:t),[]);return o.length>0?{status:"success",matchedTerms:Array.from(new Set(o.map((t=>t.term))))}:{status:"fail"}},t.isAssistantMessageEligible=function(t){return t.author===w.Assistant&&(!((0,k.Sx)(t.content)<=200)&&!((0,k.OR)(t.content)<3))}}(I||(I={})),function(t){const e=new Set(Object.values(w));t.extractFromElement=function(t){var n,a;const r=[...t.querySelectorAll("[data-message-author-role]")];if(0===r.length)return[];const i=[],s=new Set;for(const t of r){const r=t.getAttribute(v);if(!e.has(r)){s.add(r);continue}const c=null!==(a=null===(n=t.textContent)||void 0===n?void 0:n.trim())&&void 0!==a?a:"";i.push({author:r,content:c})}return s.size>0&&(0,d.Tb)().aiChatIntercept.warning("message_author_role_unknown","ChatGptThread.extractFromElement: Unknown message author role(s) encountered.",{roles:Array.from(s)}),i},t.equals=function(t,e){if(t.length!==e.length)return!1;for(let n=0;n<t.length;n++)if(t[n].author!==e[n].author||t[n].content!==e[n].content)return!1;return!0},t.isEligible=function(t){if(t.length<2)return{status:"fail"};const e=t[t.length-1];if(!I.isAssistantMessageEligible(e))return{status:"fail"};const n=t.filter((t=>t.author===w.User));if(0===n.length)return{status:"fail"};for(let t=n.length-1;t>=0;t--){const e=I.isUserMessageEligible(n[t]);if("success"===e.status)return{status:"success",matchedPromptTerms:e.matchedTerms}}return{status:"fail"}};t.getHTMLElement=function(t){return t.querySelector("#thread, .group\\/thread")}}(T||(T={}));var S=n(20905);const A=S.an(1);const x=S.i4(72);var y=n(45523),E=n(70843);class B{constructor(t,e,n,s){this._context=t,this._state=e,this._actions=n,this._disposed=a.h.create(!1),this.disposed=this._disposed.view(),this._subscriptions=new r.w0,this._evaluationTrigger=new i.x,this._gnarService=new C({gnarClient:s,getChatId:()=>function(){var t;const e=self.location.href;if(!(0,b.w)(e))return null;try{const{pathname:n}=new URL(e),a=f.A.exec(n),r=null===(t=null==a?void 0:a[1])||void 0===t?void 0:t.toLowerCase();return null!=r?r:null}catch(t){return null}}()})}init(){this._observeEvaluationTrigger(),this._observeThreadElementChanges(),this._evaluationTrigger.next()}_observeEvaluationTrigger(){this._subscriptions.add(this._evaluationTrigger.pipe(s.e(0,c.Z),o.U((()=>(0,_.h)({experimentClient:this._context.experimentClient,state:this._state,url:self.location.href}))),h.b((t=>{t?this._trackChatOpened():this.dispose()})),l.h((t=>t)),o.U((()=>T.extractFromElement(document.body))),g.x(T.equals),o.U((t=>{const e=T.isEligible(t);if("fail"===e.status)return!1;this._gnarService.trackChatBecameEligible(e.matchedPromptTerms),(0,d.Tb)().aiChatIntercept.info("thread_became_eligible","ChatGptInterceptPageIntegration._observeEvaluationTrigger: Thread became eligible.");const n=this._context.experimentClient.getTreatment(E.p.AiChatInterceptChatGptAiEditor);return"test"===n?function(t){const e=t.page.aiChatInterceptState;if(!e)return!1;const n=e[t.user.id];if(!n)return!1;const a=n.bannerLastDismissedAt;if(!a)return!1;const r=new Date(a);return!isNaN(r.getTime())&&Date.now()-r.getTime()<=x}(this._state)?(this._gnarService.trackBannerNotShown("dismissed_within_72h"),!1):!function(t){const e=t.page.aiChatInterceptState;if(!e)return!1;const n=e[t.user.id];if(!n)return!1;const a=n.bannerLastShownAt;if(!a)return!1;const r=new Date(a);return!isNaN(r.getTime())&&Date.now()-r.getTime()<=A}(this._state)||(this._gnarService.trackBannerNotShown("shown_within_24h"),!1):(this._gnarService.trackBannerNotShown("ineligible_experiment_group",n),!1)})),g.x()).subscribe((t=>{t&&this._actions.aiChatIntercept.recordBannerShown({userId:this._state.user.id})})))}_observeThreadElementChanges(){this._subscriptions.add(y.x.create(document.body,{subtree:!0,childList:!0}).pipe(u.b(100),o.U((()=>{var t;return null===(t=T.getHTMLElement(document.body))||void 0===t?void 0:t.parentElement})),l.h((t=>!!t)),p.q(1),m.w((t=>y.x.create(t,{subtree:!0,childList:!0,characterData:!0}).pipe(u.b(200),h.b((()=>{(0,d.Tb)().aiChatIntercept.info("thread_element_changed","ChatGptInterceptPageIntegration._observeThreadElementChanges: Thread element changed.")})))))).subscribe((()=>{this._evaluationTrigger.next()})))}_trackChatOpened(){const t=self.location.href;t!==this._previousUrl&&(this._gnarService.trackChatOpened(),this._previousUrl=t)}update(t){this._state=t,this._evaluationTrigger.next()}dispose(){this._subscriptions.unsubscribe(),this._disposed.set(!0)}}}}]);