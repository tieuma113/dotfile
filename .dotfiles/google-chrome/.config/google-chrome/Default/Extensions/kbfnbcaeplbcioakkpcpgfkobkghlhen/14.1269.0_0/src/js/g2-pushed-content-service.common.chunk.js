(self.webpackChunk=self.webpackChunk||[]).push([[1317],{9868:(e,t,n)=>{n.d(t,{N:()=>s});var s,i=n(88048),a=n(42203),o=n(86214),r=n(64443),c=n(59833),d=n(90023),g=n(64271),h=n(78129),u=n(63532),l=n(46734),m=n(59179),p=n(90572),f=n(10883),C=n(96333),I=n(5749);(e=>{const t=r.C8.Logging.getLogger("PushedContentRangeManager");e.create=e=>({getDiff:n=>(0,g.T)((t=>t.pipe((0,h.G)(),(0,u.b)((0,d.ls)((0,d.og)(C.$.diff),C.$.Diff.filter(I.z.isVBar),o.vh.forEach((t=>I.h.Range.getRangeIds(t.contentId).forEach((t=>e.deregisterRange(t)))),((t,n)=>{I.h.Range.getRangeIds(t.contentId).forEach((t=>e.deregisterRange(t)));const s=I.h.Range.fromRange(n.contentId,n.notification.notificationElement.range,"notification");if(e.registerRange(s.meta.id,s),I.h.isWithRewriteOrComment(n)){const t=I.h.Range.fromRange(n.contentId,n.surface.range,"surface");e.registerRange(t.meta.id,t)}}),(t=>{const n=I.h.Range.fromRange(t.contentId,t.notification.notificationElement.range,"notification");if(e.registerRange(n.meta.id,n),I.h.isWithRewriteOrComment(t)){const n=I.h.Range.fromRange(t.contentId,t.surface.range,"surface");e.registerRange(n.meta.id,n)}})))),(0,l.l)()))(n),(n=>e.rangeChanged.pipe((0,m.U)((({changed:e,affected:t})=>[...e.filter(I.h.Range.isVBarRange),...t.filter(I.h.Range.isVBarRange)])),(0,p.h)(c.Od),(0,f.M)(n),(0,m.U)((([e,n])=>{const s=new Map,i=new Map,a=new Map(e.map((e=>[e.meta.id,e]))),o=[];for(const e of C.$.values(n)){if(!I.z.isVBar(e))continue;const n=a.get(I.h.Range.Id(e.contentId,"notification")),r=a.get(I.h.Range.Id(e.contentId,"surface"));if(void 0===n&&void 0===r)continue;const c=void 0!==n&&!I.h.Range.eqLength.equals(n,e.notification.notificationElement.range),d=void 0!==r&&I.h.isWithRewriteOrComment(e)&&!I.h.Range.eqLength.equals(r,e.surface.range);if(c||d)t.debug("Removing item",{id:e.contentId}),s.set(e.contentId,e),r&&I.h.isWithRewriteOrComment(e)&&o.push(e);else{t.debug("Updating item ranges",{id:e.contentId});let s=e;n&&!I.h.Range.eq.equals(n,e.notification.notificationElement.range)&&(s=I.h.updateNotificationRange(n)(s)),r&&I.h.isWithRewriteOrComment(s)&&!I.h.Range.eq.equals(r,s.surface.range)&&(s=I.h.updateSurfaceRange(r)(s)),s!==e&&i.set(e.contentId,[e,s])}}return{diffInput:{removed:s,updated:i},rebaseCandidates:o}}))))(n)),getItemIdsWithIntersectingRange:t=>Array.from(new Set(e.findRanges((0,a.W9)(I.h.Range.isVBarRange,i.W.hasIntersection(t))).map((e=>e.meta.contentId))))})})(s||(s={}))},27929:(e,t,n)=>{n.r(t),n.d(t,{EmptyPushedContentServiceImpl:()=>L,G2PushedContentServiceImpl:()=>G,isLockedPushedContentItem:()=>$});var s=n(8351),i=n(90023),a=n(9141),o=n(96333),r=n(9868),c=n(68020),d=n(13391),g=n(42203),h=n(88012),u=n(74822),l=n(59179),m=n(90572),p=n(64271),f=n(31603),C=n(99887),I=n(24666),_=n(8794),R=n(36344),v=n(32486),M=n(48886),S=n(58303),b=n(10444),P=n(67177),y=n(43789),x=n(40594),w=n(31272),E=n(6824),k=n(36661),T=n(3244);const O=k.n(E.Schemable)(T.T0).is,U=k.n(E.Schemable)(T.D).is,D=k.n(E.Schemable)(T.JC).is;function $(e){return"lockedRewriteCard"===e.surface.kind||"lockedComment"===e.surface.kind}class G{constructor(e){this._params=e,this._logger=x.Y.create("G2PushedContentServiceImpl"),this._subs=new h.w.Keeper,this._disposed=new u.x,this._positionManager=new c.Xr,this._mapItemsToContentEntries=e=>Object.fromEntries(e.map((e=>[e.contentId,{notification:e.notification,surface:e.surface,contentId:e.contentId,originalPushedContentMessage:e}]))),this._updateContentState=e=>(0,i.zG)(e,o.$.createDiff,v.T.recover((e=>this._logger.error("conflicts on diff creating",e))),o.$.applyDiff,M.UI(v.T.recover((e=>this._logger.error("conflicts on diff apply",e)))),(e=>this.contentState.modify((t=>{const n=(0,i.zG)(t,Object.values,(e=>e.map((e=>e.originalPushedContentMessage))),o.$.from),s=e(n);return(0,i.zG)(s,o.$.values,this._mapItemsToContentEntries)})))),this.settingsState=d.h.create(S.YP),this.contentState=d.h.create({}),this._collectionState=this.contentState.view((0,i.ls)((0,s.KM)(a.Df)(((e,t)=>t)),(e=>e.map((e=>e.originalPushedContentMessage))),o.$.from)),this._telemetry=e.telemetryLogger;const t=this._params.capiStartAckMessage.pipe(l.U((0,i.ls)(S.UI((e=>{var t;return null===(t=e.serverConfigs)||void 0===t?void 0:t.PUSHED_CONTENT})),S.tS(S.ij))),m.h(S.pC),l.U(b.MH));this._pushedContentRangeManager=r.N.create(this._positionManager);const n=this._params.textObserver.getCurrentTextMap().getPlainText();this._positionManager.pushChanges(y.RI.resFromText(n)),this._subs.push(this._params.textObserver.contentChanges.async.subscribe((({deltaChange:e})=>{this._positionManager.pushChanges(e)}))),this._subs.push(this._pushedContentRangeManager.getDiff(this._collectionState).subscribe((({diffInput:e})=>{this._updateContentState(e)}))),this._subs.push(p.T([t,this._params.checkingService.pipe(m.h(S.pC),l.U((e=>e.value.capiMessages)),f.J(),m.h(U))]).pipe(f.J()).subscribe((e=>{this.settingsState.set(S.G(e))})),this._params.checkingService.pipe(m.h(S.pC),l.U((e=>e.value.capiMessages)),f.J(),m.h((0,g.Kg)(O,D))).subscribe(this._handlePushedContentMessage.bind(this)),this._listenForReconnect())}_listenForReconnect(){return this._params.capiStartAckMessage.pipe(C.oA,l.U((e=>e.sessionUuid)),I.x(),_.T(1)).subscribe((()=>{this._logger.info("Session started after disconnect, clearing pushed content items"),this.clear()}))}_handlePushedContentMessage(e){var t;switch(e.action){case"pushed_content:pushedContent":let n=!0;if("vBar"===e.notification.notificationElement.kind){const t=e.notification.notificationElement.range,s=this._positionManager.findById(e.contentId);n=this._params.textRangeFilterForVBars({textRange:t,fullText:this._params.textObserver.getCurrentTextMap().getPlainText()}),S.pC(s)?s.value.start===t.start&&s.value.end===t.end||(this._positionManager.deregisterRange(e.contentId),n&&this._positionManager.registerRange(e.contentId,{start:t.start,end:t.end,meta:{id:e.contentId}})):n&&this._positionManager.registerRange(e.contentId,{start:t.start,end:t.end,meta:{id:e.contentId}})}n&&this.contentState.modify((t=>({...t,[e.contentId]:{notification:e.notification,surface:e.surface,contentId:e.contentId,originalPushedContentMessage:e}})));break;case"pushed_content:removeContent":try{this._positionManager.deregisterRange(e.contentId)}catch(n){null===(t=this._telemetry)||void 0===t||t.warn({message:"Failed to deregister range for contentId",data:{contentId:e.contentId},error:n}),this._logger.warn("Failed to deregister range for contentId",{contentId:e.contentId,error:String(n)})}this.contentState.modify((t=>Object.fromEntries(Object.entries(t).filter((([t])=>t!==e.contentId)))))}}_sendPushedContentMessage(e){return(0,i.zG)(this._params.checkingService.get(),P.Yo((()=>"Checking service not available.")),P.tS((t=>t.sendMessage(e.action,e,!1))))().then((()=>{})).catch((e=>{this._logger.error("Could not send Pushed Content message.",e)}))}dismiss(e){this._sendDismissContentMessage(e),this.removePushedContentItemLocally(e)}markResolved(e){this._sendDismissContentMessage(e),this.removePushedContentItemLocally(e)}clear(e){return this._logger.debug("Clearing pushed content items",{predicate:e}),e?this.contentState.modify((t=>Object.fromEntries(Object.entries(t).filter((([t,{originalPushedContentMessage:n}])=>!e(n)))))):this.contentState.set({})}rebaseItems(e,t){return R.E}getCollection(e,t){return d.h.combine(this._collectionState,null!=t?t:d.h.create(!0),((t,n)=>n?o.$.filter(e)(t):o.$.empty))}_sendDismissContentMessage(e){return this._sendPushedContentMessage({action:"pushed_content:dismissContent",contentId:e})}sendExecuteActionMessage(e,t,n){return this._sendPushedContentMessage({action:"pushed_content:executeAction",contentId:e,clientContext:t,request:n}).catch((t=>{var s;throw null===(s=this._telemetry)||void 0===s||s.error({message:"Pushed content execute action error",data:{contentId:e,actionType:n.type},error:t}),t}))}sendGetSettingsMessage(e){return this._sendPushedContentMessage({action:"pushed_content:getSettings",contentId:e})}sendUpdateSettingsMessage(e,t){return this._sendPushedContentMessage({action:"pushed_content:updateSettings",contentId:e,extraSettings:t.extraSettings,defaultAction:t.defaultAction,expandedTabs:t.expandedTabs})}removePushedContentItemLocally(e){this.contentState.modify((t=>(0,w.hX)((t=>t!==e),t)))}dispose(){this._subs.dispose(),this._disposed.next(void 0)}}class L{constructor(){this.settingsState=d.h.create(S.YP),this.contentState=d.h.create({})}dismiss(e){}markResolved(e){}clear(e){}rebaseItems(e,t){return R.E}getCollection(e,t){return d.h.create(o.$.empty)}sendExecuteActionMessage(){return Promise.resolve()}sendGetSettingsMessage(){return Promise.resolve()}sendUpdateSettingsMessage(){return Promise.resolve()}removePushedContentItemLocally(e){}unlock(e){}dispose(){}}}}]);