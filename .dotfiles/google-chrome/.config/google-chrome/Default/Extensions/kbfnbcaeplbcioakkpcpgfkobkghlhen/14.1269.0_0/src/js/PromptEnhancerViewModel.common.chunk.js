(self.webpackChunk=self.webpackChunk||[]).push([[6347],{89449:(e,s,t)=>{t.d(s,{w:()=>p});var i=t(90023),n=t(35547),a=t(20154),r=t(25077),h=t(90572),c=t(59179),l=t(31603),_=t(58303),d=t(67177),o=t(46189),u=t(68822),g=t(40594);class p{constructor(e){this._checkingService=e,this._handlers=[],this._log=g.Y.create("AgentsCapiClient"),this._subscription=this._checkingService.pipe(h.h(_.pC),c.U((e=>e.value.capiMessages)),l.J(),h.h((e=>(0,n.rE)(e)||(0,a.eJ)(e)||(0,r.Xl)(e)||(0,r.Dl)(e)||(0,r.oy)(e)||(0,r.ps)(e))),c.U((e=>e))).subscribe((e=>{this._handlers.forEach((s=>(this._log.debug("Handling CAPI Message",e),s(e),o._.Result.STOP_HANDLING)))}))}enqueueExternalCommand(e){this._log.debug("Enqueueing External Command",e);const s=(0,i.zG)(this._checkingService.get(),_.g_((()=>""),(e=>e.sessionUuid||""))),{action:t,...n}=e({sessionId:s,id:1,currentRevision:0,nextRevision:()=>1});return(0,i.zG)(this._checkingService.get(),d.Yo((()=>new u.YG("Checking service is not available"))),d.tS((e=>e.sendMessage(t,n,!0))))}registerExternalMessageHandler(e){this._handlers.includes(e)||this._handlers.push(e)}unregisterExternalMessageHandler(e){this._handlers=this._handlers.filter((s=>s!==e))}dispose(){this._subscription.unsubscribe(),this._handlers=[]}}},96312:(e,s,t)=>{t.d(s,{R:()=>c});var i=t(90023),n=t(28357),a=t(67177),r=t(89449);class h extends Error{constructor(e,s){super(e),this.nestedError=s}}class c{constructor(e){this._params=e;const s=new r.w(this._params.checkingService);this._agentGenericService=n.W.create(s)}sendRequest(e){const s="disable"===e.commandId?JSON.stringify(e.payload):"";return(0,i.zG)({commandId:e.commandId,payload:s,agentId:this._params.agentId},this._agentGenericService.request,a.Pd((s=>new h(`Failed to send ${e.commandId} request`,s)),i.Q1))}dispose(){this._agentGenericService.dispose()}}},30830:(e,s,t)=>{t.r(s),t.d(s,{PromptEnhancerViewModelImpl:()=>b});var i=t(90023),n=t(13391),a=t(32073),r=t(59179),h=t(58303),c=t(67177),l=t(24666),_=t(74822),d=t(44071),o=t(84766),u=t(90572),g=t(63532);class p{constructor(e,s=p.DEFAULT_POLLING_INTERVAL_MS){this._eventTypes=e,this._pollingIntervalMs=s,this._subs=new a.w0,this._currentUrl=n.h.create(self.location.href),this._eventsSubject=new _.x,this.events=this._eventsSubject.asObservable()}init(){this._setupEventListeners(),this._emitInitialPageState()}_setupEventListeners(){this._eventTypes.includes("url_change")&&this._setupUrlChangeListeners()}_setupUrlChangeListeners(){this._subs.add(d.R(self,"popstate").subscribe((()=>{this._handleUrlChange()}))),this._subs.add(d.R(self,"hashchange").subscribe((()=>{this._handleUrlChange()}))),this._setupUrlPolling()}_setupUrlPolling(){const e=o.F(this._pollingIntervalMs).pipe(u.h((()=>!document.hidden)),g.b((()=>this._handleUrlChange())));this._subs.add(e.subscribe())}_handleUrlChange(){const e=self.location.href;e!==this._currentUrl.get()&&(this._currentUrl.set(e),this._emitEvent({type:"url_change",timestamp:Date.now(),url:e}))}_emitInitialPageState(){this._emitEvent({type:"url_change",timestamp:Date.now(),url:self.location.href})}_emitEvent(e){this._eventsSubject.next(e)}checkForChanges(){this._eventTypes.includes("url_change")&&this._handleUrlChange()}dispose(){this._subs.unsubscribe(),this._eventsSubject.complete()}}p.DEFAULT_POLLING_INTERVAL_MS=1e3;class v{constructor(e){this._pageEventService=new p(["url_change"]),this.conversationStateChanges=this._pageEventService.events.pipe(r.U(e.detectState.bind(e)),l.x(((e,s)=>e===s)),r.U(e.getStateChangeData.bind(e)))}init(){this._pageEventService.init()}dispose(){this._pageEventService.dispose()}}var m=t(96312);class b{constructor(e){this._params=e,this._subs=new a.w0,this._latestCommand=n.h.create(h.YP),this._conversationStateService=new v(this._params.detector),this._agentService=new m.R({checkingService:this._params.checkingService,agentId:this._params.agentId})}init(){this._subs.add(this._conversationStateService.conversationStateChanges.pipe(r.U((e=>e.shouldDisableFeature?this._disable("session"):this._enable()))).subscribe((e=>{e()}))),this._conversationStateService.init()}resendLatest(){(0,i.zG)(this._latestCommand.get(),h.UI(this._execute.bind(this)),h.UI((e=>e())))}_disable(e){return this._execute({commandId:"disable",payload:{persistence:e}})}_enable(){return this._execute({commandId:"enable"})}_execute(e){return this._latestCommand.set(h.G(e)),(0,i.zG)(this._agentService.sendRequest(e),c.Vn((s=>(this._params.telemetryService.error({message:s.message,error:s.nestedError,data:{agentId:this._params.agentId,commandId:e.commandId}}),s))))}dispose(){this._subs.unsubscribe(),this._conversationStateService.dispose(),this._agentService.dispose()}}}}]);