(self.webpackChunk=self.webpackChunk||[]).push([[8616],{71206:(e,t,n)=>{n.d(t,{K:()=>s});class s{constructor(){this._pendingRevision=0,this._finishedRevisions={regular:-1,plagiarism:-1,ai_detector:-1,writing_expert_check:-1,ai_studio:-1,audience_adapt:-1},this._wasChecked={regular:!1,plagiarism:!1,ai_detector:!1,writing_expert_check:!1,ai_studio:!1,audience_adapt:!1},this.reset()}getCheckState(e){return this._pendingRevision>this._finishedRevisions[e]?this._wasChecked[e]?"checking":"full":"idle"}getRevisionCheckState(){return this.getCheckState("regular")}getAsyncChecksState(){return{plagiarism:this.getCheckState("plagiarism"),ai_detector:this.getCheckState("ai_detector"),writing_expert_check:this.getCheckState("writing_expert_check"),ai_studio:this.getCheckState("ai_studio"),audience_adapt:this.getCheckState("audience_adapt")}}stage(e){this._pendingRevision=Math.max(this._pendingRevision,e)}finishRevision(e){this._finishedRevisions.regular=Math.max(this._finishedRevisions.regular,e),this._wasChecked.regular=!0}finishAsyncCheck(e,t){this._finishedRevisions[e]=Math.max(this._finishedRevisions[e],t),this._wasChecked[e]=!0}reset(){this._pendingRevision=0,this._finishedRevisions={regular:-1,plagiarism:-1,ai_detector:-1,writing_expert_check:-1,ai_studio:-1,audience_adapt:-1}}}},12898:(e,t,n)=>{n.d(t,{Kf:()=>h.K,TJ:()=>g.T,D8:()=>g.D,kX:()=>p});var s=n(64152),i=n(81484),r=Object.defineProperty,o=Object.defineProperties,c=Object.getOwnPropertyDescriptors,a=Object.getOwnPropertySymbols,u=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable,d=(e,t,n)=>t in e?r(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;function p(e){return(0,s.t)(((e,t)=>o(e,c(t)))(((e,t)=>{for(var n in t||(t={}))u.call(t,n)&&d(e,n,t[n]);if(a)for(var n of a(t))l.call(t,n)&&d(e,n,t[n]);return e})({},e),{schema:e.protocol,factories:i.i}))}var g=n(88257),h=n(71206)},19067:(e,t,n)=>{n.d(t,{u:()=>i});var s=n(90189);class i{static loadContentScriptIntegrationSingleton(e){return null===this._contentScriptInstance&&(this._contentScriptInstance=Promise.all([n.e(308).then(n.bind(n,23541)),this._loadMessageBusClient(e.tabId,e.experimentClient)]).then((([{AgentsContentScriptIntegration:t},n])=>new t({tabId:e.tabId,messageBusClient:n})))),this._contentScriptInstance}static loadDocumentGroupIntegrationSingleton(e){return null===this._documentGroupInstance&&(this._documentGroupInstance=Promise.all([Promise.all([n.e(5260),n.e(2168),n.e(309),n.e(9573),n.e(6974),n.e(9153)]).then(n.bind(n,49722)),this._loadMessageBusClient(e.tabId,e.experimentClient)]).then((([{AgentsDocumentGroupIntegration:t},n])=>new t({...e,messageBusClient:n})))),this._documentGroupInstance}static acquireReferenceFromDocument(e){this._documentReferences.add(e)}static releaseReferenceFromDocument(e){var t;this._documentReferences.delete(e),0===this._documentReferences.size&&(null===(t=this._documentGroupInstance)||void 0===t||t.then((e=>e[Symbol.asyncDispose]())),this._documentGroupInstance=null)}static loadPageGroupIntegrationSingleton(e){return null===this._pageGroupInstance&&(this._pageGroupInstance=Promise.all([Promise.all([n.e(5260),n.e(9573),n.e(128)]).then(n.bind(n,39146)),this._loadMessageBusClient(e.tabId,e.experimentClient)]).then((([{AgentsPageGroupIntegration:t},n])=>new t({...e,messageBusClient:n})))),this._pageGroupInstance}static _loadMessageBusClient(e,t){return null===this._contentScriptBusClient&&(this._contentScriptBusClient=Promise.all([n.e(5260),n.e(8729),n.e(4943)]).then(n.bind(n,53128)).then((({DefaultAgentsMessageBusClient:n})=>new n({messageApi:(0,s.OB)().browserApi.message,script:"cs",tabId:e,experimentClient:t})))),this._contentScriptBusClient}static dispose(){const e=[];return null!==this._contentScriptInstance&&(e.push(this._contentScriptInstance.then((e=>e[Symbol.dispose]()))),this._contentScriptInstance=null),null!==this._documentGroupInstance&&(e.push(this._documentGroupInstance.then((e=>e[Symbol.asyncDispose]()))),this._documentGroupInstance=null),null!==this._pageGroupInstance&&(e.push(this._pageGroupInstance.then((e=>e[Symbol.asyncDispose]()))),this._pageGroupInstance=null),null!==this._contentScriptBusClient&&(e.push(this._contentScriptBusClient.then((e=>e[Symbol.dispose]()))),this._contentScriptBusClient=null),this._documentReferences.clear(),Promise.all(e).then((()=>{}))}}i._contentScriptBusClient=null,i._contentScriptInstance=null,i._documentGroupInstance=null,i._documentReferences=new Set,i._pageGroupInstance=null},96579:(e,t,n)=>{n.r(t),n.d(t,{getDocumentIntegrationsObservable:()=>B});var s=n(50750),i=n(20161),r=n(84308),o=n(59179),c=n(90572),a=n(10883),u=n(84178),l=n(954),d=n(24666),p=n(8867),g=n(32073),h=n(63532),m=n(84714),S=n(89408),_=(n(24231),n(11970),n(27841),n(66445),n(36802)),f=n(40594),b=n(20680),I=n(79256),C=n(36344),v=n(12898),k=n(13391),y=n(58303),w=n(45676),x=n(67385),A=n(40866),D=n(78767);var R=n(24196),F=n(63753),G=n(19067),P=n(29416);function B(e){const t=(0,_.Of)(e.documentId),n=e.agentsFeatureFlags.catch((()=>F.W.allDisabled)),B=f.Y.create("Agents.getDocumentIntegrationsObservable"),O=G.u.loadContentScriptIntegrationSingleton({tabId:e.tabId,experimentClient:e.experimentClient}),T=(0,s.D)(O).pipe((0,i.w)((e=>e.isActiveTab))),M=(0,s.D)(O).pipe((0,i.w)((e=>e.documentSessionDisposed))),j=(0,r.a)([T,e.isTextFieldFocused]).pipe((0,o.U)((([e,t])=>e&&t))),E=()=>G.u.loadDocumentGroupIntegrationSingleton({experimentClient:e.experimentClient,user:e.user,tabId:e.tabId,actions:e.actions,telemetry:e.telemetry}),N=M.pipe((0,c.h)((e=>e===t)),(0,a.M)(j),(0,c.h)((([e,t])=>!t)),(0,o.U)((()=>null))).pipe((0,i.w)((()=>j.pipe((0,c.h)(Boolean),(0,u.q)(1),(0,l.O)(!1)))),(0,l.O)(!0),(0,d.x)()),U=new p.y((s=>{const i=new AsyncDisposableStack,o=(0,r.a)([E(),e.textFieldSupportsAgents,n]).subscribe({next:([n,r,o])=>{try{const e=i.use(n.runTextDecorationActivations({documentId:t,textFieldSupportsAgents:r,agentsFeatureFlags:o}));s.next(e.integrations)}catch(t){e.telemetry.error("TextDecorationActivations error",t),B.error("TextDecorationActivations error",t),s.complete()}},error:t=>{e.telemetry.error("getAgentsDocumentGroupIntegration error",t),B.error("getAgentsDocumentGroupIntegration error",t),s.complete()}});return()=>{B.debug(`Disposing text decoration integrations for document ${t}`),o.unsubscribe(),i.disposeAsync()}})),X=new p.y((s=>{const i=new AsyncDisposableStack,o=(0,r.a)([E(),e.textFieldSupportsAgents,n]).subscribe({next:([n,r,o])=>{try{const e=i.use(n.runInlineCardActivations({documentId:t,textFieldSupportsAgents:r,agentsFeatureFlags:o}));s.next(e.integrations)}catch(t){e.telemetry.error("InlineCardActivations error",t),B.error("InlineCardActivations error",t),s.complete()}},error:t=>{e.telemetry.error("getAgentsDocumentGroupIntegration error",t),B.error("getAgentsDocumentGroupIntegration error",t),s.complete()}});return()=>{B.debug(`Disposing inline card integrations for document ${t}`),o.unsubscribe(),i.disposeAsync()}}));return new p.y((s=>{const a=new DisposableStack,u=new g.w0;u.add((()=>a.dispose()));const{capiEvents:l,capiCheckingState:_,capiConnectionStatus:f}=a.use(function(e,t,n){const s=new DisposableStack,r=s.adopt(new g.w0,(e=>e.unsubscribe())),o=(0,b.z)((0,I.P)((()=>{const e=t.get();return e?(0,m.of)({...e,kind:"session_started",allowedFeatures:e.allowedFeatures,isNewSession:void 0===e.reconnectedInfo||void 0!==e.reconnectedInfo.reconnectFailedReason,sessionUuid:e.sessionUuid,domainName:e.domainName,domainCategory:e.domainCategory,defaultDocumentContext:y.YP}):C.E})),e.pipe((0,c.h)(D.C_),(0,i.w)((e=>e.capiEvents)))),a=new v.Kf,u=k.h.create(a.getRevisionCheckState()),l=k.h.create(a.getAsyncChecksState()),d=k.h.create(null),p=k.h.create({}),h=k.h.create({kind:"connecting"});r.add(e.pipe((0,i.w)((e=>e?e.checkingRevisionInfo:C.E))).subscribe((e=>{a.stage(A.Q.getRevisionNumber(e.revision)),u.set(a.getRevisionCheckState()),l.set(a.getAsyncChecksState())})));const S=()=>{const e=h.get();h.set({kind:"disconnected",sessionId:"connecting"===e.kind?null:e.sessionId})};return r.add(o.subscribe((e=>{w.hX.is("session_started")(e)?(h.set({kind:"connected",sessionId:e.sessionUuid,isNewSession:e.isNewSession,allowedFeatures:e.allowedFeatures}),e.isNewSession&&(a.reset(),d.set(null),p.set({})),u.set(a.getRevisionCheckState()),l.set(a.getAsyncChecksState())):w.hX.is("finish")(e)?(a.finishRevision(e.revision),u.set(a.getRevisionCheckState()),d.set({revision:e.revision,outcomeScores:e.outcomeScores,scoreStatus:y.FS(e.scoreStatus)})):w.hX.is("feedback_ack")(e)?d.modify((t=>{var n;return{revision:null!==(n=null==t?void 0:t.revision)&&void 0!==n?n:-1,outcomeScores:e.outcomeScores,scoreStatus:e.scoreStatus}})):w.hX.is("async_check_finished")(e)?(a.finishAsyncCheck(e.check,e.revision),l.set(a.getAsyncChecksState()),p.modify((t=>({...t,[e.check]:{revision:e.revision,outcomeScores:e.outcomeScores}})))):w.hX.is("disconnect")(e)&&S()}))),r.add(e.pipe((0,i.w)((e=>e?e.readyState:C.E))).subscribe((e=>{e===x.kQ.disconnected&&S()}))),{capiConnectionStatus:h,capiCheckingState:{checkingState:u,asyncCheckingState:l,scores:d,asyncScores:p,textInfo:n},capiEvents:o,[Symbol.dispose]:()=>s.dispose()}}(e.checkingService,e.capiStartAckMessage,e.textInfo)),F=N.pipe((0,d.x)(),(0,h.b)((e=>B.debug(`Should integrate in document ${t}: ${e}`))),(0,i.w)((s=>{return s?(0,r.a)([(i={capiConnectionStatus:f,capiCheckingState:_,capiEvents:l},new p.y((s=>{const o=new AsyncDisposableStack;G.u.acquireReferenceFromDocument(t);const c=(0,r.a)([E(),e.textFieldSupportsAgents,n]).subscribe({next:([n,r,c])=>{try{const a=o.use(n.runDocumentActivations({documentId:t,getPlainText:e.getPlainText,textChanges:e.textChanges,isTextFieldFocused:e.isTextFieldFocused,textFieldSupportsAgents:r,agentsFeatureFlags:c,checkingService:e.checkingService,pushedContentService:e.pushedContentService,...i}));s.next(a.integrations)}catch(t){e.telemetry.error("DocumentActivations error",t),B.error("DocumentActivations error",t),s.complete()}},error:t=>{e.telemetry.error("getAgentsDocumentGroupIntegration error",t),B.error("getAgentsDocumentGroupIntegration error",t),s.complete()}});return()=>{B.debug(`Disposing document integrations for document ${t}`),c.unsubscribe(),o.disposeAsync(),G.u.releaseReferenceFromDocument(t)}}))),U,X]).pipe((0,o.U)((([e,t,n])=>({documentIntegrations:e,textDecorationIntegrations:t,inlineCardIntegrations:n})))):(0,m.of)(null);var i})),(0,S.d)({bufferSize:1,refCount:!0}));return u.add(F.subscribe(s)),e.experimentClient.isGateEnabled(R.Nl.AgentsInfoTelemetry)&&u.add(function(e,t,n,s=1e3){return e.pipe((0,i.w)((e=>e?(0,r.a)([Promise.allSettled(e.documentIntegrations),Promise.allSettled(e.textDecorationIntegrations),Promise.allSettled(e.inlineCardIntegrations)]):(0,m.of)(null))),(0,c.h)(D.C_),(0,P.b)(s)).subscribe((e=>{const[s,i,r]=e,o=s.filter((e=>"fulfilled"===e.status)),c=s.filter((e=>"rejected"===e.status)),a=i.filter((e=>"fulfilled"===e.status)),u=i.filter((e=>"rejected"===e.status)),l=r.filter((e=>"fulfilled"===e.status)),d=r.filter((e=>"rejected"===e.status));n.info("Agents integrations",{documentId:t,documentIntegrations:{total:s.length,successful:o.length,failed:c.length},textDecorationIntegrations:{total:i.length,successful:a.length,failed:u.length},inlineCardIntegrations:{total:r.length,successful:l.length,failed:d.length}})}))}(F,t,e.telemetry,e.integrationsTelemetryInfoDebounceTimeMs)),u})).pipe((0,S.d)({bufferSize:1,refCount:!0}))}}}]);