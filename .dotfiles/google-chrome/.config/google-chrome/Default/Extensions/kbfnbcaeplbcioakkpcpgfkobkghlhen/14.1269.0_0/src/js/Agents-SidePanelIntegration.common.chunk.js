(self.webpackChunk=self.webpackChunk||[]).push([[5320],{2104:(e,t,s)=>{s.d(t,{N:()=>i});var n=s(8867);function i(e){return new n.y((t=>{const s=new DisposableStack,n=s.use(e());return s.adopt(n.subscribe((e=>t.next(e))),(e=>e.unsubscribe())),()=>s.dispose()}))}},12898:(e,t,s)=>{s.d(t,{TJ:()=>g.T,D8:()=>g.D,kX:()=>p,N4:()=>h.N});var n=s(64152),i=s(81484),r=Object.defineProperty,o=Object.defineProperties,a=Object.getOwnPropertyDescriptors,l=Object.getOwnPropertySymbols,c=Object.prototype.hasOwnProperty,u=Object.prototype.propertyIsEnumerable,d=(e,t,s)=>t in e?r(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;function p(e){return(0,n.t)(((e,t)=>o(e,a(t)))(((e,t)=>{for(var s in t||(t={}))c.call(t,s)&&d(e,s,t[s]);if(l)for(var s of l(t))u.call(t,s)&&d(e,s,t[s]);return e})({},e),{schema:e.protocol,factories:i.i}))}var g=s(88257),h=s(2104)},16125:(e,t,s)=>{s.r(t),s.d(t,{AgentsSidePanelIntegration:()=>ie});var n=s(92379),i=s(73642),r=s(90572),o=s(24666),a=s(20161),l=s(84714),c=(s(24231),s(11970),s(27841),s(66445),s(12898)),u=s(13391),d=s(15339),p=s(39963),g=s(78767),h=s(40594),m=s(94931),b=s(99161),_=s(5522),v=s(67546);const f={events:{documentSessionDisposed:(0,_.d)()},state:{activeTabId:(0,v.x)(),"activeDocument/:tabId":(0,v.x)(),"agentsFeatureFlags/:tabId":(0,v.x)(),lastActivePanelAgentId:(0,v.x)(),activePanelAgentId:(0,v.x)()}};var P=s(74822),w=s(21070),S=s(79256),y=s(18519),A=s(71051),C=s(63532),I=s(66878),x=s(36344),B=s(98746),D=s(8840);class k{constructor(e){this._init=e,this._disposables=new DisposableStack,this._logger=h.Y.create("AgentsReconnectingMessageBusRouterClient"),this._telemetry="cs"===this._init.script?(0,p.Tb)().agents.cs():(0,p.Tb)().agents.sidePanel,this._reconnectSubject=new P.x,this._volatileMessageBusServerPort=this._getNewPort(),this._messageBusServerPort=this._disposables.use(new B.S(this._volatileMessageBusServerPort)),this._messageBusContentScriptRouter=this._disposables.use(new D.C({tracingOptions:{enabled:!1,color:"green"},serverPort:this._messageBusServerPort,name:this._init.routerName})),this._isEarlyDisconnectHandlerEnabled=this._init.isEarlyDisconnectHandlerEnabled,this._disposables.defer((()=>this._volatileMessageBusServerPort[Symbol.dispose]()));let t=0;this._disposables.adopt(this._reconnectSubject.pipe((0,w.z)((()=>{var e,s;return(0,S.P)((()=>{this._logger.info("Reconnecting to message bus server... Attempt #"+ ++t);const e=this._volatileMessageBusServerPort;return this._volatileMessageBusServerPort=this._getNewPort(),this._messageBusServerPort.connectToServerPort(this._volatileMessageBusServerPort),e[Symbol.dispose](),this._messageBusContentScriptRouter.connect()})).pipe((0,y.V)(null!==(e=this._init.reconnectTimeoutMs)&&void 0!==e?e:1e3),(0,A.X)({count:null!==(s=this._init.reconnectMaxAttempts)&&void 0!==s?s:5}),(0,C.b)((()=>{this._logger.info("Reconnected to message bus server"),t=0})),(0,I.K)((e=>(this._telemetry.error("Failed to reconnect to message bus server",e),this._logger.error("Failed to reconnect to message bus server",e),x.E))))}))).subscribe(),(e=>e.unsubscribe()))}createPort(...e){return this._messageBusContentScriptRouter.createPort(...e)}[Symbol.dispose](){this._disposables.dispose()}_getNewPort(){return function(e,t,s,n){let i=!0;const r=new DisposableStack,o=e();r.defer((()=>{var e;return null===(e=o.removeMessageListeners)||void 0===e?void 0:e.call(o)}));const a=new P.x,l=()=>{var e;i||!n?(i=!1,r.disposed||(null===(e=o.removeMessageListeners)||void 0===e||e.call(o),t())):h.Y.create("createClientPort").debug("Disconnect already handled, skipping")};return o.onDisconnect((()=>{l()})),o.onMessage((e=>{r.disposed||a.next(e)})),{send:e=>{if(r.disposed||!i)return s.warn("Cannot send message to a disposed BG port"),void h.Y.create("createClientPort").warn("Cannot send message to a disposed BG port");try{o.postMessage(e)}catch(e){n&&l(),s.warn("Error sending message to BG port",e,{isEarlyDisconnectHandlerEnabled:n}),h.Y.create("createClientPort").error("Error sending message to BG port",e)}},subscribe:e=>{if(r.disposed||!i)return s.warn("Cannot subscribe to a disposed BG port"),h.Y.create("createClientPort").warn("Cannot subscribe to a disposed BG port"),new DisposableStack;const t=r.use(new DisposableStack);return t.adopt(a.subscribe(e),(e=>e.unsubscribe())),t},[Symbol.dispose]:()=>r.dispose()}}(this._init.createContentScriptPort,(()=>this._reconnectSubject.next()),this._telemetry,this._isEarlyDisconnectHandlerEnabled)}}function E(e){return`agents/${e}`}function O(e,...t){return M(e,...t)}function M(e,...t){return`agents/@impl/${e}${F(t)}`}function N(e,t,...s){return R(e,t,...s)}function R(e,t,...s){return`${E(e)}/${t}${F(s)}`}function $(e,...t){return`agents/${e}${F(t)}`}function F(e){const t=e.filter(Boolean).join("/");return t?`/${t}`:""}var T=s(24196);class j{constructor(e){this._disposables=new DisposableStack;const t=e.experimentClient.isGateEnabled(T.Nl.AgentsEarlyDisconnectHandler);this._messageBusRouter=this._disposables.use(new k({script:e.script,createContentScriptPort:()=>e.messageApi.createPortConnection(b.Tt.messageBusPort),routerName:$(e.script,e.tabId),isEarlyDisconnectHandlerEnabled:t})),this.platformBus=this._disposables.use((0,c.kX)({port:this._messageBusRouter.createPort({name:O(e.script,e.tabId)}),clientId:M(e.script,e.tabId),keyPrefix:"agents/@impl",protocol:f}))}createPort(...e){return this._messageBusRouter.createPort(...e)}[Symbol.dispose](){this._disposables.dispose()}}var G=s(46271),Y=s(15724),H=s(42849),q=s(307),X=s(97531);const z={[s(46924).f.id]:"ReaderReactions",[H.f.id]:"Humanizer",[q.f.id]:"Paraphraser",[Y.f.id]:"ExpertReview",[G.f.id]:"AIDetector",[X.f.id]:"Plagiarism"};var K=s(23162);class L{constructor(e){this._experimentClient=e}isAssigned(e,...t){if(e instanceof K.Cc)return this._experimentClient.isGateEnabled(e);const s=this._experimentClient.getTreatment(e);return null!==s&&s!==K.q4&&t.includes(s)}getTreatment(e){const t=this._experimentClient.getTreatment(e);return t===K.q4?null:t}peekExperiment(e,...t){const s=this._experimentClient.peekTreatment(e);return null!==s&&s!==K.q4&&t.includes(s)}}var V=s(12518),W=s(77632),J=s(25466);const Q=e=>{const t=new Set;return"edge"!==e.browser&&"msie"!==e.browser&&t.add(J.L.Flag.supportsSVGDominantBaseline),{has:e=>t.has(e)}};class U{constructor(){this.openUrl=e=>(0,V.Y3)((()=>{document.location.href=e.toString()}),V.KC),this.openPopup=e=>(0,V.Y3)((()=>{const t=self.open(e.toString(),"_blank","noopener,noreferrer");t&&(t.opener=null)}),V.KC)}}var Z=s(40795);function ee(e){return{[Symbol.asyncDispose]:async()=>{if(!e)return;const t=await e;t&&(!function(e){return Symbol.dispose in e}(t)?function(e){return Symbol.asyncDispose in e}(t)&&await t[Symbol.asyncDispose]():t[Symbol.dispose]())}}}var te=s(22572),se=s(42082);function ne(){const e=h.Y.create("useOpenChatWithMessage"),{commandExecutor:t}=(0,te.ar)();return s=>{t?(e.debug("Opening chat agent with message:",s),t.execute({kind:te.FP.MessageAgent,agentId:se._N,message:{kind:te.IQ.Command,command:{kind:te.pd.CreateChat,message:{content:s}}}}),t.execute({kind:te.FP.OpenAgent,agentId:se._N})):e.error("Command executor or send message not available")}}class ie{constructor(e){this._initOptions=e,this._disposables=new AsyncDisposableStack,this._logger=h.Y.create("Agents.SidePanelIntegration"),this._experimentationService=new L(this._initOptions.experimentClient),this._agentDefinitions=(0,Z.c)(this._initOptions.experimentClient),this._messageBusClient=this._disposables.use(new j({messageApi:(0,m.O)().browserApi.message,script:"side-panel",experimentClient:this._initOptions.experimentClient})),this._agentPlatformBus=this._messageBusClient.platformBus,this._activePanelAgentId=this._disposables.use(this._agentPlatformBus.state.lastActivePanelAgentId.create(null))}setActiveAgentId(e){this._activePanelAgentId.set(e)}loadAssistantAgents(){if(!(0,T.w4)(this._initOptions.experimentClient))return u.h.create([]);const e=this._runAssistantActivations(),t=u.h.create(new Map(e.map((e=>[e.agentId,null]))));for(const s of e){const{agentId:e,integrationResult:i}=s;i.then((s=>{s?t.modify((t=>{const i=n.memo((e=>s.renderIcon(e)));i.displayName=`Icon-${e}`;const r=n.memo((()=>{const e=ne();return s.renderPanel({onClosePanel:void 0,onChatAIMessage:e})}));return r.displayName=`Panel-${e}`,new Map(t).set(e,{id:e,title:s.title,renderPanel:()=>n.createElement(r),renderIcon:e=>n.createElement(i,e)})})):this._logger.debug(`Agent ${e} was not activated due to allowed features check`)})).catch((t=>{this._logger.error(`Failed to get assistant integration result for agent ${e}`,t),(0,p.Tb)().agents.sidePanel.error("Failed to get assistant integration result for agent",t,{agentId:e})}))}return t.view((e=>[...e.values()].filter(g.C_)))}async _getAllowedFeatures(){if(!this._initOptions.experimentClient.isGateEnabled(T.Nl.AgentsCAPIFiltering))return this._logger.debug("CAPI filtering gate is disabled, using all agents"),null;const e=this._initOptions.checkingServiceProvider.getCheckingService();if(!e)return this._logger.debug("No checking service available, skipping all agents"),[];try{const t=e=>"start"===e.action,s=(await(0,i.z)(e.capiMessages.pipe((0,r.h)(t)))).allowedFeatures||[];return this._logger.debug("Received allowed features from CAPI:",s),s}catch(e){return this._logger.error("Failed to get allowed features from CAPI:",e),[]}}_runAssistantActivations(){const e=d.W.detect(),t=function(e){return new W.f(Q(e),new U)}(e),s=this._disposables.use(function(e){const t=new DisposableStack,s=t.use(e.state.activeTabId.view(null)),n=u.h.create(null);return t.adopt(s.pipe((0,o.x)(),(0,a.w)((t=>null===t?(0,l.of)(null):(0,c.N4)((()=>e.state.activeDocument.view(t,null)))))).subscribe((e=>n.set(e))),(e=>e.unsubscribe())),{activeDocument:n,[Symbol.dispose]:()=>t.dispose()}}(this._agentPlatformBus)).activeDocument,n=this._disposables.use(this._agentPlatformBus.state.activeTabId.view(null)),i=u.h.create(null);this._disposables.adopt(n.pipe((0,o.x)(),(0,a.w)((e=>null===e?(0,l.of)(null):(0,c.N4)((()=>this._agentPlatformBus.state.agentsFeatureFlags.view(e,null)))))).subscribe((e=>i.set(e))),(e=>e.unsubscribe()));const r={user:this._initOptions.user.view((e=>({id:e.id,firstName:e.firstName,email:e.email,free:!e.premium,anonymous:e.anonymous})))},g=this._getAllowedFeatures();return this._agentDefinitions.map((n=>{const o=g.then((async o=>{var a,l;if(null!==o){const e=Z.v[n.id];if(e&&!o.includes(e))return this._logger.debug(`Agent ${n.id} requires feature ${e} which is not in allowed features, skipping activation`),null}this._logger.debug(`Running assistant activation for ${n.id}`);const d=new AsyncDisposableStack;this._disposables.defer((()=>d.disposeAsync()));const g=d.use(this._messageBusClient.createPort({name:N(n.id,"assistant")})),h=u.h.combine(s,i,((e,t)=>{var s;if(!e)return null;const i=z[n.id],r=!!t&&(null!==(s=t[i])&&void 0!==s&&s);return{...e,supportsAgents:e.supportsAgents&&r}})),m={activeDocument:h,documentSessionDisposed:this._agentPlatformBus.events.documentSessionDisposed.view()};try{const s=null===(l=(a=n.integrations).assistantActivate)||void 0===l?void 0:l.call(a,{bus:d.use((0,c.kX)({port:g,clientId:R(n.id,"assistant"),keyPrefix:E(n.id),protocol:n.protocol})),documents:m,navigation:{isPanelOpen:this._activePanelAgentId.view((e=>e===n.id))},experimentation:this._experimentationService,platformInfo:e,environment:t,userService:r});return s?(d.use(ee(s.catch((()=>null)))),s):(d.disposeAsync(),null)}catch(e){return d.disposeAsync(),this._logger.error(`Assistant activation error for agent ${n.id}`,e),(0,p.Tb)().agents.sidePanel.error("Assistant activation failed for agent",e,{agentId:n.id}),null}}));return{agentId:n.id,integrationResult:o}}))}dispose(){this._disposables.disposeAsync()}}}}]);